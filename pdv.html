<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDV - Sâmia Pizzaria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="https://raw.githubusercontent.com/WillianSoares93/cardapio_samia_PDV/refs/heads/main/logo.png" type="image/png">
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        body {
            font-family: 'Roboto', sans-serif;
            visibility: hidden;
            overflow: hidden; /* Evita o scroll da página inteira */
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
        }
        #pdv-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 999;
            display: none;
        }
        .details-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height: 0.4s ease-in-out;
        }
        .order-card.expanded .details-container {
            max-height: 1500px;
        }
        .main-tab-btn {
            transition: all 0.2s ease-in-out;
        }
        .main-tab-btn.active {
            border-bottom-color: #ef4444; /* red-500 */
            color: #ef4444;
            background-color: #fef2f2; /* red-50 */
        }
        .mesa-item {
            transition: all 0.2s ease-in-out;
            aspect-ratio: 1 / 1;
            position: relative;
        }
        .mesa-item:hover:not(.joining-mode) {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .mesa-status-livre { background-color: #dcfce7; border-color: #22c55e; color: #166534; }
        .mesa-status-ocupada { background-color: #fef3c7; border-color: #f59e0b; color: #b45309; } /* Amarelo: Em Preparo/Novo */
        .mesa-status-pronto { background-color: #dbeafe; border-color: #3b82f6; color: #1e40af; } /* Azul Claro: Pronto p/ Servir */
        .mesa-status-servido { background-color: #fee2e2; border-color: #ef4444; color: #991b1b; } /* Vermelho Claro: Servido (Aguardando Fechamento) */
        .mesa-status-juntada { background-color: #e0e7ff; border-color: #4f46e5; color: #3730a3; }
        .mesa-item.selected-for-join {
            outline: 4px solid #3b82f6;
            outline-offset: 2px;
            transform: scale(1.05);
        }
        .joining-mode .mesa-item.mesa-status-livre { cursor: pointer; }
        .joining-mode .mesa-item:not(.mesa-status-livre) { cursor: not-allowed; opacity: 0.5; }

        /* Estilos para Drag and Drop */
        .order-card.dragging {
            opacity: 0.5;
            transform: scale(1.05);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .pdv-column-container.drag-over {
            background-color: rgba(0, 0, 0, 0.05);
            border: 2px dashed #9ca3af;
        }

        /* Animação para o sino de notificação */
        @keyframes ring-bell {
            0%, 100% { transform: rotate(0); }
            10%, 30%, 50%, 70%, 90% { transform: rotate(-15deg); }
            20%, 40%, 60%, 80% { transform: rotate(15deg); }
        }
        .notification-bell-ringing {
            animation: ring-bell 1.5s ease-in-out infinite;
        }
        /* Estilo para o ícone "Novo" */
        .new-order-tag {
            position: absolute;
            top: 8px;
            right: 8px;
            background-color: #ef4444; /* red-500 */
            color: white;
            font-size: 0.75rem; /* 12px */
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 9999px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 10;
        }
        /* Estilos do Cronômetro */
        .timer-container {
            font-size: 0.75rem;
            font-weight: 500;
            padding: 4px 8px;
            border-radius: 6px;
        }
        .timer-green { background-color: #dcfce7; color: #166534; } /* green-100 / green-800 */
        .timer-yellow { background-color: #fef9c3; color: #854d0e; } /* yellow-100 / yellow-800 */
        .timer-red { background-color: #fee2e2; color: #991b1b; } /* red-100 / red-900 */

        /* --- ESTILOS PARA BARRA LATERAL AJUSTADOS --- */
        .main-container {
            display: grid;
            grid-template-columns: 0px 1fr; /* Barra lateral escondida por padrão */
            height: 100vh; /* Ocupa a altura total da tela */
            transition: grid-template-columns 0.3s ease-in-out;
        }
        .main-container.sidebar-open {
            grid-template-columns: 80px 1fr; /* Mostra a barra lateral */
        }
        .sidebar-nav {
            background-color: #2C3E50;
            overflow: hidden;
        }
        .sidebar-btn {
            color: #BDC3C7;
            transition: all 0.2s ease-in-out;
        }
        .sidebar-btn:hover {
            background-color: #34495E;
            color: white;
        }
        .sidebar-btn.active {
            background-color: #3b82f6;
            color: white;
        }
        .mesa-order-details {
            max-height: 400px;
            overflow-y: auto;
        }
        .mesa-timer-container {
            position: absolute;
            bottom: 4px;
            left: 4px;
            right: 4px;
            font-size: 0.7rem;
        }
        .mesa-timer-container .timer-container {
            padding: 2px 4px;
        }
        #qrcode-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="pdv-overlay"></div>

    <div class="main-container">
        <!-- Sidebar Vertical Esquerda -->
        <aside class="sidebar-nav flex flex-col justify-between py-4">
            <!-- Main Navigation -->
            <div>
                <a href="pdv.html" class="sidebar-btn active w-full flex flex-col items-center p-3 text-xs" title="Painel de Pedidos">
                    <i class="fas fa-receipt fa-2x"></i>
                    <span>PEDIDOS</span>
                </a>
                <a href="venda-balcao.html" class="sidebar-btn w-full flex flex-col items-center p-3 text-xs" title="Venda Balcão">
                    <i class="fas fa-cash-register fa-2x"></i>
                    <span>BALCÃO</span>
                </a>
                <a href="editar-cardapio.html" class="sidebar-btn w-full flex flex-col items-center p-3 text-xs" title="Editar Cardápio">
                    <i class="fas fa-edit fa-2x"></i>
                    <span>EDITAR</span>
                </a>
                <a href="gerenciar.html" class="sidebar-btn w-full flex flex-col items-center p-3 text-xs" title="Gerenciar Itens">
                    <i class="fas fa-tasks fa-2x"></i>
                    <span>GERENCIAR</span>
                </a>
                <a href="relatorio.html" class="sidebar-btn w-full flex flex-col items-center p-3 text-xs" title="Relatórios">
                    <i class="fas fa-chart-line fa-2x"></i>
                    <span>RELATÓRIOS</span>
                </a>
            </div>
            <!-- Bottom Actions -->
            <div class="space-y-2">
                <button id="close-cash-register-btn" class="sidebar-btn w-full flex flex-col items-center p-3 text-xs" title="Ver Caixa">
                    <i class="fas fa-cash-register fa-2x text-green-400"></i>
                    <span class="text-green-400">CAIXA</span>
                </button>
                <button id="logout-btn" class="sidebar-btn w-full flex flex-col items-center p-3 text-xs" title="Sair">
                    <i class="fas fa-sign-out-alt fa-2x text-red-400"></i>
                    <span class="text-red-400">SAIR</span>
                </button>
            </div>
        </aside>

        <main id="main-content" class="overflow-y-auto">
             <header class="bg-white shadow-md sticky top-0 z-20">
                <div class="max-w-full mx-auto py-2 px-4 sm:px-6 lg:px-8 flex justify-start items-center">
                    <h1 class="text-xl font-bold text-gray-800">Painel de Pedido</h1>
                </div>
            </header>
            <div class="py-6 sm:px-6 lg:px-8">

                <div class="bg-gray-800 text-white rounded-lg shadow-md mb-6">
                    <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center py-4">
                            <div><h3 class="text-sm font-medium text-gray-400">PEDIDOS HOJE</h3><p id="stats-total-orders" class="text-2xl font-bold">0</p></div>
                            <div><h3 class="text-sm font-medium text-gray-400">FATURAMENTO TOTAL</h3><p id="stats-total-revenue" class="text-2xl font-bold">R$ 0,00</p></div>
                            <div><h3 class="text-sm font-medium text-gray-400">TICKET MÉDIO</h3><p id="stats-avg-ticket" class="text-2xl font-bold">R$ 0,00</p></div>
                        </div>
                    </div>
                </div>


                <!-- Abas Principais -->
                <div class="border-b border-gray-200 bg-white rounded-t-lg shadow-sm">
                    <nav id="main-tabs" class="flex -mb-px" aria-label="Tabs">
                        <button class="main-tab-btn active w-1/3 py-4 px-1 text-center border-b-4 font-medium text-lg relative" data-tab="delivery">
                            <div class="flex justify-center items-center">
                                <i class="fas fa-motorcycle mr-2"></i>
                                <span>Delivery</span>
                                <div id="delivery-notification" class="ml-2 flex items-center space-x-1 hidden">
                                    <i class="fas fa-bell text-yellow-500"></i>
                                    <span class="bg-red-600 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">0</span>
                                </div>
                            </div>
                        </button>
                        <button class="main-tab-btn w-1/3 py-4 px-1 text-center border-b-4 border-transparent text-gray-500 hover:text-gray-700 font-medium text-lg relative" data-tab="retirada">
                            <div class="flex justify-center items-center">
                                <i class="fas fa-shopping-bag mr-2"></i>
                                <span>Retirada</span>
                                <div id="retirada-notification" class="ml-2 flex items-center space-x-1 hidden">
                                    <i class="fas fa-bell text-yellow-500"></i>
                                    <span class="bg-red-600 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">0</span>
                                </div>
                            </div>
                        </button>
                        <button class="main-tab-btn w-1/3 py-4 px-1 text-center border-b-4 border-transparent text-gray-500 hover:text-gray-700 font-medium text-lg" data-tab="mesas">
                            <i class="fas fa-utensils mr-2"></i> Mesas
                        </button>
                    </nav>
                </div>

                <!-- Conteúdo das Abas -->
                <div id="tab-content-delivery" class="tab-content">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mt-4">
                        <div id="col-delivery-novo" data-status="Novo" class="bg-red-50 rounded-lg shadow"><div class="p-4 border-b border-red-200"><h2 class="text-lg font-bold text-red-800">Novos Pedidos</h2></div><div class="pdv-column p-4 space-y-4"></div></div>
                        <div id="col-delivery-preparo" data-status="Em Preparo" class="bg-yellow-50 rounded-lg shadow"><div class="p-4 border-b border-yellow-200"><h2 class="text-lg font-bold text-yellow-800">Em Preparo</h2></div><div class="pdv-column p-4 space-y-4"></div></div>
                        <div id="col-delivery-pronto" data-status="Pronto para Entrega" class="bg-green-50 rounded-lg shadow"><div class="p-4 border-b border-green-200"><h2 class="text-lg font-bold text-green-800">Pronto para Entrega</h2></div><div class="pdv-column p-4 space-y-4"></div></div>
                        <div id="col-delivery-entrega" data-status="Saiu para Entrega" class="bg-blue-50 rounded-lg shadow"><div class="p-4 border-b border-blue-200"><h2 class="text-lg font-bold text-blue-800">Saiu para Entrega</h2></div><div class="pdv-column p-4 space-y-4"></div></div>
                        <div id="col-delivery-entregue" data-status="Entregue" class="bg-gray-100 rounded-lg shadow"><div class="p-4 border-b border-gray-300"><h2 class="text-lg font-bold text-gray-800">Entregue</h2></div><div class="pdv-column p-4 space-y-4"></div></div>
                    </div>
                </div>

                <div id="tab-content-retirada" class="tab-content hidden">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mt-4">
                        <div id="col-retirada-novo" data-status="Novo" class="bg-red-50 rounded-lg shadow"><div class="p-4 border-b border-red-200"><h2 class="text-lg font-bold text-red-800">Novos Pedidos</h2></div><div class="pdv-column p-4 space-y-4"></div></div>
                        <div id="col-retirada-preparo" data-status="Em Preparo" class="bg-yellow-50 rounded-lg shadow"><div class="p-4 border-b border-yellow-200"><h2 class="text-lg font-bold text-yellow-800">Em Preparo</h2></div><div class="pdv-column p-4 space-y-4"></div></div>
                        <div id="col-retirada-pronto" data-status="Pronto para Retirada" class="bg-green-50 rounded-lg shadow"><div class="p-4 border-b border-green-200"><h2 class="text-lg font-bold text-green-800">Pronto para Retirada</h2></div><div class="pdv-column p-4 space-y-4"></div></div>
                        <div id="col-retirada-entregue" data-status="Entregue" class="bg-gray-100 rounded-lg shadow"><div class="p-4 border-b border-gray-300"><h2 class="text-lg font-bold text-gray-800">Entregue</h2></div><div class="pdv-column p-4 space-y-4"></div></div>
                    </div>
                </div>

                <div id="tab-content-mesas" class="tab-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 mt-4">
                        <div class="lg:col-span-4">
                            <div id="mesas-controls" class="p-2 bg-white rounded-lg shadow-sm flex items-center justify-end space-x-2">
                                <button id="add-table-btn" class="px-4 py-2 bg-green-500 text-white text-sm font-bold rounded-md hover:bg-green-600">
                                    <i class="fas fa-plus mr-2"></i>Adicionar Mesa
                                </button>
                                <button id="remove-table-btn" class="px-4 py-2 bg-red-500 text-white text-sm font-bold rounded-md hover:bg-red-600">
                                    <i class="fas fa-trash-alt mr-2"></i>Excluir Última Mesa
                                </button>
                                <button id="join-tables-btn" class="px-4 py-2 bg-indigo-600 text-white text-sm font-bold rounded-md hover:bg-indigo-700">
                                    <i class="fas fa-link mr-2"></i>Agrupar Mesas
                                </button>
                                <div id="joining-controls" class="hidden space-x-2">
                                    <button id="confirm-join-btn" class="px-4 py-2 bg-green-600 text-white text-sm font-bold rounded-md hover:bg-green-700">Confirmar Agrupamento</button>
                                    <button id="cancel-join-btn" class="px-4 py-2 bg-gray-500 text-white text-sm font-bold rounded-md hover:bg-gray-600">Cancelar</button>
                                </div>
                            </div>
                            <div id="mesas-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6 mt-4">
                                <!-- As mesas serão inseridas aqui pelo JavaScript -->
                            </div>
                        </div>
                        <div class="lg:col-span-1">
                            <!-- COLUNAS DE STATUS DE PEDIDO DE MESA -->
                            <div class="grid grid-cols-1 gap-6">
                                <div id="col-mesas-fechado" data-status="Fechado" class="bg-gray-100 rounded-lg shadow"><div class="p-4 border-b border-gray-300"><h2 class="text-lg font-bold text-gray-800">Contas Fechadas</h2></div><div class="pdv-column p-4 space-y-4"></div></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="open-cash-modal" class="modal">
        <div class="modal-content">
            <div id="pending-cash-alert" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4" role="alert">
                <p class="font-bold">Caixa Pendente</p>
                <p id="pending-cash-message">Existe um caixa do dia anterior que não foi fechado. Por favor, feche o caixa anterior antes de continuar.</p>
            </div>
            <h3 id="open-cash-title" class="text-lg font-bold text-gray-900 mb-4">Abrir Caixa</h3>
            <p id="open-cash-instructions" class="text-sm text-gray-600 mb-4">Para iniciar as operações, por favor, informe o valor inicial do caixa (fundo de troco).</p>
            <form id="open-cash-form">
                <div class="mb-4">
                    <label for="initial-value" class="block text-sm font-medium text-gray-700 mb-1">Valor Inicial (R$)</label>
                    <input type="number" id="initial-value" step="0.01" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="Ex: 50,00">
                </div>
                <button type="submit" id="open-cash-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700">Abrir Caixa</button>
            </form>
            <div id="resolve-pending-cash-container" class="hidden mt-4">
                <button type="button" id="resolve-pending-cash-btn" class="w-full bg-yellow-500 text-white font-bold py-2 px-4 rounded-md hover:bg-yellow-600">
                    Resolver Pendência (Fechar Caixa Anterior)
                </button>
            </div>
        </div>
    </div>

    <div id="close-cash-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-900">Fechamento de Caixa</h3>
                <button id="print-cash-closure-btn" class="text-gray-600 hover:text-gray-800">
                    <i class="fas fa-print text-xl"></i>
                </button>
            </div>
            <div class="space-y-2 text-sm">
                <div class="flex justify-between"><span class="text-gray-600">Valor Inicial:</span> <span id="summary-initial" class="font-medium">R$ 0,00</span></div>
                <hr class="my-2">
                <h4 class="font-bold text-gray-700 text-md">Vendas por Tipo</h4>
                <div class="flex justify-between pl-2"><span class="text-gray-600">Delivery:</span> <span id="summary-delivery" class="font-medium">R$ 0,00</span></div>
                <div class="flex justify-between pl-2"><span class="text-gray-600">Retirada:</span> <span id="summary-retirada" class="font-medium">R$ 0,00</span></div>
                <div class="flex justify-between pl-2"><span class="text-gray-600">Mesas:</span> <span id="summary-mesas" class="font-medium">R$ 0,00</span></div>
                <div class="flex justify-between pl-2"><span class="text-gray-600">Taxas de Entrega:</span> <span id="summary-delivery-fees" class="font-medium">R$ 0,00</span></div>
                <hr class="my-2">
                <h4 class="font-bold text-gray-700 text-md">Vendas por Pagamento</h4>
                <div class="flex justify-between pl-2"><span class="text-gray-600">Dinheiro:</span> <span id="summary-cash" class="font-medium">R$ 0,00</span></div>
                <div class="flex justify-between pl-2"><span class="text-gray-600">Cartão:</span> <span id="summary-card" class="font-medium">R$ 0,00</span></div>
                <div class="flex justify-between pl-2"><span class="text-gray-600">Pix:</span> <span id="summary-pix" class="font-medium">R$ 0,00</span></div>
                <hr class="my-2">
                <div class="flex justify-between font-bold"><span class="text-gray-800">Total de Vendas:</span> <span id="summary-total-sales" class="text-gray-800">R$ 0,00</span></div>
                <div class="flex justify-between text-red-600"><span class="font-medium">Total Sangrias:</span> <span id="summary-sangrias" class="font-medium">- R$ 0,00</span></div>
                <hr class="my-2">
                <!-- ALTERAÇÃO FEITA AQUI -->
                <div class="flex justify-between font-bold"><span class="text-blue-700">Valor Esperado em Caixa:</span> <span id="summary-expected" class="text-blue-700">R$ 0,00</span></div>
            </div>
            <form id="close-cash-form" class="mt-6">
                <div class="mb-4">
                    <label for="final-value" class="block text-sm font-medium text-gray-700 mb-1">Valor Contado em Caixa (R$)</label>
                    <input type="number" id="final-value" step="0.01" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="Digite o valor contado">
                </div>
                <div id="summary-difference-section" class="text-center p-2 rounded-md mb-4 hidden">
                    <span id="summary-difference" class="font-bold"></span>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="register-sangria-btn" class="px-4 py-2 bg-orange-500 text-white font-bold rounded-md hover:bg-orange-600">Registrar Sangria</button>
                    <button type="button" id="cancel-close-cash-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancelar</button>
                    <button type="submit" id="confirm-close-cash-btn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Confirmar Fechamento</button>
                </div>
            </form>
        </div>
    </div>

    <div id="manage-table-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center pb-3 border-b">
                <h2 id="manage-table-title" class="text-xl font-bold">Gerenciar Mesa</h2>
                <button id="close-manage-table-modal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="manage-table-body" class="space-y-4">
                <!-- CONTEÚDO SERÁ INJETADO AQUI PELO JS -->
            </div>
        </div>
    </div>

    <div id="transfer-table-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-4">Transferir para qual mesa livre?</h3>
            <select id="free-tables-select" class="w-full p-2 border rounded-md"></select>
            <div class="flex justify-end gap-4 mt-4">
                <button id="cancel-transfer-btn" class="px-4 py-2 bg-gray-300 rounded-md">Cancelar</button>
                <button id="confirm-transfer-btn" class="px-4 py-2 bg-blue-500 text-white rounded-md">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="delete-confirm-modal" class="modal">
        <div class="modal-content bg-white p-6 rounded-lg shadow-lg max-w-sm mx-auto">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Confirmar Exclusão</h3>
            <p class="text-sm text-gray-600 mb-6">Tem certeza que deseja excluir este pedido? Esta ação não pode ser desfeita.</p>
            <div class="flex justify-end space-x-4">
                <button id="cancel-delete-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancelar</button>
                <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Sim, Excluir</button>
            </div>
        </div>
    </div>

    <div id="sangria-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Registrar Sangria de Caixa</h3>
            <form id="sangria-form">
                <div class="mb-4">
                    <label for="sangria-amount" class="block text-sm font-medium text-gray-700 mb-1">Valor da Retirada (R$)</label>
                    <input type="number" id="sangria-amount" step="0.01" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="Ex: 20,00">
                </div>
                <div class="mb-4">
                    <label for="sangria-reason" class="block text-sm font-medium text-gray-700 mb-1">Motivo</label>
                    <input type="text" id="sangria-reason" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="Ex: Pagamento de fornecedor">
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancel-sangria-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancelar</button>
                    <button type="submit" id="confirm-sangria-btn" class="px-4 py-2 bg-orange-500 text-white rounded-md hover:bg-orange-600">Confirmar Sangria</button>
                </div>
            </form>
        </div>
    </div>

    <div id="table-payment-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Definir Pagamento Final</h3>
            <p class="text-gray-600 mb-2">Total do Pedido: <span id="table-payment-total" class="font-bold">R$ 0,00</span></p>
            <div id="table-payment-options" class="space-y-3">
                 <label class="flex items-center"><input type="radio" name="table-payment" value="Dinheiro" class="form-radio h-4 w-4 text-red-600"> <span class="ml-2">Dinheiro</span></label>
                 <label class="flex items-center"><input type="radio" name="table-payment" value="Cartão de Crédito/Débito" class="form-radio h-4 w-4 text-red-600"> <span class="ml-2">Cartão</span></label>
                 <label class="flex items-center"><input type="radio" name="table-payment" value="Pix" class="form-radio h-4 w-4 text-red-600"> <span class="ml-2">Pix</span></label>
            </div>
             <div id="table-troco-container" class="hidden mt-4 p-3 border border-gray-200 rounded-md bg-gray-50">
                <label for="table-trocoPara" class="block text-sm font-medium text-gray-700">Troco para (R$):</label>
                <input type="number" id="table-trocoPara" step="0.01" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                <p class="text-sm mt-1">Troco a devolver: <span id="table-troco-total" class="font-bold">R$ 0,00</span></p>
            </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button type="button" id="cancel-table-payment-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancelar</button>
                <button type="button" id="confirm-table-payment-btn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Confirmar e Fechar</button>
            </div>
        </div>
    </div>

    <div id="custom-alert-modal" class="modal">
      <div class="modal-content bg-white p-6 rounded-lg shadow-lg max-w-sm mx-auto">
        <h3 class="text-lg font-bold text-gray-900 mb-4">Atenção</h3>
        <p id="custom-alert-message" class="text-sm text-gray-600 mb-6">Message goes here.</p>
        <div class="flex justify-end">
            <button id="ok-alert-modal" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-600">OK</button>
        </div>
      </div>
    </div>

    <!-- NOVO: Modal de confirmação do WhatsApp -->
    <div id="whatsapp-confirm-modal" class="modal">
        <div class="modal-content text-center">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-900">Confirmar Pedido via WhatsApp</h3>
                <button id="close-whatsapp-modal-btn" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <p class="text-sm text-gray-600 mb-4">Use o QR Code abaixo com a câmera do seu celular ou clique no link para enviar a mensagem de confirmação para o cliente.</p>
            <div id="qrcode-container"></div>
            <a id="whatsapp-confirm-link" href="#" target="_blank" class="block w-full text-center py-3 bg-green-500 text-white font-bold rounded-md hover:bg-green-600 transition-colors">
                <i class="fab fa-whatsapp mr-2"></i>Abrir no WhatsApp
            </a>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, doc, onSnapshot, getDoc, updateDoc, query, orderBy, where, writeBatch, getDocs, limit, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

// Suas credenciais do Firebase
const firebaseConfig = {
  apiKey: "AIzaSyB9LJ-7bOvHGYyFE_H2Qd7XFcyjmSPq_ro",
  authDomain: "samia-cardapio.firebaseapp.com",
  projectId: "samia-cardapio",
  storageBucket: "samia-cardapio.firebasestorage.app",
  messagingSenderId: "223260436641",
  appId: "1:223260436641:web:adf78e77a0267f66f1e8e0"
};

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- LÓGICA DE AUTENTICAÇÃO E CAIXA ---
        let currentCashRegister = null;
        let detailedReportData = {};
        let timerIntervalId = null;
        let numeroDeMesas = 12; // Valor padrão
        let allOrdersCache = []; // Cache para os pedidos

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.body.style.visibility = 'visible';
                checkCashRegisterStatus();
            } else {
                window.location.href = `login.html?redirect=pdv.html`;
            }
        });

        const logoutBtn = document.getElementById('logout-btn');
        logoutBtn.addEventListener('click', () => signOut(auth));

        const openCashModal = document.getElementById('open-cash-modal');
        const openCashForm = document.getElementById('open-cash-form');
        const pdvOverlay = document.getElementById('pdv-overlay');
        const resolvePendingContainer = document.getElementById('resolve-pending-cash-container');
        const resolvePendingBtn = document.getElementById('resolve-pending-cash-btn');

        async function checkCashRegisterStatus() {
            const q = query(collection(db, "caixas"), where("status", "==", "aberto"), limit(1));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                document.getElementById('pending-cash-alert').classList.add('hidden');
                document.getElementById('open-cash-title').textContent = 'Abrir Caixa';
                openCashForm.style.display = 'block';
                resolvePendingContainer.classList.add('hidden');
                document.getElementById('open-cash-instructions').style.display = 'block';

                pdvOverlay.style.display = 'block';
                openCashModal.style.display = 'flex';
            } else {
                const cashDoc = querySnapshot.docs[0];
                currentCashRegister = { id: cashDoc.id, ...cashDoc.data() };

                const openDate = currentCashRegister.dataAbertura.toDate();
                const now = new Date();

                // --- NOVA LÓGICA DE DIA OPERACIONAL ---
                // Define o horário de "virada" do dia operacional (ex: 5 da manhã).
                const OPERATIONAL_CUTOFF_HOUR = 5;

                // Calcula o início do dia operacional atual.
                const operationalDayStart = new Date(now);
                operationalDayStart.setHours(OPERATIONAL_CUTOFF_HOUR, 0, 0, 0);

                // Se a hora atual for antes da "virada" (ex: 2h da manhã de quinta),
                // o dia operacional ainda é considerado o de quarta (que começou às 5h de quarta).
                if (now < operationalDayStart) {
                    operationalDayStart.setDate(operationalDayStart.getDate() - 1);
                }

                // O caixa é considerado pendente se foi aberto ANTES do início do dia operacional atual.
                const isFromPreviousOperationalDay = openDate < operationalDayStart;

                if (isFromPreviousOperationalDay) {
                    const formattedDate = openDate.toLocaleDateString('pt-BR');
                    document.getElementById('pending-cash-message').textContent = `Existe um caixa do dia ${formattedDate} que não foi fechado. Por favor, feche o caixa para poder continuar.`;
                    document.getElementById('pending-cash-alert').classList.remove('hidden');
                    document.getElementById('open-cash-title').textContent = 'Resolver Caixa Pendente';

                    openCashForm.style.display = 'none';
                    resolvePendingContainer.classList.remove('hidden');
                    document.getElementById('open-cash-instructions').style.display = 'none';

                    pdvOverlay.style.display = 'block';
                    openCashModal.style.display = 'flex';
                } else {
                    pdvOverlay.style.display = 'none';
                    openCashModal.style.display = 'none';
                    initializePDV();
                }
            }
        }
        openCashForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const initialValue = parseFloat(document.getElementById('initial-value').value);
            if (isNaN(initialValue) || initialValue < 0) {
                alert("Por favor, insira um valor inicial válido.");
                return;
            }

            try {
                await addDoc(collection(db, "caixas"), {
                    dataAbertura: serverTimestamp(),
                    usuarioAbertura: auth.currentUser.email,
                    valorInicial: initialValue,
                    status: 'aberto'
                });
                checkCashRegisterStatus();
            } catch (error) {
                console.error("Erro ao abrir o caixa:", error);
                alert("Não foi possível abrir o caixa. Tente novamente.");
            }
        });

        const mainContent = document.getElementById('main-content');
        const mainTabs = document.getElementById('main-tabs');
        const tabContents = document.querySelectorAll('.tab-content');
        const mesasGrid = document.getElementById('mesas-grid');

        const colDeliveryNovo = document.getElementById('col-delivery-novo').querySelector('.pdv-column');
        const colDeliveryPreparo = document.getElementById('col-delivery-preparo').querySelector('.pdv-column');
        const colDeliveryPronto = document.getElementById('col-delivery-pronto').querySelector('.pdv-column');
        const colDeliveryEntrega = document.getElementById('col-delivery-entrega').querySelector('.pdv-column');
        const colDeliveryEntregue = document.getElementById('col-delivery-entregue').querySelector('.pdv-column');

        const colRetiradaNovo = document.getElementById('col-retirada-novo').querySelector('.pdv-column');
        const colRetiradaPreparo = document.getElementById('col-retirada-preparo').querySelector('.pdv-column');
        const colRetiradaPronto = document.getElementById('col-retirada-pronto').querySelector('.pdv-column');
        const colRetiradaEntregue = document.getElementById('col-retirada-entregue').querySelector('.pdv-column');

        const colMesasFechado = document.getElementById('col-mesas-fechado').querySelector('.pdv-column');

        const connectionStatus = document.getElementById('connection-status');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const closeCashRegisterBtn = document.getElementById('close-cash-register-btn');
        const closeCashModal = document.getElementById('close-cash-modal');
        const closeCashForm = document.getElementById('close-cash-form');
        const cancelCloseCashBtn = document.getElementById('cancel-close-cash-btn');
        const finalValueInput = document.getElementById('final-value');

        let orderIdToDelete = null;
        let deliveryFeesData = [];
        let draggedItemId = null;
        let orderIdForPaymentUpdate = null;

        const joinTablesBtn = document.getElementById('join-tables-btn');
        const joiningControls = document.getElementById('joining-controls');
        const confirmJoinBtn = document.getElementById('confirm-join-btn');
        const cancelJoinBtn = document.getElementById('cancel-join-btn');
        let isJoiningTables = false;
        let selectedTablesForJoining = [];

        const manageTableModal = document.getElementById('manage-table-modal');
        const closeManageTableModalBtn = document.getElementById('close-manage-table-modal');
        const transferTableModal = document.getElementById('transfer-table-modal');
        let currentManagingOrderId = null;
        let currentManagingOrderData = null;

        mainTabs.addEventListener('click', (e) => {
            const tabButton = e.target.closest('.main-tab-btn');
            if (!tabButton) return;

            mainTabs.querySelector('.active').classList.remove('active');
            tabButton.classList.add('active');

            tabContents.forEach(content => content.classList.add('hidden'));
            const tabName = tabButton.dataset.tab;
            document.getElementById(`tab-content-${tabName}`).classList.remove('hidden');

            const notificationDiv = document.getElementById(`${tabName}-notification`);
            if (notificationDiv) {
                const bell = notificationDiv.querySelector('.fa-bell');
                if (bell) {
                    bell.classList.remove('notification-bell-ringing');
                }
            }
        });

        function initializeMesas() {
            mesasGrid.innerHTML = '';
            for (let i = 1; i <= numeroDeMesas; i++) {
                const mesaEl = document.createElement('div');
                mesaEl.id = `mesa-${i}`;
                mesaEl.className = 'mesa-item flex flex-col justify-center items-center p-4 border-2 rounded-lg cursor-pointer mesa-status-livre';
                mesaEl.dataset.status = 'livre';
                mesaEl.dataset.number = i;
                mesaEl.style.gridColumn = '';
                mesaEl.innerHTML = `
                    <div class="text-center">
                        <span class="text-3xl font-bold">${i.toString().padStart(2, '0')}</span>
                        <span class="text-sm font-medium mt-2 block status-text">Livre</span>
                    </div>
                    <div class="mesa-timer-container hidden flex flex-col space-y-1">
                        <div class="timer-container timer-green w-full text-center">
                            <i class="far fa-clock"></i> T: <span class="total-timer-value" data-created-at="0">00:00</span>
                        </div>
                        <div class="timer-container timer-green w-full text-center">
                            <i class="fas fa-hourglass-start"></i> E: <span class="status-timer-value" data-status-changed-at="0">00:00</span>
                        </div>
                    </div>
                `;
                mesaEl.addEventListener('click', () => handleMesaClick(i));
                mesasGrid.appendChild(mesaEl);
            }
        }

        async function openManageTableModal(orderId) {
            currentManagingOrderId = orderId;
            const modal = document.getElementById('manage-table-modal');
            const modalBody = document.getElementById('manage-table-body');
            const modalTitle = document.getElementById('manage-table-title');

            try {
                const orderRef = doc(db, "pedidos", orderId);
                const docSnap = await getDoc(orderRef);

                if (!docSnap.exists()) {
                    showCustomAlert("Erro: Pedido não encontrado.");
                    return;
                }

                const order = docSnap.data();
                currentManagingOrderData = order;

                const mesaNumbers = order.grupoMesas && order.grupoMesas.length > 0
                    ? order.grupoMesas.join(' + ')
                    : (order.endereco?.clientName || "").replace(/[^0-9]/g, ''); // Adicionado "?" para segurança

                modalTitle.textContent = `Gerenciar Mesa(s) ${mesaNumbers}`;

                const hasGroup = order.grupoMesas && order.grupoMesas.length > 1;

                modalBody.innerHTML = `
                    ${createDetailedOrderCardHtml(order, orderId)}
                    <div class="mt-4 pt-4 border-t grid ${hasGroup ? 'grid-cols-3' : 'grid-cols-2'} gap-4">
                        ${hasGroup ? '<button id="ungroup-tables-btn" class="w-full px-4 py-2 bg-yellow-500 text-white font-bold rounded-md hover:bg-yellow-600">Desagrupar</button>' : ''}
                        <button id="transfer-table-btn" class="w-full px-4 py-2 bg-purple-600 text-white font-bold rounded-md hover:bg-purple-700">Transferir Mesa</button>
                        <button id="close-account-btn" class="w-full px-4 py-2 bg-gray-700 text-white font-bold rounded-md hover:bg-gray-800">Fechar Conta</button>
                    </div>
                `;

                attachModalActionListeners(orderId, order);

                modal.style.display = 'flex';

            } catch (error) {
                console.error("Erro ao abrir modal da mesa:", error);
                showCustomAlert("Não foi possível carregar os detalhes do pedido.");
            }
        }

        function handleMesaClick(numeroMesa) {
            const mesaEl = document.getElementById(`mesa-${numeroMesa}`);
            if (!mesaEl) return;
            const status = mesaEl.dataset.status;

            if (isJoiningTables) {
                if (status === 'livre') {
                    const index = selectedTablesForJoining.indexOf(numeroMesa);
                    if (index > -1) {
                        selectedTablesForJoining.splice(index, 1);
                        mesaEl.classList.remove('selected-for-join');
                    } else {
                        selectedTablesForJoining.push(numeroMesa);
                        mesaEl.classList.add('selected-for-join');
                    }
                }
                return;
            }

            if (status === 'livre') {
                window.open(`venda-balcao.html?mesa=${numeroMesa}`, '_blank');
            } else {
                const orderId = mesaEl.dataset.orderId;
                if (orderId) {
                    openManageTableModal(orderId);
                }
            }
        }

        async function loadDeliveryFees() {
            if (deliveryFeesData.length > 0) return;
            try {
                const response = await fetch('/api/menu');
                const data = await response.json();
                deliveryFeesData = data.deliveryFees;
            } catch (error) {
                console.error("Erro ao carregar dados de entrega:", error);
            }
        }

        async function initializePDV() {
            await loadDeliveryFees();

            const settingsRef = doc(db, "config", "system_settings");
            const settingsSnap = await getDoc(settingsRef);
            if (settingsSnap.exists() && settingsSnap.data().tableCount) {
                numeroDeMesas = settingsSnap.data().tableCount;
            }

            const addTableBtn = document.getElementById('add-table-btn');
            addTableBtn.addEventListener('click', async () => {
                numeroDeMesas++;
                initializeMesas();
                try {
                    await setDoc(settingsRef, { tableCount: numeroDeMesas }, { merge: true });
                    showCustomAlert(`Mesa ${numeroDeMesas} adicionada com sucesso.`);
                } catch (error) {
                    console.error("Erro ao salvar o número de mesas:", error);
                    showCustomAlert("Não foi possível salvar a nova mesa.");
                    numeroDeMesas--;
                    initializeMesas();
                }
            });

            document.getElementById('remove-table-btn').addEventListener('click', async () => {
                if (numeroDeMesas <= 1) {
                    showCustomAlert("Não é possível remover mais mesas.");
                    return;
                }

                const lastTableEl = document.getElementById(`mesa-${numeroDeMesas}`);
                if (lastTableEl && lastTableEl.dataset.status !== 'livre') {
                    showCustomAlert(`A Mesa ${numeroDeMesas} está ocupada e não pode ser removida.`);
                    return;
                }

                const confirmed = await showConfirm(`Tem certeza que deseja remover a Mesa ${numeroDeMesas}? Esta ação é permanente.`);
                if (confirmed) {
                    numeroDeMesas--;
                    initializeMesas();
                    try {
                        await setDoc(settingsRef, { tableCount: numeroDeMesas }, { merge: true });
                        showCustomAlert(`Mesa removida com sucesso.`);
                    } catch (error) {
                        console.error("Erro ao salvar o número de mesas:", error);
                        showCustomAlert("Não foi possível salvar a remoção da mesa.");
                        numeroDeMesas++;
                        initializeMesas();
                    }
                }
            });


            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            let audioResumed = false;
            setupCustomAlertModal();

            const mainContainer = document.querySelector('.main-container');
            const sidebar = document.querySelector('.sidebar-nav');
            const mainContentArea = document.getElementById('main-content');

            document.addEventListener('mousemove', (e) => {
                if (e.clientX < 20) {
                    mainContainer.classList.add('sidebar-open');
                }
            });

            sidebar.addEventListener('mouseleave', () => {
                mainContainer.classList.remove('sidebar-open');
            });

            mainContentArea.addEventListener('mouseenter', () => {
                mainContainer.classList.remove('sidebar-open');
            });


            document.body.addEventListener('click', () => {
                if (!audioResumed && audioContext.state === 'suspended') {
                    audioContext.resume();
                    audioResumed = true;
                }
            }, { once: true });

            function playNotificationSound() {
                if (audioContext.state !== 'running') return;
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(880, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + 1);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 1);
            }

            function updateTabCounters(deliveryCount, retiradaCount) {
                const deliveryNotification = document.getElementById('delivery-notification');
                const retiradaNotification = document.getElementById('retirada-notification');

                if (!deliveryNotification || !retiradaNotification) return;

                const deliveryCounter = deliveryNotification.querySelector('span');
                const retiradaCounter = retiradaNotification.querySelector('span');
                const deliveryBell = deliveryNotification.querySelector('.fa-bell');
                const retiradaBell = retiradaNotification.querySelector('.fa-bell');

                if (deliveryCount > 0) {
                    deliveryCounter.textContent = deliveryCount;
                    deliveryNotification.classList.remove('hidden');
                } else {
                    deliveryNotification.classList.add('hidden');
                    if (deliveryBell) deliveryBell.classList.remove('notification-bell-ringing');
                }

                if (retiradaCount > 0) {
                    retiradaCounter.textContent = retiradaCount;
                    retiradaNotification.classList.remove('hidden');
                } else {
                    // ***** ESTA É A CORREÇÃO *****
                    retiradaNotification.classList.add('hidden'); 
                    if(retiradaBell) retiradaBell.classList.remove('notification-bell-ringing');
                }
            }

            initializeMesas();

            mainContent.addEventListener('dragstart', (e) => {
                const card = e.target.closest('.order-card');
                if (card) {
                    const newTag = card.querySelector('.new-order-tag');
                    if (newTag) newTag.remove();
                    draggedItemId = card.dataset.id;
                    setTimeout(() => card.classList.add('dragging'), 0);
                }
            });

            mainContent.addEventListener('dragend', (e) => {
                const card = e.target.closest('.order-card');
                if (card) {
                    card.classList.remove('dragging');
                }
                draggedItemId = null;
            });

            const pdvColumns = document.querySelectorAll('.pdv-column');

            pdvColumns.forEach(column => {
                column.parentElement.classList.add('pdv-column-container');
                column.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    column.parentElement.classList.add('drag-over');
                });

                column.addEventListener('dragleave', () => column.parentElement.classList.remove('drag-over'));

                column.addEventListener('drop', (e) => {
                    e.preventDefault();
                    column.parentElement.classList.remove('drag-over');

                    if (!draggedItemId) return;

                    const columnElement = e.target.closest('[data-status]');
                    const newStatus = columnElement.dataset.status;

                    if (newStatus) {
                        updateOrderStatus(draggedItemId, newStatus);
                    }
                });
            });


            const q = query(collection(db, "pedidos"), orderBy("criadoEm", "desc"));

            onSnapshot(q, (snapshot) => {

                [colDeliveryNovo, colDeliveryPreparo, colDeliveryPronto, colDeliveryEntrega, colDeliveryEntregue, colRetiradaNovo, colRetiradaPreparo, colRetiradaPronto, colRetiradaEntregue, colMesasFechado]
                 .forEach(col => col.innerHTML = '');
                initializeMesas();

                let totalOrdersToday = 0;
                let totalRevenueToday = 0;
                const today = new Date().setHours(0, 0, 0, 0);

                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        const orderData = change.doc.data();
                        const orderType = identifyOrderType(orderData);
                        if (orderData.status === 'Novo' && orderType !== 'mesa') {
                            playNotificationSound();
                            const notificationDiv = document.getElementById(`${orderType}-notification`);
                            if (notificationDiv) {
                                const bell = notificationDiv.querySelector('.fa-bell');
                                // Apenas adiciona a animação se a aba não estiver ativa
                                const tabButton = document.querySelector(`.main-tab-btn[data-tab="${orderType}"]`);
                                if (bell && !tabButton.classList.contains('active')) {
                                    bell.classList.add('notification-bell-ringing');
                                }
                            }
                        }
                    }
                });

                allOrdersCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const activeOrders = allOrdersCache;

                let newDeliveryCount = 0;
                let newRetiradaCount = 0;
                activeOrders.forEach(order => {
                    if (order.status === 'Novo') {
                        const orderType = identifyOrderType(order);
                        if (orderType === 'delivery') newDeliveryCount++;
                        if (orderType === 'retirada') newRetiradaCount++;
                    }
                });
                updateTabCounters(newDeliveryCount, newRetiradaCount);

                const processedTables = new Set();
                const activeTableOrders = activeOrders.filter(order =>
                    identifyOrderType(order) === 'mesa' &&
                    order.status !== 'Finalizado' &&
                    order.status !== 'Arquivado' &&
                    order.status !== 'Fechado'
                );

                activeTableOrders.forEach(order => {
                    const orderId = order.id;
                    const mesaNumbers = order.grupoMesas && order.grupoMesas.length > 0
                        ? order.grupoMesas
                        : [parseInt((order.endereco?.clientName || "").replace(/[^0-9]/g, ''))].filter(n => n > 0); // Adicionado "?"

                    if (mesaNumbers.length > 0) {
                        const sortedGroup = mesaNumbers.sort((a, b) => a - b);
                        const primaryTableNumber = sortedGroup[0];
                        const orderStatus = order.status;
                        const hasItems = order.itens && order.itens.length > 0;

                        const createdAtTimestamp = order.criadoEm && order.criadoEm.toMillis ? order.criadoEm.toMillis() : Date.now();
                        const statusChangedAtTimestamp = order.statusChangedAt && order.statusChangedAt.toMillis ? order.statusChangedAt.toMillis() : createdAtTimestamp;

                        if (sortedGroup.length > 1) {
                            const primaryTableEl = document.getElementById(`mesa-${primaryTableNumber}`);
                            if (primaryTableEl) {
                                primaryTableEl.classList.remove('mesa-status-livre', 'mesa-status-ocupada', 'mesa-status-pronto', 'mesa-status-servido');
                                primaryTableEl.classList.add('mesa-status-juntada'); // Sempre azul para grupos
                                primaryTableEl.querySelector('.status-text').textContent = 'Agrupada';
                                primaryTableEl.querySelector('span.text-3xl').textContent = sortedGroup.join(' + ');
                                primaryTableEl.dataset.status = 'juntada';
                                primaryTableEl.dataset.orderId = orderId;
                                primaryTableEl.dataset.orderStatus = order.status;
                                primaryTableEl.dataset.grupo = sortedGroup.join(',');

                                const timerContainer = primaryTableEl.querySelector('.mesa-timer-container');
                                if (hasItems) {
                                    timerContainer.classList.remove('hidden');
                                    primaryTableEl.querySelector('.total-timer-value').dataset.createdAt = createdAtTimestamp;
                                    primaryTableEl.querySelector('.status-timer-value').dataset.statusChangedAt = statusChangedAtTimestamp;
                                } else {
                                    timerContainer.classList.add('hidden');
                                }

                                processedTables.add(primaryTableNumber);

                                for (let i = 1; i < sortedGroup.length; i++) {
                                    const secondaryTableEl = document.getElementById(`mesa-${sortedGroup[i]}`);
                                    if (secondaryTableEl) secondaryTableEl.classList.add('hidden');
                                    processedTables.add(sortedGroup[i]);
                                }
                            }
                        } else if (mesaNumbers.length === 1 && !processedTables.has(primaryTableNumber)) {
                            let mesaStatusClass;
                            let mesaStatusText;
                            if (orderStatus === 'Novo' || orderStatus === 'Em Preparo') {
                                mesaStatusClass = 'mesa-status-ocupada'; // Amarelo
                                mesaStatusText = orderStatus === 'Novo' ? 'Aguardando Pedido' : 'Em Preparo';
                            } else if (orderStatus === 'Pronto Para Servir') {
                                mesaStatusClass = 'mesa-status-pronto';
                                mesaStatusText = 'Pronto P/ Servir';
                            } else if (orderStatus === 'Servido') {
                                mesaStatusClass = 'mesa-status-servido';
                                mesaStatusText = 'Servido';
                            } else {
                                mesaStatusClass = 'mesa-status-ocupada'; // Padrão
                                mesaStatusText = 'Ocupada';
                            }

                            const mesaEl = document.getElementById(`mesa-${primaryTableNumber}`);
                            if (mesaEl) {
                                mesaEl.classList.remove('mesa-status-livre', 'mesa-status-juntada', 'mesa-status-ocupada', 'mesa-status-pronto', 'mesa-status-servido');
                                mesaEl.classList.add(mesaStatusClass);
                                mesaEl.querySelector('.status-text').textContent = mesaStatusText;
                                mesaEl.dataset.status = 'ocupada';
                                mesaEl.dataset.orderId = orderId;
                                mesaEl.dataset.orderStatus = order.status;
                                mesaEl.dataset.grupo = '';

                                const timerContainer = mesaEl.querySelector('.mesa-timer-container');
                                if (hasItems) {
                                    timerContainer.classList.remove('hidden');
                                    mesaEl.querySelector('.total-timer-value').dataset.createdAt = createdAtTimestamp;
                                    mesaEl.querySelector('.status-timer-value').dataset.statusChangedAt = statusChangedAtTimestamp;
                                } else {
                                    timerContainer.classList.add('hidden');
                                }
                                processedTables.add(primaryTableNumber);
                            }
                        }
                    }
                });

                for (let i = 1; i <= numeroDeMesas; i++) {
                    if (!processedTables.has(i)) {
                         const mesaEl = document.getElementById(`mesa-${i}`);
                        if (mesaEl) {
                            mesaEl.classList.remove('mesa-status-ocupada', 'mesa-status-juntada', 'hidden', 'mesa-status-pronto', 'mesa-status-servido');
                            mesaEl.classList.add('mesa-status-livre');
                            mesaEl.querySelector('.status-text').textContent = 'Livre';
                            mesaEl.dataset.status = 'livre';
                            mesaEl.dataset.orderId = '';
                            mesaEl.style.gridColumn = '';
                            mesaEl.querySelector('span.text-3xl').textContent = i.toString().padStart(2, '0');

                            const timerContainer = mesaEl.querySelector('.mesa-timer-container');
                            if (timerContainer) {
                                timerContainer.classList.add('hidden');
                            }
                        }
                    }
                }

                activeOrders.forEach(order => {
                    const orderId = order.id;
                    const orderDate = order.criadoEm ? new Date(order.criadoEm.seconds * 1000).setHours(0, 0, 0, 0) : today;
                    const orderType = identifyOrderType(order);

                    // **CORREÇÃO:** Verificar se order.total existe antes de acessar finalTotal
                    const isCompleted = order.status === 'Entregue' || order.status === 'Fechado';

                    if (orderDate === today) {
                        totalOrdersToday++;

                        if (isCompleted && order.total) { // <-- Adicionado cheque order.total
                            totalRevenueToday += order.total.finalTotal;
                        }
                    }

                    if (order.status === 'Finalizado' || order.status === 'Arquivado') {
                        return;
                    }

                    if (orderType === 'mesa' && order.status === 'Fechado') {
                         colMesasFechado.appendChild(createOrderCard(order, orderId));
                         return;
                    }


                    const card = createOrderCard(order, orderId);

                    if (orderType === 'delivery') {
                        if (order.status === 'Novo') colDeliveryNovo.appendChild(card);
                        else if (order.status === 'Em Preparo') colDeliveryPreparo.appendChild(card);
                        else if (order.status === 'Pronto para Entrega') colDeliveryPronto.appendChild(card);
                        else if (order.status === 'Saiu para Entrega') colDeliveryEntrega.appendChild(card);
                        else if (order.status === 'Entregue') colDeliveryEntregue.appendChild(card);
                    } else if (orderType === 'retirada') {
                        if (order.status === 'Novo') colRetiradaNovo.appendChild(card);
                        else if (order.status === 'Em Preparo') colRetiradaPreparo.appendChild(card);
                        else if (order.status === 'Pronto para Retirada') colRetiradaPronto.appendChild(card);
                        else if (order.status === 'Entregue') colRetiradaEntregue.appendChild(card);
                    }
                });

                const totalCompletedOrders = activeOrders.filter(order => {
                    const orderDate = order.criadoEm ? new Date(order.criadoEm.seconds * 1000).setHours(0, 0, 0, 0) : today;
                    return orderDate === today && (order.status === 'Entregue' || order.status === 'Fechado');
                }).length;

                const avgTicket = totalCompletedOrders > 0 ? totalRevenueToday / totalCompletedOrders : 0;

                document.getElementById('stats-total-orders').textContent = totalOrdersToday;
                document.getElementById('stats-total-revenue').textContent = `R$ ${totalRevenueToday.toFixed(2).replace('.', ',')}`;
                document.getElementById('stats-avg-ticket').textContent = `R$ ${avgTicket.toFixed(2).replace('.', ',')}`;
            });
            if (timerIntervalId) clearInterval(timerIntervalId);
            timerIntervalId = setInterval(updateTimers, 1000);
        }

        function updateTimers() {
            const now = new Date();
            document.querySelectorAll('.order-card, .mesa-item, .mesa-order-details').forEach(card => {
                const totalTimerEl = card.querySelector('.total-timer-value');
                const statusTimerEl = card.querySelector('.status-timer-value');

                if (totalTimerEl && totalTimerEl.dataset.createdAt !== "0") {
                    const createdAt = new Date(parseInt(totalTimerEl.dataset.createdAt));
                    const totalDiff = Math.max(0, Math.floor((now - createdAt) / 1000));
                    totalTimerEl.textContent = formatTime(totalDiff);

                    const isTable = card.classList.contains('mesa-item');
                    if (isTable) {
                        const timerContainer = totalTimerEl.parentElement;
                        timerContainer.classList.remove('timer-green', 'timer-yellow', 'timer-red');
                        if (totalDiff < 1800) { // 30 mins
                            timerContainer.classList.add('timer-green');
                        } else if (totalDiff < 3600) { // 60 mins
                            timerContainer.classList.add('timer-yellow');
                        } else {
                            timerContainer.classList.add('timer-red');
                        }
                    }
                }

                if (statusTimerEl && statusTimerEl.dataset.statusChangedAt !== "0") {
                    const statusChangedAt = new Date(parseInt(statusTimerEl.dataset.statusChangedAt));
                    const statusDiff = Math.max(0, Math.floor((now - statusChangedAt) / 1000));
                    statusTimerEl.textContent = formatTime(statusDiff);

                    const statusTimerContainer = statusTimerEl.parentElement;
                    statusTimerContainer.classList.remove('timer-green', 'timer-yellow', 'timer-red');

                    if (statusDiff < 300) {
                        statusTimerContainer.classList.add('timer-green');
                    } else if (statusDiff < 600) {
                        statusTimerContainer.classList.add('timer-yellow');
                    } else {
                        statusTimerContainer.classList.add('timer-red');
                    }
                }
            });
        }

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            return `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }


        function identifyOrderType(orderData) {
            // **CORREÇÃO:** Adicionar verificação se orderData.endereco existe
            if (orderData?.endereco?.rua === "Retirada no Balcão") return 'retirada';
            if (orderData?.endereco?.rua === "Mesa") return 'mesa';
            // Se não for retirada nem mesa, assume delivery (ou padrão se endereco não existir)
            return 'delivery';
        }

        function createOrderCard(order, id) {
            const card = document.createElement('div');
            card.className = 'order-card bg-white rounded-lg shadow-md border-l-4 relative';
            card.setAttribute('draggable', 'true');
            card.dataset.id = id;

            // **CORREÇÃO:** Adicionar valor padrão caso order.endereco ou order.endereco.clientName não existam
            const clientName = order?.endereco?.clientName || 'Cliente não informado';
            // **CORREÇÃO:** Adicionar valor padrão caso order.total ou order.total.finalTotal não existam
            const finalTotal = order?.total?.finalTotal ?? 0; // Usar ?? para pegar 0 se for null ou undefined
            // **CORREÇÃO:** Adicionar valor padrão caso order.itens não exista ou seja vazio
            const orderItems = order?.itens ?? [];

            const orderType = identifyOrderType(order);
            let newTagHtml = '';
            if (order.status === 'Novo' && orderType !== 'mesa') {
                newTagHtml = '<div class="new-order-tag animate-pulse">Novo</div>';
            }

            // <!--
            // ========================================================================
            // INÍCIO DA ALTERAÇÃO - createOrderCard (PDV Card Display)
            // ========================================================================
            //
            // Lógica atualizada para ler 'item.extras' (do balcão) E
            // 'item.ingredients' (do cardápio online) para mostrar os adicionais,
            // garantindo que o 'placement' seja lido de AMBOS.
            //
            // ========================================================================
            // -->
            let itemsHtml = orderItems.map(item => {
                let itemDetails = '';
                
                // 1. Pega adicionais (pizzas/itens) do Balcão (campo 'extras')
                if (item.extras && item.extras.length > 0) {
                    itemDetails += '<ul class="text-xs text-gray-500 pl-4 list-disc">';
                    item.extras.forEach(extra => {
                        const quantityText = (extra.quantity && extra.quantity > 1) ? ` (x${extra.quantity})` : '';
                        const placementText = extra.placement ? ` (${extra.placement})` : ''; // Lê o placement
                        itemDetails += `<li>+ ${extra.name}${quantityText}${placementText}</li>`;
                    });
                    itemDetails += '</ul>';
                }

                // 2. Pega ingredientes (Burger Custom OU Adicionais de Pizza do Cardápio Online)
                if (item.ingredients && item.ingredients.length > 0) {
                    if (item.type === 'custom_burger') {
                        // Trata como ingredientes de hambúrguer (remoções)
                        itemDetails += '<ul class="text-xs text-gray-500 pl-4 list-disc">';
                        item.ingredients.forEach(ing => {
                            const quantityText = (ing.quantity && ing.quantity > 1) ? ` (x${ing.quantity})` : '';
                            itemDetails += `<li>- ${ing.name}${quantityText}</li>`;
                        });
                        itemDetails += '</ul>';
                    } else {
                        // Trata como adicionais de pizza (adições) - do Cardápio Online (campo 'ingredients')
                        itemDetails += '<ul class="text-xs text-gray-500 pl-4 list-disc">';
                        item.ingredients.forEach(extra => {
                            const quantityText = (extra.quantity && extra.quantity > 1) ? ` (x${extra.quantity})` : '';
                            const placementText = extra.placement ? ` (${extra.placement})` : ''; // <-- CORREÇÃO: Lê o placement aqui
                            itemDetails += `<li>+ ${extra.name}${quantityText}${placementText}</li>`; // <-- CORREÇÃO: Adiciona o placementText
                        });
                        itemDetails += '</ul>';
                    }
                }

                return `<li class="text-sm">
                            <div class="flex justify-between">
                                <span>${item.name || 'Item desconhecido'}</span>
                                <span class="font-medium">R$ ${parseFloat(item.price || 0).toFixed(2).replace('.', ',')}</span>
                            </div>
                            ${itemDetails}
                        </li>`;
            }).join('');
            // <!--
            // ========================================================================
            // FIM DA ALTERAÇÃO - createOrderCard
            // ========================================================================
            // -->

            const createdAtTimestamp = order.criadoEm && order.criadoEm.toMillis ? order.criadoEm.toMillis() : Date.now();
            const statusChangedAtTimestamp = order.statusChangedAt && order.statusChangedAt.toMillis ? order.statusChangedAt.toMillis() : createdAtTimestamp;

            let buttonHtml = '';
            let finalStep = false;

            if (orderType === 'mesa') {
                if (order.status === 'Em Preparo') {
                    card.classList.add('border-yellow-500');
                    buttonHtml = `<button data-id="${id}" data-status="Pronto Para Servir" class="move-btn w-full mt-4 bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600">Pronto P/ Servir</button>`;
                } else if (order.status === 'Pronto Para Servir') {
                    card.classList.add('border-green-500');
                    buttonHtml = `<button data-id="${id}" data-status="Servido" class="move-btn w-full mt-4 bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600">Servido</button>`;
                } else if (order.status === 'Servido') {
                    card.classList.add('border-blue-500');
                    buttonHtml = `<button data-id="${id}" data-status="Fechado" class="move-btn w-full mt-4 bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600">Fechar Conta</button>`;
                } else if (order.status === 'Fechado') {
                    card.classList.add('border-gray-400');
                    finalStep = true;
                }
            } else { // Delivery e Retirada
                if (order.status === 'Novo') {
                    card.classList.add('border-red-500');
                    buttonHtml = `<button data-id="${id}" data-status="Em Preparo" class="move-btn w-full mt-4 bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600">Iniciar Preparo</button>`;
                } else if (order.status === 'Em Preparo') {
                    card.classList.add('border-yellow-500');
                    const nextStatus = orderType === 'retirada' ? 'Pronto para Retirada' : 'Pronto para Entrega';
                    buttonHtml = `<button data-id="${id}" data-status="${nextStatus}" class="move-btn w-full mt-4 bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600">Pronto</button>`;
                } else if (order.status === 'Pronto para Entrega') {
                    card.classList.add('border-green-500');
                    buttonHtml = `<button data-id="${id}" data-status="Saiu para Entrega" class="move-btn w-full mt-4 bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600">Saiu p/ Entrega</button>`;
                } else if (order.status === 'Saiu para Entrega') {
                    card.classList.add('border-blue-500');
                    buttonHtml = `<button data-id="${id}" data-status="Entregue" class="move-btn w-full mt-4 bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-600">Marcar como Entregue</button>`;
                } else if (order.status === 'Pronto para Retirada') {
                    card.classList.add('border-green-500');
                    buttonHtml = `<button data-id="${id}" data-status="Entregue" class="move-btn w-full mt-4 bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-600">Marcar como Entregue</button>`;
                } else if (order.status === 'Entregue' || order.status === 'Fechado') {
                    card.classList.add('border-gray-400');
                    finalStep = true;
                }
            }

            // **CORREÇÃO:** Verificar se order.endereco existe antes de acessar telefone
            const hasPhone = order?.endereco?.telefone;

            let observationHtml = order.observacao ? `<div class="mt-2 pt-2 border-t border-dashed"><p class="text-sm font-bold text-blue-700">Observação:</p><p class="text-sm">${order.observacao}</p></div>` : '';

            let paymentText = 'Não definido';
            if (order.pagamento) {
                if (typeof order.pagamento === 'object' && order.pagamento.method) {
                    paymentText = `${order.pagamento.method}`;
                    if (order.pagamento.trocoPara) {
                        paymentText += ` (Troco p/ R$ ${parseFloat(order.pagamento.trocoPara).toFixed(2).replace('.', ',')})`;
                    }
                } else {
                    paymentText = order.pagamento;
                }
            }
            let paymentHtml = order.pagamento ? `<div class="text-sm mt-2 pt-2 border-t"><strong>Pagamento:</strong> ${paymentText}</div>` : '';

            // **CORREÇÃO:** Tratar caso onde order.endereco pode não existir
            let addressHtml = '';
            if (order?.endereco) {
                 addressHtml = `<p class="text-xs text-gray-500">${order.endereco.rua || 'Rua não informada'}, ${order.endereco.numero || 'S/N'} - ${order.endereco.bairro || 'Bairro não informado'}</p>`;
            } else {
                 addressHtml = `<p class="text-xs text-red-500">Erro: Endereço não encontrado.</p>`;
            }
            card.innerHTML = `
                ${newTagHtml}
                <div class="card-header flex justify-between items-start cursor-pointer p-4">
                    <div>
                        <h3 class="font-bold">Pedido #${id.substring(0, 5)}</h3>
                        <p class="text-sm font-medium">${clientName}</p>
                    </div>
                    <span class="font-bold text-lg">R$ ${parseFloat(finalTotal).toFixed(2).replace('.', ',')}</span>
                </div>
                 <div class="px-4 pb-2 flex justify-between items-center space-x-2">
                    <div class="timer-container timer-green">
                        <i class="far fa-clock"></i> Total: <span class="total-timer-value" data-created-at="${createdAtTimestamp}">00:00</span>
                    </div>
                    <div class="timer-container timer-green">
                        <i class="fas fa-hourglass-start"></i> Na Etapa: <span class="status-timer-value" data-status-changed-at="${statusChangedAtTimestamp}">00:00</span>
                    </div>
                </div>
                <div class="details-container">
                    <div class="px-4 pb-4">
                        <div class="mt-2 pt-2 border-t">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs font-medium text-gray-500">Criado às ${new Date(createdAtTimestamp).toLocaleTimeString('pt-BR')}</span>
                                <div class="flex items-center space-x-2">
                                    <button data-id="${id}" data-type="kitchen" class="print-btn text-gray-500" title="Imprimir Comanda Cozinha"><i class="fas fa-utensils"></i></button>
                                    <button data-id="${id}" data-type="client" class="print-btn text-gray-500" title="Imprimir Recibo Cliente"><i class="fas fa-receipt"></i></button>
                                    ${hasPhone ? `<button data-id="${id}" class="whatsapp-btn text-green-500" title="Confirmar Pedido no WhatsApp"><i class="fab fa-whatsapp"></i></button>` : ''}
                                    <button class="archive-btn text-green-500 hover:text-green-700 ${!finalStep ? 'opacity-50 cursor-not-allowed' : ''}" data-id="${id}" ${!finalStep ? 'disabled' : ''} title="Finalizar e Arquivar Pedido"><i class="fas fa-check-circle"></i></button>
                                    <button data-id="${id}" class="manage-btn text-blue-500" title="Editar Pedido"><i class="fas fa-edit"></i></button>
                                    <button data-id="${id}" class="delete-btn text-red-500" title="Excluir Pedido"><i class="fas fa-trash-alt"></i></button>
                                </div>
                            </div>
                            ${addressHtml}
                            <ul class="border-t border-b py-2 my-2 space-y-1">${itemsHtml}</ul>
                            ${observationHtml}
                            ${paymentHtml}
                            ${buttonHtml}
                        </div>
                    </div>
                </div>
            `;

            return card;
        }
        function createDetailedOrderCardHtml(order, id) {
             const createdAtTimestamp = order.criadoEm && order.criadoEm.toMillis ? order.criadoEm.toMillis() : Date.now();
             const statusChangedAtTimestamp = order.statusChangedAt && order.statusChangedAt.toMillis ? order.statusChangedAt.toMillis() : createdAtTimestamp;
             const orderType = identifyOrderType(order);

            // <!--
            // ========================================================================
            // INÍCIO DA ALTERAÇÃO - createDetailedOrderCardHtml (Modal Detalhes da Mesa)
            // ========================================================================
            //
            // Lógica atualizada para ler 'item.extras' (do balcão) E
            // 'item.ingredients' (do cardápio online) para mostrar os adicionais
            // no modal de gerenciamento de mesa.
            //
            // ========================================================================
            // -->
             const orderItems = Array.isArray(order.itens) ? order.itens : [];
             let itemsHtml = orderItems.map(item => {
                let itemDetails = '';
                
                // 1. Pega adicionais (pizzas/itens) do Balcão (campo 'extras')
                if (item.extras && item.extras.length > 0) {
                    itemDetails += '<ul class="text-xs text-gray-500 pl-4 list-disc">';
                    item.extras.forEach(extra => {
                        const quantityText = (extra.quantity && extra.quantity > 1) ? ` (x${extra.quantity})` : '';
                        const placementText = extra.placement ? ` (${extra.placement})` : '';
                        itemDetails += `<li>+ ${extra.name}${quantityText}${placementText}</li>`;
                    });
                    itemDetails += '</ul>';
                }

                // 2. Pega ingredientes (Burger Custom OU Adicionais de Pizza do Cardápio Online)
                if (item.ingredients && item.ingredients.length > 0) {
                    if (item.type === 'custom_burger') {
                        // Trata como ingredientes de hambúrguer (remoções)
                        itemDetails += '<ul class="text-xs text-gray-500 pl-4 list-disc">';
                        item.ingredients.forEach(ing => {
                            const quantityText = (ing.quantity && ing.quantity > 1) ? ` (x${ing.quantity})` : '';
                            itemDetails += `<li>- ${ing.name}${quantityText}</li>`;
                        });
                        itemDetails += '</ul>';
                    } else {
                        // Trata como adicionais de pizza (adições) - do Cardápio Online (campo 'ingredients')
                        itemDetails += '<ul class="text-xs text-gray-500 pl-4 list-disc">';
                        item.ingredients.forEach(extra => {
                            const quantityText = (extra.quantity && extra.quantity > 1) ? ` (x${extra.quantity})` : '';
                            const placementText = extra.placement ? ` (${extra.placement})` : ''; // <-- CORREÇÃO: Lê o placement aqui
                            itemDetails += `<li>+ ${extra.name}${quantityText}${placementText}</li>`; // <-- CORREÇÃO: Adiciona o placementText
                        });
                        itemDetails += '</ul>';
                    }
                }

                return `<li class="text-sm">
                            <div class="flex justify-between">
                                <span>${item.name || 'Item desconhecido'}</span>
                                <span class="font-medium">R$ ${parseFloat(item.price || 0).toFixed(2).replace('.', ',')}</span>
                            </div>
                            ${itemDetails}
                        </li>`;
             }).join('');
            // <!--
            // ========================================================================
            // FIM DA ALTERAÇÃO - createDetailedOrderCardHtml
            // ========================================================================
            // -->

             let buttonHtml = '';

             if (orderType === 'mesa') {
                if (order.status === 'Em Preparo') {
                    buttonHtml = `<button data-id="${id}" data-status="Pronto Para Servir" class="move-btn modal-move-btn w-full mt-4 bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600">Pronto P/ Servir</button>`;
                } else if (order.status === 'Pronto Para Servir') {
                    buttonHtml = `<button data-id="${id}" data-status="Servido" class="move-btn modal-move-btn w-full mt-4 bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600">Servido</button>`;
                } else if (order.status === 'Servido') {
                    buttonHtml = `<button data-id="${id}" data-status="Fechado" class="move-btn modal-move-btn w-full mt-4 bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600">Fechar Conta</button>`;
                } else {
                     buttonHtml = `<button disabled class="w-full mt-4 bg-gray-400 text-white font-bold py-2 px-4 rounded-lg cursor-not-allowed">Status: ${order.status}</button>`;
                }
            } else { // Delivery e Retirada
                 if (order.status === 'Novo') {
                    buttonHtml = `<button data-id="${id}" data-status="Em Preparo" class="move-btn modal-move-btn w-full mt-4 bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600">Iniciar Preparo</button>`;
                 } else if (order.status === 'Em Preparo') {
                    const nextStatus = orderType === 'retirada' ? 'Pronto para Retirada' : 'Pronto para Entrega';
                    buttonHtml = `<button data-id="${id}" data-status="${nextStatus}" class="move-btn modal-move-btn w-full mt-4 bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600">Pronto</button>`;
                 } else if (order.status === 'Pronto para Entrega') {
                    buttonHtml = `<button data-id="${id}" data-status="Saiu para Entrega" class="move-btn modal-move-btn w-full mt-4 bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600">Saiu p/ Entrega</button>`;
                 } else if (order.status === 'Saiu para Entrega') {
                    buttonHtml = `<button data-id="${id}" data-status="Entregue" class="move-btn modal-move-btn w-full mt-4 bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-600">Marcar como Entregue</button>`;
                 } else if (order.status === 'Pronto para Retirada') {
                    buttonHtml = `<button data-id="${id}" data-status="Entregue" class="move-btn modal-move-btn w-full mt-4 bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-600">Marcar como Entregue</button>`;
                 } else {
                     buttonHtml = `<button disabled class="w-full mt-4 bg-gray-400 text-white font-bold py-2 px-4 rounded-lg cursor-not-allowed">Status: ${order.status}</button>`;
                 }
            }

            let observationHtml = order.observacao ? `<div class="mt-2 pt-2 border-t border-dashed"><p class="text-sm font-bold text-blue-700">Observação:</p><p class="text-sm">${order.observacao}</p></div>` : '';

            let paymentText = 'Não definido';
            if (order.pagamento) {
                if (typeof order.pagamento === 'object' && order.pagamento.method) {
                    paymentText = `${order.pagamento.method}`;
                    if (order.pagamento.trocoPara) {
                        paymentText += ` (Troco p/ R$ ${parseFloat(order.pagamento.trocoPara).toFixed(2).replace('.', ',')})`;
                    }
                } else {
                    paymentText = order.pagamento;
                }
            }
            let paymentHtml = order.pagamento ? `<div class="text-sm mt-2 pt-2 border-t"><strong>Pagamento:</strong> ${paymentText}</div>` : '';

            // **CORREÇÃO:** Tratar caso onde order.endereco pode não existir
            let addressHtml = '';
            if (order?.endereco) {
                if (orderType === 'mesa' && order.endereco.rua === 'Mesa') {
                    addressHtml = `<p class="text-xs text-gray-500">${order.endereco.rua}</p>`;
                } else {
                    addressHtml = `<p class="text-xs text-gray-500">${order.endereco.rua || 'Rua não informada'}, ${order.endereco.numero || 'S/N'} - ${order.endereco.bairro || 'Bairro não informado'}</p>`;
                }
            } else {
                addressHtml = `<p class="text-xs text-red-500">Erro: Endereço não encontrado.</p>`;
            }

            const hasPhone = order?.endereco?.telefone; // **CORREÇÃO:** Checar se endereco existe

             return `
                <div class="mesa-order-details">
                    <div class="px-4 pb-2 flex justify-between items-center space-x-2">
                        <div class="timer-container timer-green">
                            <i class="far fa-clock"></i> Total: <span class="total-timer-value" data-created-at="${createdAtTimestamp}">${formatTime(Math.max(0, Math.floor((Date.now() - createdAtTimestamp) / 1000)))}</span>
                        </div>
                        <div class="timer-container timer-green">
                            <i class="fas fa-hourglass-start"></i> Na Etapa: <span class="status-timer-value" data-status-changed-at="${statusChangedAtTimestamp}">${formatTime(Math.max(0, Math.floor((Date.now() - statusChangedAtTimestamp) / 1000)))}</span>
                        </div>
                    </div>
                    <div class="px-4 pb-4">
                        <div class="mt-2 pt-2 border-t">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs font-medium text-gray-500">Criado às ${new Date(createdAtTimestamp).toLocaleTimeString('pt-BR')}</span>
                                <div class="flex items-center space-x-2">
                                    <button data-id="${id}" data-type="kitchen" class="print-btn modal-print-btn text-gray-500" title="Imprimir Comanda Cozinha"><i class="fas fa-utensils"></i></button>
                                    <button data-id="${id}" data-type="client" class="print-btn modal-print-btn text-gray-500" title="Imprimir Recibo Cliente"><i class="fas fa-receipt"></i></button>
                                    ${hasPhone ? `<button data-id="${id}" class="whatsapp-btn modal-whatsapp-btn text-green-500" title="Confirmar Pedido no WhatsApp"><i class="fab fa-whatsapp"></i></button>` : ''}
                                    <button class="archive-btn text-green-500 hover:text-green-700 opacity-50 cursor-not-allowed" data-id="${id}" disabled title="Arquivar Pedido"><i class="fas fa-check-circle"></i></button>
                                    <button data-id="${id}" class="manage-btn modal-manage-btn text-blue-500" title="Editar Pedido"><i class="fas fa-edit"></i></button>
                                    <button data-id="${id}" class="delete-btn modal-delete-btn text-red-500" title="Excluir Pedido"><i class="fas fa-trash-alt"></i></button>
                                </div>
                            </div>
                            ${addressHtml}
                            <ul class="border-t border-b py-2 my-2 space-y-1">${itemsHtml}</ul>
                            ${observationHtml}
                            ${paymentHtml}
                            ${buttonHtml}
                        </div>
                    </div>
                </div>
            `;
        }


        function attachModalActionListeners(orderId, order) {
            const modal = document.getElementById('manage-table-modal');
            if (!modal) return;

            modal.querySelectorAll('.modal-move-btn').forEach(btn => {
                btn.onclick = () => {
                    updateOrderStatus(btn.dataset.id, btn.dataset.status);
                    modal.style.display = 'none';
                };
            });
            modal.querySelectorAll('.modal-print-btn').forEach(btn => {
                btn.onclick = () => {
                    printOrder(btn.dataset.id, btn.dataset.type);
                };
            });

            modal.querySelectorAll('.modal-whatsapp-btn').forEach(btn => {
                btn.onclick = () => {
                    openWhatsappConfirmModal(btn.dataset.id);
                };
            });

            modal.querySelectorAll('.modal-delete-btn').forEach(btn => {
                btn.onclick = () => {
                    orderIdToDelete = btn.dataset.id;
                    deleteConfirmModal.style.display = 'flex';
                };
            });

            const closeBtn = modal.querySelector('#close-account-btn');
            if (closeBtn) {
                closeBtn.onclick = () => {
                    if (order && order.pagamento === 'A Definir') {
                        // **CORREÇÃO:** Garantir que order.total e finalTotal existam
                        const totalValue = order?.total?.finalTotal ?? 0;
                        openTablePaymentModal(orderId, totalValue);
                    } else {
                        updateOrderStatus(orderId, 'Fechado');
                        modal.style.display = 'none';
                    }
                };
            }

            const transferBtn = modal.querySelector('#transfer-table-btn');
            if (transferBtn) {
                transferBtn.onclick = () => {
                    handleTableTransferClick(orderId);
                };
            }

            const manageBtn = modal.querySelector('.modal-manage-btn');
            if (manageBtn) {
                 manageBtn.onclick = () => {
                     window.open(`venda-balcao.html?orderId=${orderId}`, '_blank');
                     modal.style.display = 'none';
                };
            }

            const ungroupBtn = modal.querySelector('#ungroup-tables-btn');
            if (ungroupBtn) {
                ungroupBtn.onclick = async () => {
                    const orderRef = doc(db, "pedidos", orderId);
                    // Check if the order has items
                    if (order.itens && order.itens.length === 0) {
                        // Group is empty, just delete the order
                        const confirmed = await showConfirm(`Tem certeza que deseja desagrupar estas mesas vazias? A referência do grupo será removida.`);
                        if (confirmed) {
                            try {
                                await deleteDoc(orderRef);
                                showCustomAlert("Mesas desagrupadas e grupo vazio removido.");
                                modal.style.display = 'none';
                            } catch (error) {
                                console.error("Erro ao remover grupo vazio:", error);
                                showCustomAlert("Não foi possível remover o grupo de mesas. Tente novamente.");
                            }
                        }
                    } else {
                        // Group has items, re-associate with the primary table
                        const primaryTable = order.grupoMesas[0];
                        const confirmed = await showConfirm(`Tem certeza que deseja desagrupar estas mesas? O pedido atual ficará associado apenas à Mesa ${primaryTable}.`);
                        if (confirmed) {
                            try {
                                await updateDoc(orderRef, {
                                    grupoMesas: null,
                                    "endereco.clientName": `Mesa ${primaryTable}`
                                });
                                showCustomAlert("Mesas desagrupadas com sucesso.");
                                modal.style.display = 'none';
                            } catch (error) {
                                console.error("Erro ao desagrupar mesas:", error);
                                showCustomAlert("Não foi possível desagrupar as mesas. Tente novamente.");
                            }
                        }
                    }
                };
            }
        }

        async function handleArchiveOrder(orderId) {
            const archiveBtn = document.querySelector(`.archive-btn[data-id="${orderId}"]`);
            if (archiveBtn && archiveBtn.disabled) return;

            if(archiveBtn) {
                archiveBtn.disabled = true;
                archiveBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
            }

            try {
                const response = await fetch('/api/arquivar-pedido', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ orderId: orderId })
                });

                if (!response.ok) {
                    let errorMsg = `O servidor respondeu com um erro: ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        errorMsg = `O servidor respondeu com um erro: ${JSON.stringify(errorData)}`;
                    } catch (e) {
                        errorMsg = `O servidor respondeu com um erro: ${await response.text()}`;
                    }
                    throw new Error(errorMsg);
                }

                const orderRef = doc(db, "pedidos", orderId);
                await deleteDoc(orderRef);

            } catch (error) {
                console.error("Erro ao arquivar pedido:", error);
                alert("Não foi possível arquivar o pedido: " + error.message);
                if(archiveBtn){
                    archiveBtn.disabled = false;
                    archiveBtn.innerHTML = `<i class="fas fa-check-circle"></i>`;
                }
            }
        }

        async function handleTableTransferClick(orderIdToTransfer) {
            const orderRef = doc(db, "pedidos", orderIdToTransfer);
            const docSnap = await getDoc(orderRef);

            if (!docSnap.exists()) {
                showCustomAlert("Erro: Pedido não encontrado para transferência.");
                return;
            }
            currentManagingOrderData = docSnap.data();

            const freeTablesSelect = document.getElementById('free-tables-select');
            freeTablesSelect.innerHTML = '<option value="">Selecione uma mesa livre...</option>';
            document.querySelectorAll('.mesa-item.mesa-status-livre').forEach(mesaEl => {
                const number = mesaEl.dataset.number;
                const option = document.createElement('option');
                option.value = number;
                option.textContent = `Mesa ${number}`;
                freeTablesSelect.appendChild(option);
            });

            if (freeTablesSelect.options.length === 1) {
                showCustomAlert("Nenhuma mesa livre disponível para transferência.");
                return;
            }

            transferTableModal.style.display = 'flex';
        }

        document.getElementById('confirm-transfer-btn').addEventListener('click', async (e) => {
            e.preventDefault();
            const newTableNumber = document.getElementById('free-tables-select').value;
            const orderIdToTransfer = currentManagingOrderId;

            if (!newTableNumber || !orderIdToTransfer || !currentManagingOrderData) {
                showCustomAlert("Erro nos dados de transferência. Tente abrir o gerenciador da mesa novamente.");
                return;
            }

            const newTableNum = parseInt(newTableNumber);

            // **CORREÇÃO:** Usar optional chaining ao acessar currentManagingOrderData.endereco
            const { id, grupoMesas, criadoEm, statusChangedAt, ...transferrableData } = currentManagingOrderData;

            const newOrderData = {
                ...transferrableData,
                status: currentManagingOrderData.status,
                endereco: {
                    ...(currentManagingOrderData.endereco ?? {}), // Usar objeto vazio se endereco for null/undefined
                    clientName: `Mesa ${newTableNum}`,
                    rua: 'Mesa'
                },
                grupoMesas: null,
                criadoEm: serverTimestamp(),
                statusChangedAt: serverTimestamp()
            };

            try {
                await updateDoc(doc(db, "pedidos", orderIdToTransfer), {
                    status: "Finalizado",
                    statusChangedAt: serverTimestamp()
                });

                 await deleteDoc(doc(db, "pedidos", orderIdToTransfer));

            } catch (error) {
                console.error("Erro ao finalizar/remover pedido antigo durante transferência:", error);
                showCustomAlert("Falha ao liberar a mesa de origem. Tente novamente.");
                return;
            }

            try {
                await addDoc(collection(db, "pedidos"), newOrderData);
            } catch (error) {
                 console.error("Erro ao criar novo pedido na transferência:", error);
                 showCustomAlert("Pedido antigo finalizado, mas falha ao criar na nova mesa. Recarregue a página.");
                 return;
            }

            showCustomAlert(`Pedido transferido com sucesso para a Mesa ${newTableNumber}`);
            transferTableModal.style.display = 'none';
            manageTableModal.style.display = 'none';
        });

        closeManageTableModalBtn.addEventListener('click', () => manageTableModal.style.display = 'none');
        document.getElementById('cancel-transfer-btn').addEventListener('click', () => transferTableModal.style.display = 'none');


        async function openEditModal(id) {
            window.open(`venda-balcao.html?orderId=${id}`, '_blank');
        }

        async function saveOrderChanges() {
            // Esta função não é mais necessária aqui, pois a lógica está em venda-balcao.html
        }

        function showDeleteConfirmation() {
            deleteConfirmModal.style.display = 'flex';
        }

        async function executeDelete() {
            if (orderIdToDelete) {
                await deleteDoc(doc(db, "pedidos", orderIdToDelete));
                deleteConfirmModal.style.display = 'none';
                orderIdToDelete = null;
            }
        }

        async function updateOrderStatus(id, newStatus) {
            const orderRef = doc(db, "pedidos", id);
            await updateDoc(orderRef, {
                status: newStatus,
                statusChangedAt: serverTimestamp()
            });
        }

        function printOrder(id, type) {
            // A lógica de impressão foi movida para uma função auxiliar para ser reutilizada
            const order = allOrdersCache.find(o => o.id === id);
            if (!order) {
                alert('Erro: Pedido não encontrado para impressão.');
                return;
            }
            printOrderContent(order, id, type);
        }

        // <!--
        // ========================================================================
        // INÍCIO DA ALTERAÇÃO - Função printOrderContent
        // ========================================================================
        //
        // Lógica da função generateItemHtml atualizada para ler
        // 1. 'item.extras' (Balcão)
        // 2. 'item.ingredients' (Cardápio Online), verificando se é burger ou pizza.
        //
        // ========================================================================
        // -->
        function printOrderContent(order, id, type) {
            // *** INÍCIO DA CORREÇÃO DE IMPRESSÃO ***
            // Estes estilos forçam a impressora térmica a usar o modo "rolo"
            // e definem a largura correta (80mm ou 58mm).
            const styles = `
                <style>
                    @media print {
                        @page { 
                            margin: 0; 
                            /* Tenta forçar 80mm, ajuste para 58mm se sua impressora for menor */
                            size: 80mm auto; 
                        } 
                        html, body {
                            /* Largura da impressora térmica */
                            width: 80mm !important; 
                            /* Altura automática para conteúdo contínuo */
                            height: auto !important; 
                            min-height: initial !important; 
                            margin: 0;
                            /* Margem interna do papel */
                            padding: 5mm; 
                            font-family: 'Courier New', Courier, monospace;
                            font-size: 10pt;
                            color: #000;
                            background-color: #fff;
                            /* Garante que nada seja cortado */
                            overflow: visible !important; 
                        }
                        * {
                            font-family: 'Courier New', Courier, monospace;
                            font-size: 10pt;
                        }
                        h1 { font-size: 14pt; font-weight: bold; text-align: center; margin-bottom: 5px;}
                        h2 { font-size: 12pt; font-weight: bold; margin-top: 10px; margin-bottom: 5px; border-bottom: 1px dashed #000; padding-bottom: 2px;}
                        p { margin: 2px 0; }
                        ul { list-style: none; padding: 0; margin: 0; }
                        li { margin-bottom: 2px; }
                        .item-line { display: flex; justify-content: space-between; }
                        .item-details { padding-left: 15px; font-size: 9pt; color: #333; }
                        .item-details strong { font-size: 9pt; color: #000; } 
                        hr { border: none; border-top: 1px dashed #000; margin: 10px 0; }
                        .text-right { text-align: right; }
                        .font-bold { font-weight: bold; }
                    }
                </style>
            `;
            // *** FIM DA CORREÇÃO DE IMPRESSÃO ***

            let printContent = '';
            // Garantir que order.itens seja um array
            const orderItems = Array.isArray(order.itens) ? order.itens : [];

            // Função helper para gerar o HTML de um item (para evitar repetição)
            const generateItemHtml = (item, includePrice = false) => {
                let itemString = '';
                
                if (includePrice) {
                    itemString = `<li class="item-line"><span>${item.name || 'Item desconhecido'}</span><span>R$${parseFloat(item.price || 0).toFixed(2).replace('.', ',')}</span></li>`;
                } else {
                    itemString = `<li><strong>1x</strong> ${item.name || 'Item desconhecido'}</li>`;
                }
                
                // --- INÍCIO DA CORREÇÃO ---
        
                // 1. Adicionais (pizzas/itens) do Balcão (campo 'extras')
                if (item.extras && item.extras.length > 0) {
                    itemString += `<ul>${item.extras.map(extra => {
                        const quantityText = (extra.quantity && extra.quantity > 1) ? ` (x${extra.quantity})` : '';
                        const placementText = extra.placement ? ` (${extra.placement})` : ''; // Lê o placement
                        return `<li class="item-details"><strong>+ ${extra.name}${quantityText}${placementText}</strong></li>`;
                    }).join('')}</ul>`;
                }
                
                // 2. Ingredientes (Burger Custom OU Adicionais de Pizza do Cardápio Online)
                if (item.ingredients && item.ingredients.length > 0) {
                    if (item.type === 'custom_burger') {
                         // Trata como ingredientes de hambúrguer (remoções)
                         itemString += `<ul>${item.ingredients.map(ing => {
                             const quantityText = (ing.quantity && ing.quantity > 1) ? ` (x${ing.quantity})` : '';
                             return `<li class="item-details"><strong>- ${ing.name}${quantityText}</strong></li>`;
                         }).join('')}</ul>`;
                    } else {
                        // Trata como adicionais de pizza (adições) - do Cardápio Online
                        itemString += `<ul>${item.ingredients.map(extra => {
                            const quantityText = (extra.quantity && extra.quantity > 1) ? ` (x${extra.quantity})` : '';
                            // AQUI ESTÁ A CORREÇÃO: Lemos o 'placement' do array 'ingredients'
                            const placementText = extra.placement ? ` (${extra.placement})` : ''; 
                            return `<li class="item-details"><strong>+ ${extra.name}${quantityText}${placementText}</strong></li>`;
                        }).join('')}</ul>`;
                    }
                }
                // --- FIM DA CORREÇÃO ---
                
                return itemString;
            };

            // Agrupar itens por categoria para AMBAS as impressões
            const itemsByCategory = orderItems.reduce((acc, item) => {
                const category = item.category || 'Outros';
                if (!acc[category]) acc[category] = [];
                acc[category].push(item);
                return acc;
            }, {});


            if (type === 'kitchen') {
                // Lógica da Cozinha (COM categorias, SEM preços)
                let kitchenHtml = '';
                for (const category in itemsByCategory) {
                    kitchenHtml += `<h2>${category.toUpperCase()}</h2><ul>`;
                    kitchenHtml += itemsByCategory[category].map(item => generateItemHtml(item, false)).join(''); // false = sem preço
                    kitchenHtml += '</ul>';
                }

                printContent = `
                    <h1>COMANDA COZINHA</h1>
                    <p><strong>Pedido:</strong> #${id.substring(0, 5)}</p>
                    <p><strong>Cliente:</strong> ${order?.endereco?.clientName || 'N/A'}</p>
                    <hr>
                    ${kitchenHtml}
                    ${order.observacao ? `<hr><h2>OBSERVAÇÕES</h2><p>${order.observacao}</p>` : ''}
                `;
            } else { // type === 'client'
                // Lógica do Cliente (COM categorias, COM preços)
                let clientItemsHtml = '';
                for (const category in itemsByCategory) {
                     clientItemsHtml += `<h2>${category.toUpperCase()}</h2><ul>`;
                     clientItemsHtml += itemsByCategory[category].map(item => generateItemHtml(item, true)).join(''); // true = com preço
                     clientItemsHtml += '</ul>';
                }

                let paymentDetailsHtml = '';
                if (order.pagamento) {
                    let paymentText = '', changeText = '';
                    const finalTotalValue = order?.total?.finalTotal ?? 0;
                    if (typeof order.pagamento === 'object' && order.pagamento.method === 'Dinheiro') {
                        paymentText = 'Dinheiro';
                        const trocoTotal = (parseFloat(order.pagamento.trocoPara || 0) - finalTotalValue);
                        changeText = `<p class="text-right">Troco p/: R$ ${parseFloat(order.pagamento.trocoPara || 0).toFixed(2).replace('.', ',')}</p>
                                    <p class="text-right">Troco: R$ ${trocoTotal.toFixed(2).replace('.', ',')}</p>`;
                    } else {
                        paymentText = order.pagamento;
                    }
                    paymentDetailsHtml = `<hr><p><strong>Pagamento: ${paymentText}</strong></p>${changeText}`;
                }

                printContent = `
                    <h1>Sâmia Pizzaria</h1>
                    <p><strong>Pedido:</strong> #${id.substring(0, 5)}</p>
                    <p><strong>Cliente:</strong> ${order?.endereco?.clientName || 'N/A'}</p>
                     ${order?.endereco?.telefone ? `<p><strong>Contato:</strong> ${order.endereco.telefone}</p>` : ''}
                    <p><strong>Endereço:</strong> ${order?.endereco?.rua || 'N/A'}, ${order?.endereco?.numero || 'S/N'} - ${order?.endereco?.bairro || 'N/A'}</p>
                    <hr>
                    ${clientItemsHtml}
                    <hr>
                    <div class="text-right">
                        <p>Subtotal: R$ ${parseFloat(order?.total?.subtotal || 0).toFixed(2).replace('.', ',')}</p>
                        ${(order?.total?.discount ?? 0) > 0 ? `<p>Desconto: -R$ ${parseFloat(order.total.discount).toFixed(2).replace('.', ',')}</p>` : ''}
                        <p>Taxa Entrega: R$ ${parseFloat(order?.total?.deliveryFee || 0).toFixed(2).replace('.', ',')}</p>
                        <p class="font-bold">Total: R$ ${parseFloat(order?.total?.finalTotal || 0).toFixed(2).replace('.', ',')}</p>
                    </div>
                     ${order.observacao ? `<hr><h2>OBSERVAÇÕES</h2><p>${order.observacao}</p>` : ''}
                     ${paymentDetailsHtml}
                `;
            }

            // NOVA LÓGICA DE IMPRESSÃO (Substitui o iframe)
            const printWindow = window.open('', '_blank', 'width=800,height=600');
            if (!printWindow) {
                showCustomAlert("Não foi possível abrir a janela de impressão. Verifique se o seu navegador está bloqueando pop-ups.");
                return;
            }
            
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Imprimir Pedido ${id.substring(0, 5)}</title>
                        ${styles}
                    </head>
                    <body>
                        ${printContent}
                    </body>
                </html>
            `);
            
            printWindow.document.close();
            
            // Espera o conteúdo ser totalmente carregado na nova janela
            printWindow.onload = function() {
                printWindow.focus(); // Foca na janela
                printWindow.print(); // Abre a caixa de diálogo de impressão
                printWindow.close(); // Fecha a janela após imprimir (ou cancelar)
            };

            // Fallback caso o onload não dispare (comum em alguns navegadores)
            setTimeout(() => {
                if (!printWindow.closed) {
                    printWindow.focus();
                    printWindow.print();
                    printWindow.close();
                }
            }, 500);
        }
        // <!--
        // ========================================================================
        // FIM DA ALTERAÇÃO
        // ========================================================================
        // -->

        async function openCloseCashModal() {
            if (!currentCashRegister) {
                showCustomAlert("Nenhum caixa aberto para fechar.");
                return;
            }

            try {
                const deliveredOrdersQuery = query(collection(db, "pedidos"), where("status", "in", ["Entregue", "Fechado"]));
                const querySnapshot = await getDocs(deliveredOrdersQuery);
                let totalCash = 0, totalCard = 0, totalPix = 0;
                let totalDelivery = 0, totalRetirada = 0, totalMesas = 0, totalDeliveryFees = 0;

                const openingTime = currentCashRegister.dataAbertura.toDate();

                const updatedCashRegisterSnap = await getDoc(doc(db, "caixas", currentCashRegister.id));
                const updatedCashRegisterData = updatedCashRegisterSnap.data();
                const sangrias = updatedCashRegisterData.sangrias || [];
                const totalSangrias = sangrias.reduce((sum, s) => sum + s.amount, 0);

                querySnapshot.forEach(doc => {
                    const order = doc.data();
                    const orderDate = order.criadoEm ? order.criadoEm.toDate() : new Date();

                    if (orderDate >= openingTime) {
                        // **CORREÇÃO:** Usar optional chaining e valores padrão
                        const finalTotal = parseFloat(order?.total?.finalTotal || 0);
                        const subtotal = parseFloat(order?.total?.subtotal || 0);
                        const discount = parseFloat(order?.total?.discount || 0);
                        const payment = order.pagamento;

                        if ((typeof payment === 'object' && payment.method === 'Dinheiro') || payment === 'Dinheiro') {
                            totalCash += finalTotal;
                        } else if (payment === 'Cartão de Crédito/Débito') {
                            totalCard += finalTotal;
                        } else if (payment === 'Pix') {
                            totalPix += finalTotal;
                        }

                        const orderType = identifyOrderType(order);
                        if (orderType === 'delivery') {
                            totalDelivery += (subtotal - discount);
                            totalDeliveryFees += parseFloat(order?.total?.deliveryFee || 0);
                        } else if (orderType === 'retirada') {
                            totalRetirada += finalTotal;
                        } else if (orderType === 'mesa') {
                            totalMesas += finalTotal;
                        }
                    }
                });

                const totalSales = totalDelivery + totalRetirada + totalMesas + totalDeliveryFees;
                 // **CORREÇÃO:** Valor inicial pode ser 0
                const initialValue = parseFloat(currentCashRegister.valorInicial || 0);
                const expectedInCaixaTotal = initialValue + totalSales - totalSangrias; // Valor total esperado (Dinheiro + Cartão + Pix)
                // REMOVIDA A LÓGICA expectedOnlyCash
                const sangriaDetails = sangrias.map(s => `${s.reason}: R$${s.amount.toFixed(2).replace('.',',')}`).join('; ');

                detailedReportData = { totalDelivery, totalRetirada, totalMesas, totalDeliveryFees, totalCash, totalCard, totalPix, totalSales, totalSangrias, sangriaDetails }; // Removido o expectedOnlyCash

                document.getElementById('summary-initial').textContent = `R$ ${initialValue.toFixed(2).replace('.', ',')}`;
                document.getElementById('summary-delivery').textContent = `R$ ${totalDelivery.toFixed(2).replace('.', ',')}`;
                document.getElementById('summary-retirada').textContent = `R$ ${totalRetirada.toFixed(2).replace('.', ',')}`;
                document.getElementById('summary-mesas').textContent = `R$ ${totalMesas.toFixed(2).replace('.', ',')}`;
                document.getElementById('summary-delivery-fees').textContent = `R$ ${totalDeliveryFees.toFixed(2).replace('.', ',')}`;
                document.getElementById('summary-cash').textContent = `R$ ${totalCash.toFixed(2).replace('.', ',')}`;
                document.getElementById('summary-card').textContent = `R$ ${totalCard.toFixed(2).replace('.', ',')}`;
                document.getElementById('summary-pix').textContent = `R$ ${totalPix.toFixed(2).replace('.', ',')}`;
                document.getElementById('summary-total-sales').textContent = `R$ ${totalSales.toFixed(2).replace('.', ',')}`;
                document.getElementById('summary-sangrias').textContent = `- R$ ${totalSangrias.toFixed(2).replace('.', ',')}`;
                document.getElementById('summary-expected').textContent = `R$ ${expectedInCaixaTotal.toFixed(2).replace('.', ',')}`; // Mostra o esperado total (como solicitado)

                closeCashModal.style.display = 'flex';
            } catch (error) {
                console.error("Erro ao abrir modal de fechamento de caixa:", error);
                alert("Falha ao calcular totais do caixa: " + error.message);
            }
        }


        function printCashClosure() {
            // *** INÍCIO DA CORREÇÃO DE IMPRESSÃO ***
            const styles = `
                <style>
                    @media print {
                        @page { 
                            margin: 0; 
                            size: 80mm auto; /* Força 80mm */
                        } 
                        html, body {
                            width: 80mm !important;
                            height: auto !important;
                            min-height: initial !important;
                            margin: 0;
                            padding: 5mm;
                            font-family: 'Courier New', Courier, monospace;
                            font-size: 10pt;
                            color: #000;
                            background-color: #fff;
                            overflow: visible !important;
                        }
                        * {
                            font-family: 'Courier New', Courier, monospace;
                            font-size: 10pt;
                        }
                        h1 { font-size: 14pt; font-weight: bold; text-align: center; margin-bottom: 10px;}
                        h2 { font-size: 12pt; font-weight: bold; margin-top: 10px; margin-bottom: 5px; border-bottom: 1px dashed #000; padding-bottom: 2px;}
                        .line { display: flex; justify-content: space-between; margin: 2px 0; }
                        .sub-line { padding-left: 15px; }
                        hr { border: none; border-top: 1px dashed #000; margin: 10px 0; }
                        .font-bold { font-weight: bold; }
                    }
                </style>
            `;
            // *** FIM DA CORREÇÃO DE IMPRESSÃO ***

            const initial = document.getElementById('summary-initial').textContent;
            const delivery = document.getElementById('summary-delivery').textContent;
            const retirada = document.getElementById('summary-retirada').textContent;
            const mesas = document.getElementById('summary-mesas').textContent;
            const deliveryFees = document.getElementById('summary-delivery-fees').textContent;
            const cash = document.getElementById('summary-cash').textContent;
            const card = document.getElementById('summary-card').textContent;
            const pix = document.getElementById('summary-pix').textContent;
            const totalSales = document.getElementById('summary-total-sales').textContent;
            const sangrias = document.getElementById('summary-sangrias').textContent;
            const expected = document.getElementById('summary-expected').textContent;
            const finalValue = document.getElementById('final-value').value;
            const difference = document.getElementById('summary-difference').textContent;

            const printContent = `
                <h1>Fechamento de Caixa</h1>
                <p><strong>Usuário:</strong> ${auth.currentUser.email}</p>
                <p><strong>Data:</strong> ${new Date().toLocaleString('pt-BR')}</p>
                <hr>
                <div class="line"><span>Valor Inicial:</span><span>${initial}</span></div>
                <hr>
                <h2>VENDAS POR TIPO</h2>
                <div class="line sub-line"><span>Delivery:</span><span>${delivery}</span></div>
                <div class="line sub-line"><span>Retirada:</span><span>${retirada}</span></div>
                <div class="line sub-line"><span>Mesas:</span><span>${mesas}</span></div>
                <div class="line sub-line"><span>Taxas de Entrega:</span><span>${deliveryFees}</span></div>
                <hr>
                <h2>VENDAS POR PAGAMENTO</h2>
                <div class="line sub-line"><span>Dinheiro:</span><span>${cash}</span></div>
                <div class="line sub-line"><span>Cartão:</span><span>${card}</span></div>
                <div class="line sub-line"><span>Pix:</span><span>${pix}</span></div>
                <hr>
                <div class="line font-bold"><span>TOTAL DE VENDAS:</span><span>${totalSales}</span></div>
                <div class="line"><span>Total Sangrias:</span><span>${sangrias}</span></div>
                <hr>
                <!-- ALTERAÇÃO FEITA AQUI -->
                <div class="line font-bold"><span>ESPERADO EM CAIXA:</span><span>${expected}</span></div>
                <div class="line"><span>Valor Contado:</span><span>R$ ${parseFloat(finalValue || 0).toFixed(2).replace('.',',')}</span></div>
                <div class="line font-bold"><span>DIFERENÇA:</span><span>${difference}</span></div>
            `;

            // Lógica de impressão com window.open()
            const printWindow = window.open('', '_blank', 'width=800,height=600');
            if (!printWindow) {
                showCustomAlert("Não foi possível abrir a janela de impressão. Verifique se o seu navegador está bloqueando pop-ups.");
                return;
            }
            printWindow.document.write(`<html><head><title>Fechamento de Caixa</title>${styles}</head><body>${printContent}</body></html>`);
            printWindow.document.close();
            printWindow.onload = function() {
                printWindow.focus();
                printWindow.print();
                printWindow.close();
            };
            setTimeout(() => {
                if (!printWindow.closed) {
                    printWindow.focus();
                    printWindow.print();
                    printWindow.close();
                }
            }, 500);
        }

        document.querySelector('main').addEventListener('click', function(e) {
            const card = e.target.closest('.order-card');
            if (card) {
                const newTag = card.querySelector('.new-order-tag');
                if (newTag) {
                    newTag.remove();
                }
            }

            const moveBtn = e.target.closest('.move-btn');
            const manageBtn = e.target.closest('.manage-btn');
            const printBtn = e.target.closest('.print-btn');
            const archiveBtn = e.target.closest('.archive-btn');
            const deleteBtn = e.target.closest('.delete-btn');
            const whatsappBtn = e.target.closest('.whatsapp-btn');
            const cardHeader = e.target.closest('.card-header');

            if (moveBtn) updateOrderStatus(moveBtn.dataset.id, moveBtn.dataset.status);
            if (manageBtn) window.open(`venda-balcao.html?orderId=${manageBtn.dataset.id}`, '_blank');
            if (printBtn) printOrder(printBtn.dataset.id, printBtn.dataset.type);
            if (archiveBtn) handleArchiveOrder(archiveBtn.dataset.id);
            if (deleteBtn) {
                orderIdToDelete = deleteBtn.dataset.id;
                showDeleteConfirmation();
            }
            if(whatsappBtn) {
                openWhatsappConfirmModal(whatsappBtn.dataset.id);
            }
            if (cardHeader && !e.target.closest('button, a')) {
                cardHeader.closest('.order-card').classList.toggle('expanded');
            }
        });

        cancelDeleteBtn.addEventListener('click', () => deleteConfirmModal.style.display = 'none');
        confirmDeleteBtn.addEventListener('click', executeDelete);

        resolvePendingBtn.addEventListener('click', () => {
            openCashModal.style.display = 'none';
            openCloseCashModal();
        });

        closeCashRegisterBtn.addEventListener('click', openCloseCashModal);
        cancelCloseCashBtn.addEventListener('click', () => closeCashModal.style.display = 'none');
        document.getElementById('print-cash-closure-btn').addEventListener('click', printCashClosure);

        finalValueInput.addEventListener('input', () => {
            const finalValue = parseFloat(finalValueInput.value);
            // ALTERAÇÃO: Comparar com o valor total exibido (summary-expected)
            const expectedValueText = document.getElementById('summary-expected').textContent;
            if (!expectedValueText) return;

            const expectedValue = parseFloat(expectedValueText.replace('R$ ', '').replace(/\./g, '').replace(',', '.'));

            const differenceSection = document.getElementById('summary-difference-section');
            const differenceEl = document.getElementById('summary-difference');

            if (isNaN(finalValue)) {
                differenceSection.classList.add('hidden');
                return;
            }

            const difference = finalValue - expectedValue;

            differenceSection.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'bg-gray-100', 'text-gray-800');

            if (difference > 0) {
                differenceSection.classList.add('bg-green-100', 'text-green-800');
                differenceEl.textContent = `SOBRA: R$ ${difference.toFixed(2).replace('.', ',')}`;
            } else if (difference < 0) {
                differenceSection.classList.add('bg-red-100', 'text-red-800');
                differenceEl.textContent = `FALTA: R$ ${Math.abs(difference).toFixed(2).replace('.', ',')}`;
            } else {
                differenceSection.classList.add('bg-gray-100', 'text-gray-800');
                differenceEl.textContent = 'VALORES BATEM: R$ 0,00';
            }
        });

        closeCashForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const pendingDeliveryColumns = [
                'col-delivery-novo', 'col-delivery-preparo', 'col-delivery-pronto', 'col-delivery-entrega',
                'col-retirada-novo', 'col-retirada-preparo', 'col-retirada-pronto'
            ];
            const hasPendingDeliveryOrders = pendingDeliveryColumns.some(colId => {
                const column = document.getElementById(colId);
                return column && column.querySelector('.order-card');
            });

            const hasPendingTableOrders = Array.from(document.querySelectorAll('#mesas-grid .mesa-item')).some(mesa =>
                mesa.dataset.status === 'ocupada' || mesa.dataset.status === 'juntada'
            );

            if (hasPendingDeliveryOrders || hasPendingTableOrders) {
                showCustomAlert('Não é possível fechar o caixa. Ainda existem pedidos ou mesas em aberto. Finalize todos os pedidos antes de continuar.');
                return;
            }

            const finalValue = parseFloat(finalValueInput.value);
            if (isNaN(finalValue) || finalValue < 0) {
                alert("Por favor, insira um valor válido.");
                return;
            }

            const cashRegisterRef = doc(db, "caixas", currentCashRegister.id);
            // ALTERAÇÃO: Usar o valor total (summary-expected) para calcular a diferença correta
            const expectedValue = parseFloat(document.getElementById('summary-expected').textContent.replace('R$ ', '').replace(/\./g, '').replace(',', '.'));

            try {
                const dataToSaveInFirestore = {
                    status: 'fechado',
                    dataFechamento: serverTimestamp(),
                    usuarioFechamento: auth.currentUser.email,
                    valorFinalContado: finalValue,
                    diferenca: finalValue - expectedValue,
                    totalVendas: detailedReportData.totalSales,
                    totalVendasDelivery: detailedReportData.totalDelivery,
                    totalVendasRetirada: detailedReportData.totalRetirada,
                    totalVendasMesas: detailedReportData.totalMesas,
                    totalTaxasEntrega: detailedReportData.totalDeliveryFees,
                    totalDinheiro: detailedReportData.totalCash,
                    totalCartao: detailedReportData.totalCard,
                    totalPix: detailedReportData.totalPix,
                    totalSangrias: detailedReportData.totalSangrias,
                };

                await updateDoc(cashRegisterRef, dataToSaveInFirestore);
                alert("Caixa fechado com sucesso!");

                const confirmCloseBtn = document.getElementById('confirm-close-cash-btn');
                confirmCloseBtn.disabled = true;
                confirmCloseBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Arquivando Pedidos...';

                try {
                    const ordersToArchiveQuery = query(collection(db, "pedidos"), where("status", "in", ["Entregue", "Fechado"]));
                    const querySnapshot = await getDocs(ordersToArchiveQuery);

                    const archivePromises = [];
                    querySnapshot.forEach((doc) => {
                        archivePromises.push(handleArchiveOrder(doc.id));
                    });

                    await Promise.all(archivePromises);
                } catch (archiveError) {
                    console.error("Ocorreu um erro ao tentar arquivar os pedidos automaticamente:", archiveError);
                    alert("O caixa foi fechado, mas ocorreu um erro ao arquivar os pedidos. Verifique o console.");
                } finally {
                     confirmCloseBtn.disabled = false;
                     confirmCloseBtn.textContent = 'Confirmar Fechamento';
                }

                const dataToArchive = {
                    ...detailedReportData,
                    id: currentCashRegister.id,
                    dataAbertura: currentCashRegister.dataAbertura.toDate(),
                    usuarioAbertura: currentCashRegister.usuarioAbertura,
                    valorInicial: currentCashRegister.valorInicial,
                    usuarioFechamento: auth.currentUser.email,
                    valorFinalContado: finalValue,
                    diferenca: finalValue - expectedValue,
                    sangrias: detailedReportData.sangriaDetails
                };

                fetch('/api/arquivar-fechamento', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cashRegisterData: dataToArchive })
                }).then(res => res.json()).then(data => {
                    if (data.success) {
                        console.log("Fechamento de caixa arquivado na planilha com sucesso.");
                    } else {
                        console.error("Falha ao arquivar fechamento na planilha:", data.error);
                        alert("O caixa foi fechado no sistema, mas houve uma falha ao salvar na planilha. Verifique o console de logs.");
                    }
                }).catch(err => {
                    console.error("Erro de rede ao arquivar fechamento:", err);
                     alert("O caixa foi fechado no sistema, mas houve uma falha de rede ao salvar na planilha.");
                });

                closeCashModal.style.display = 'none';
                closeCashForm.reset();
                document.getElementById('summary-difference-section').classList.add('hidden');
                checkCashRegisterStatus();

            } catch (error) {
                console.error("Erro ao fechar o caixa:", error);
                alert("Não foi possível fechar o caixa. Tente novamente.");
            }
        });

        function toggleJoinMode(enable) {
            isJoiningTables = enable;
            mesasGrid.classList.toggle('joining-mode', enable);
            joinTablesBtn.classList.toggle('hidden', enable);
            joiningControls.classList.toggle('hidden', !enable);

            if (!enable) {
                selectedTablesForJoining = [];
                document.querySelectorAll('.mesa-item.selected-for-join').forEach(el => {
                    el.classList.remove('selected-for-join');
                });
            }
        }

        joinTablesBtn.addEventListener('click', () => toggleJoinMode(true));
        cancelJoinBtn.addEventListener('click', () => toggleJoinMode(false));
        confirmJoinBtn.addEventListener('click', async () => {
            if (selectedTablesForJoining.length < 2) {
                showCustomAlert("Selecione pelo menos duas mesas para juntar.");
                return;
            }
            const sortedTables = selectedTablesForJoining.sort((a, b) => a - b);

            const clientName = `Mesas ${sortedTables.join(' + ')}`;

            const newOrder = {
                itens: [],
                endereco: { clientName: clientName, rua: "Mesa" },
                total: { subtotal: 0, finalTotal: 0, deliveryFee: 0, discount: 0 },
                pagamento: 'A Definir',
                status: 'Novo',
                criadoEm: serverTimestamp(),
                statusChangedAt: serverTimestamp(),
                observacao: '',
                grupoMesas: sortedTables
            };

            try {
                confirmJoinBtn.disabled = true;
                confirmJoinBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                await addDoc(collection(db, "pedidos"), newOrder);
                showCustomAlert(`Mesas ${sortedTables.join(' e ')} agrupadas. Clique no grupo para adicionar itens.`);
            } catch (error) {
                console.error("Erro ao agrupar mesas:", error);
                showCustomAlert("Não foi possível agrupar as mesas. Tente novamente.");
            } finally {
                confirmJoinBtn.disabled = false;
                confirmJoinBtn.innerHTML = 'Confirmar Agrupamento';
                toggleJoinMode(false);
            }
        });

        closeManageTableModalBtn.addEventListener('click', () => manageTableModal.style.display = 'none');
        document.getElementById('cancel-transfer-btn').addEventListener('click', () => transferTableModal.style.display = 'none');


        document.getElementById('confirm-transfer-btn').addEventListener('click', async (e) => {
            e.preventDefault();
            const newTableNumber = document.getElementById('free-tables-select').value;
            const orderIdToTransfer = currentManagingOrderId;

            if (!newTableNumber || !orderIdToTransfer || !currentManagingOrderData) {
                showCustomAlert("Erro nos dados de transferência. Tente abrir o gerenciador da mesa novamente.");
                return;
            }

            const newTableNum = parseInt(newTableNumber);

            const { id, grupoMesas, criadoEm, statusChangedAt, ...transferrableData } = currentManagingOrderData;

            const newOrderData = {
                ...transferrableData,
                status: currentManagingOrderData.status,
                endereco: {
                    ...(currentManagingOrderData.endereco ?? {}),
                    clientName: `Mesa ${newTableNum}`,
                    rua: 'Mesa'
                },
                grupoMesas: null,
                criadoEm: serverTimestamp(),
                statusChangedAt: serverTimestamp()
            };

            try {
                await updateDoc(doc(db, "pedidos", orderIdToTransfer), {
                    status: "Finalizado",
                    statusChangedAt: serverTimestamp()
                });

                 await deleteDoc(doc(db, "pedidos", orderIdToTransfer));

            } catch (error) {
                console.error("Erro ao finalizar/remover pedido antigo durante transferência:", error);
                showCustomAlert("Falha ao liberar a mesa de origem. Tente novamente.");
                return;
            }

            try {
                await addDoc(collection(db, "pedidos"), newOrderData);
            } catch (error) {
                 console.error("Erro ao criar novo pedido na transferência:", error);
                 showCustomAlert("Pedido antigo finalizado, mas falha ao criar na nova mesa. Recarregue a página.");
                 return;
            }


            showCustomAlert(`Pedido transferido com sucesso para a Mesa ${newTableNumber}`);
            transferTableModal.style.display = 'none';
            manageTableModal.style.display = 'none';
        });


        const sangriaModal = document.getElementById('sangria-modal');
        const sangriaForm = document.getElementById('sangria-form');

        document.getElementById('close-cash-modal').addEventListener('click', (e) => {
            if (e.target.id === 'register-sangria-btn') {
                 if (!currentCashRegister) {
                    alert("É necessário ter um caixa aberto para registrar uma sangria.");
                    return;
                }
                sangriaForm.reset();
                sangriaModal.style.display = 'flex';
            }
        });

        document.getElementById('cancel-sangria-btn').addEventListener('click', () => {
            sangriaModal.style.display = 'none';
        });

        sangriaForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('sangria-amount').value);
            const reason = document.getElementById('sangria-reason').value.trim();

            if (isNaN(amount) || amount <= 0) {
                alert("Por favor, insira um valor válido para a sangria.");
                return;
            }
            if (!reason) {
                alert("O motivo da sangria é obrigatório.");
                return;
            }

            const confirmBtn = document.getElementById('confirm-sangria-btn');
            confirmBtn.disabled = true;
            confirmBtn.textContent = 'Registrando...';

            try {
                const response = await fetch('/api/registrar-sangria', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        amount,
                        reason,
                        userEmail: auth.currentUser.email,
                        cashRegisterId: currentCashRegister.id
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Falha ao registrar sangria.');
                }

                alert("Sangria registrada com sucesso!");
                sangriaModal.style.display = 'none';
                if (closeCashModal.style.display === 'flex') {
                    openCloseCashModal();
                }

            } catch (error) {
                console.error("Erro ao registrar sangria:", error);
                alert(`Erro: ${error.message}`);
            } finally {
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Confirmar Sangria';
            }
        });

        function setupCustomAlertModal() {
            const modal = document.getElementById('custom-alert-modal');
            const okBtn = document.getElementById('ok-alert-modal');

            const closeModal = () => modal.style.display = 'none';

            modal.addEventListener('click', (e) => {
                if (e.target === modal || e.target.closest('#ok-alert-modal')) closeModal();
            });
        }

        function showCustomAlert(message) {
            document.getElementById('custom-alert-message').textContent = message;
            document.getElementById('custom-alert-modal').style.display = 'flex';
        }

        function showConfirm(message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('delete-confirm-modal');
                const titleEl = modal.querySelector('h3');
                const messageEl = modal.querySelector('p');
                const yesBtn = modal.querySelector('#confirm-delete-btn');
                const noBtn = modal.querySelector('#cancel-delete-btn');

                const originalTitle = titleEl.textContent;
                const originalYesText = yesBtn.textContent;
                const originalYesClasses = Array.from(yesBtn.classList);

                titleEl.textContent = "Confirmar Ação";
                messageEl.textContent = message;
                yesBtn.textContent = "Sim, Confirmar";
                yesBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                yesBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');

                modal.style.display = 'flex';

                const cleanup = (result) => {
                    modal.style.display = 'none';
                    titleEl.textContent = originalTitle;
                    yesBtn.textContent = originalYesText;
                    yesBtn.className = originalYesClasses.join(' ');

                    yesBtn.removeEventListener('click', yesHandler);
                    noBtn.removeEventListener('click', noHandler);
                    modal.removeEventListener('click', modalCloseHandler);
                    resolve(result);
                };

                const yesHandler = () => cleanup(true);
                const noHandler = () => cleanup(false);
                const modalCloseHandler = (e) => {
                    if (e.target === modal) {
                        cleanup(false);
                    }
                };

                yesBtn.addEventListener('click', yesHandler, { once: true });
                noBtn.addEventListener('click', noHandler, { once: true });
                modal.addEventListener('click', modalCloseHandler);
            });
        }

        function openTablePaymentModal(orderId, total) {
            orderIdForPaymentUpdate = orderId;
            document.getElementById('table-payment-total').textContent = `R$ ${total.toFixed(2).replace(',', '.')}`;

            document.querySelectorAll('input[name="table-payment"]').forEach(radio => radio.checked = false);
            document.getElementById('table-troco-container').classList.add('hidden');
            document.getElementById('table-trocoPara').value = '';
            document.getElementById('table-troco-total').textContent = 'R$ 0,00';

            document.getElementById('table-payment-modal').style.display = 'flex';
        }

        const tablePaymentModal = document.getElementById('table-payment-modal');
        const cancelTablePaymentBtn = document.getElementById('cancel-table-payment-btn');
        const confirmTablePaymentBtn = document.getElementById('confirm-table-payment-btn');
        const tableTrocoContainer = document.getElementById('table-troco-container');
        const tableTrocoParaInput = document.getElementById('table-trocoPara');

        document.getElementById('table-payment-options').addEventListener('change', (e) => {
            if (e.target.value === 'Dinheiro') {
                tableTrocoContainer.classList.remove('hidden');
            } else {
                tableTrocoContainer.classList.add('hidden');
            }
        });

        tableTrocoParaInput.addEventListener('input', () => {
            const total = parseFloat(document.getElementById('table-payment-total').textContent.replace('R$ ', '').replace(',', '.'));
            const trocoPara = parseFloat(tableTrocoParaInput.value) || 0;
            const trocoTotal = trocoPara > total ? trocoPara - total : 0;
            document.getElementById('table-troco-total').textContent = `R$ ${trocoTotal.toFixed(2).replace('.', ',')}`;
        });

        cancelTablePaymentBtn.addEventListener('click', () => {
            tablePaymentModal.style.display = 'none';
        });

        confirmTablePaymentBtn.addEventListener('click', async () => {
            const selectedPayment = document.querySelector('input[name="table-payment"]:checked');
            if (!selectedPayment) {
                showCustomAlert("Por favor, selecione uma forma de pagamento.");
                return;
            }

            let paymentData = selectedPayment.value;

            if (paymentData === 'Dinheiro') {
                const total = parseFloat(document.getElementById('table-payment-total').textContent.replace('R$ ', '').replace(',', '.'));
                const trocoPara = parseFloat(tableTrocoParaInput.value) || 0;
                if (trocoPara > 0 && trocoPara < total) {
                    showCustomAlert("O valor para troco não pode ser menor que o total do pedido.");
                    return;
                }
                paymentData = {
                    method: 'Dinheiro',
                    trocoPara: trocoPara,
                    trocoTotal: trocoPara > total ? trocoPara - total : 0
                };
            }

            if (orderIdForPaymentUpdate) {
                try {
                    confirmTablePaymentBtn.disabled = true;
                    confirmTablePaymentBtn.textContent = 'Salvando...';

                    const orderRef = doc(db, "pedidos", orderIdForPaymentUpdate);
                    await updateDoc(orderRef, { pagamento: paymentData });
                    await updateOrderStatus(orderIdForPaymentUpdate, 'Fechado');

                    tablePaymentModal.style.display = 'none';
                    manageTableModal.style.display = 'none';
                    orderIdForPaymentUpdate = null;

                } catch (error) {
                    console.error("Erro ao atualizar pagamento e fechar conta:", error);
                    showCustomAlert("Falha ao atualizar o pedido. Tente novamente.");
                } finally {
                    confirmTablePaymentBtn.disabled = false;
                    confirmTablePaymentBtn.textContent = 'Confirmar e Fechar';
                }
            }
        });

        // NOVO: Lógica do modal de confirmação do WhatsApp
        const whatsappConfirmModal = document.getElementById('whatsapp-confirm-modal');
        const closeWhatsappModalBtn = document.getElementById('close-whatsapp-modal-btn');
        let qrCodeInstance = null;

        function formatWhatsappMessage(order) {
            // **CORREÇÃO:** Usar optional chaining e valores padrão
            const itemsText = (Array.isArray(order.itens) ? order.itens : []).map(item => {
                let itemString = `  • ${item.name || 'Item'}: R$ ${parseFloat(item.price || 0).toFixed(2).replace('.', ',')}`;
                
                // <!--
                // ========================================================================
                // INÍCIO DA ALTERAÇÃO - formatWhatsappMessage
                // ========================================================================
                //
                // Aplicada a mesma lógica de 'extras' e 'ingredients' para a
                // mensagem do WhatsApp, garantindo que o 'placement' seja lido de AMBOS.
                //
                // ========================================================================
                // -->
                
                // 1. Pega adicionais (pizzas/itens) do Balcão (campo 'extras')
                if (item.extras && item.extras.length > 0) {
                    itemString += '\n' + item.extras.map(extra => {
                        const quantityText = (extra.quantity && extra.quantity > 1) ? ` (x${extra.quantity})` : '';
                        const placementText = extra.placement ? ` (${extra.placement})` : '';
                        return `    *+ ${extra.name}${quantityText}${placementText}*`;
                    }).join('\n');
                }
                
                // 2. Pega ingredientes (Burger Custom OU Adicionais de Pizza do Cardápio Online)
                if (item.ingredients && item.ingredients.length > 0) {
                    if (item.type === 'custom_burger') {
                         // Trata como ingredientes de hambúrguer (remoções)
                         itemString += '\n' + item.ingredients.map(ing => {
                             const quantityText = (ing.quantity && ing.quantity > 1) ? ` (x${ing.quantity})` : '';
                             return `    *- ${ing.name}${quantityText}*`;
                         }).join('\n');
                    } else {
                        // Trata como adicionais de pizza (adições) - do Cardápio Online (campo 'ingredients')
                        itemString += '\n' + item.ingredients.map(extra => {
                            const quantityText = (extra.quantity && extra.quantity > 1) ? ` (x${extra.quantity})` : '';
                            const placementText = extra.placement ? ` (${extra.placement})` : ''; // CORREÇÃO: Lê o placement aqui também
                            return `    *+ ${extra.name}${quantityText}${placementText}*`;
                        }).join('\n');
                    }
                }
                // <!--
                // ========================================================================
                // FIM DA ALTERAÇÃO - formatWhatsappMessage
                // ========================================================================
                // -->
                
                return itemString;
            }).join('\n');

            let paymentText = 'A definir';
            if (order.pagamento) {
                 if (typeof order.pagamento === 'object' && order.pagamento.method === 'Dinheiro') {
                    paymentText = `Pagamento: *Dinheiro*\n  Troco para: *R$ ${parseFloat(order.pagamento.trocoPara || 0).toFixed(2).replace('.', ',')}*`;
                } else {
                    paymentText = `Pagamento: *${order.pagamento}*`;
                }
            }

            // **CORREÇÃO:** Usar optional chaining e valores padrão
            const addressText = (order?.endereco?.rua === "Retirada no Balcão" || order?.endereco?.rua === "Mesa")
                ? `${order.endereco.rua}`
                : `${order?.endereco?.rua || 'Rua ?'}, ${order?.endereco?.numero || 'S/N'} - ${order?.endereco?.bairro || 'Bairro ?'}`;

            const fullMessage = `
Olá, *${order?.endereco?.clientName || 'Cliente'}*! 👋
Confirmando seu pedido na Sâmia Pizzaria:

*-- SEU PEDIDO --*
${itemsText}
------------------------------------
Subtotal: R$ ${parseFloat(order?.total?.subtotal || 0).toFixed(2).replace('.', ',')}
Taxa de Entrega: R$ ${parseFloat(order?.total?.deliveryFee || 0).toFixed(2).replace('.', ',')}
*Total: R$ ${parseFloat(order?.total?.finalTotal || 0).toFixed(2).replace('.', ',')}*

${paymentText}

*Endereço:*
${addressText}

Seu pedido já está sendo preparado! 😊
`.trim().replace(/\n\s*\n/g, '\n'); // Remove linhas em branco extras

            return fullMessage;
        }


        function openWhatsappConfirmModal(orderId) {
            const order = allOrdersCache.find(o => o.id === orderId);
             // **CORREÇÃO:** Tratar caso onde order ou endereco ou telefone não existem
            if (!order || !order.endereco || !order.endereco.telefone) {
                showCustomAlert('Este pedido não possui um número de telefone para contato.');
                return;
            }

            const message = formatWhatsappMessage(order);
            const phoneNumber = `55${order.endereco.telefone.replace(/\D/g, '')}`;
            const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;

            const qrcodeContainer = document.getElementById('qrcode-container');
            const link = document.getElementById('whatsapp-confirm-link');

            qrcodeContainer.innerHTML = '';
            if (qrCodeInstance) {
                qrCodeInstance.clear();
            }
            qrCodeInstance = new QRCode(qrcodeContainer, {
                text: whatsappUrl,
                width: 200,
                height: 200
            });

            link.href = whatsappUrl;
            whatsappConfirmModal.style.display = 'flex';
        }

        closeWhatsappModalBtn.addEventListener('click', () => {
            whatsappConfirmModal.style.display = 'none';
        });


    </script>
</body>
</html>
