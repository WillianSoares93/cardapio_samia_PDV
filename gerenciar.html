<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Disponibilidade - Sâmia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="https://raw.githubusercontent.com/WillianSoares93/cardapio_samia/refs/heads/main/logo.png" type="image/png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f3f4f6;
            visibility: hidden; /* Esconde o corpo até a autenticação ser verificada */
        }
        .tab-btn {
            transition: all 0.2s ease-in-out;
            border-bottom: 4px solid transparent;
        }
        .tab-btn.active {
            border-bottom-color: #ef4444; /* Red color for the active tab */
            color: #1f2937;
        }
        .filter-btn {
            transition: all 0.2s ease-in-out;
        }
        .filter-btn.active {
            background-color: #ef4444;
            color: white;
        }
        .availability-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 8px;
            background-color: #ffffff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .availability-row:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .search-container {
            position: sticky;
            top: 0;
            z-index: 50;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .availability-row-text-container {
            flex-grow: 1;
        }
        /* Custom switch for availability */
        .switch {
          position: relative;
          display: inline-block;
          width: 48px;
          height: 28px;
        }

        .switch input {
          opacity: 0;
          width: 0;
          height: 0;
        }

        .slider {
          position: absolute;
          cursor: pointer;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-color: #ccc;
          transition: .4s;
          border-radius: 28px;
        }

        .slider:before {
          position: absolute;
          content: "";
          height: 20px;
          width: 20px;
          left: 4px;
          bottom: 4px;
          background-color: white;
          transition: .4s;
          border-radius: 50%;
        }

        input:checked + .slider {
          background-color: #ef4444;
        }

        input:focus + .slider {
          box-shadow: 0 0 1px #ef4444;
        }

        input:checked + .slider:before {
          transform: translateX(20px);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div id="loading-overlay" class="loading-overlay">
        <i class="fas fa-spinner fa-spin text-red-500 text-4xl"></i>
    </div>

    <div class="max-w-4xl mx-auto py-8 px-4">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Gerenciar Cardápio</h1>
            <button id="logout-btn" class="text-red-500 hover:text-red-700 transition duration-200">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>

        <div class="bg-white p-4 rounded-lg shadow-md mb-6">
            <div class="flex space-x-2 border-b border-gray-200">
                <button id="pizzas-tab" class="tab-btn active px-4 py-2 text-gray-500 font-medium">Pizzas</button>
                <button id="burgers-tab" class="tab-btn px-4 py-2 text-gray-500 font-medium">Hambúrgueres</button>
                <button id="bebidas-tab" class="tab-btn px-4 py-2 text-gray-500 font-medium">Bebidas</button>
                <button id="porcoes-tab" class="tab-btn px-4 py-2 text-gray-500 font-medium">Porções</button>
            </div>

            <div class="search-container bg-white p-4">
                <input type="text" id="search-input" placeholder="Pesquisar itens..." class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                <div class="flex items-center justify-between mt-4">
                    <div id="filter-status-container" class="flex flex-wrap gap-2 text-sm">
                        <button class="filter-btn active px-3 py-1 rounded-full bg-gray-200 text-gray-700" data-status="Todos">Todos</button>
                        <button class="filter-btn px-3 py-1 rounded-full bg-gray-200 text-gray-700" data-status="Disponíveis">Disponíveis</button>
                        <button class="filter-btn px-3 py-1 rounded-full bg-gray-200 text-gray-700" data-status="Esgotados">Esgotados</button>
                        <button class="filter-btn px-3 py-1 rounded-full bg-gray-200 text-gray-700" data-status="Ocultos">Ocultos</button>
                    </div>
                </div>
            </div>
            
        </div>

        <div id="pizzas-panel" class="tab-panel active"></div>
        <div id="burgers-panel" class="tab-panel hidden"></div>
        <div id="bebidas-panel" class="tab-panel hidden"></div>
        <div id="porcoes-panel" class="tab-panel hidden"></div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, onSnapshot, collection, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration (replace with your actual config)
        const firebaseConfig = {
            apiKey: "AIzaSyB9LJ-7bOvHGYyFE_H2Qd7XFcyjmSPq_ro",
            authDomain: "samia-cardapio.firebaseapp.com",
            projectId: "samia-cardapio",
            storageBucket: "samia-cardapio.firebasestorage.app",
            messagingSenderId: "223260436641",
            appId: "1:223260436641:web:adf78e77a0267f66f1e8e0"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Define constants for the Google Sheets URLs
        const CARDAPIO_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQUmJgK9fI5_0Fp-iQf8u_H_gI8yTq9J5uC0sYy0T1J7w/pub?gid=324234&single=true&output=csv';
        
        // UI Elements
        const loadingOverlay = document.getElementById('loading-overlay');
        const searchInput = document.getElementById('search-input');
        const filterStatusContainer = document.getElementById('filter-status-container');
        const tabs = document.querySelectorAll('.tab-btn');
        const panels = document.querySelectorAll('.tab-panel');
        const logoutBtn = document.getElementById('logout-btn');

        let cardapioData = {};
        let filteredCardapioData = {};

        // Authentication State Listener
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.body.style.visibility = 'visible';
                fetchAndRenderData();
            } else {
                window.location.href = 'login.html';
            }
        });

        // Event Listeners
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                panels.forEach(p => p.classList.add('hidden'));
                document.getElementById(tab.id.replace('-tab', '-panel')).classList.remove('hidden');
                filterItems();
            });
        });

        searchInput.addEventListener('input', filterItems);
        filterStatusContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('filter-btn')) {
                filterStatusContainer.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                filterItems();
            }
        });
        
        logoutBtn.addEventListener('click', () => {
            signOut(auth);
        });

        // Function to parse CSV data
        function parseCsvData(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(';').map(header => header.trim().replace(/"/g, ''));
            const data = lines.slice(1).map(line => {
                const values = line.split(';').map(value => value.trim().replace(/"/g, ''));
                const item = {};
                headers.forEach((header, i) => {
                    item[header] = values[i];
                });
                return item;
            });
            return data;
        }

        // Function to fetch and render data
        async function fetchAndRenderData() {
            loadingOverlay.style.display = 'flex';
            try {
                const response = await fetch(CARDAPIO_CSV_URL);
                if (!response.ok) {
                    throw new Error(`Falha ao buscar dados da planilha: ${response.statusText}`);
                }
                const csvText = await response.text();
                const items = parseCsvData(csvText);
                
                // Get item availability and half-pizza status from Firestore
                const itemStatusRef = doc(db, "config", "item_status");
                onSnapshot(itemStatusRef, (docSnap) => {
                    const unavailableItems = docSnap.exists() ? docSnap.data() : {};
                    cardapioData = items.map(item => {
                        const status = unavailableItems[item.id] || {};
                        return {
                            ...item,
                            available: status.available !== undefined ? status.available : true,
                            meiaMeiaEnabled: status.meiaMeiaEnabled !== undefined ? status.meiaMeiaEnabled : true,
                            visible: status.visible !== undefined ? status.visible : true,
                        };
                    });
                    
                    // Filter and render initial view
                    filterAndRender();
                    loadingOverlay.style.display = 'none';
                });

            } catch (error) {
                console.error('Erro ao buscar ou renderizar dados:', error);
                loadingOverlay.style.display = 'none';
            }
        }

        // Function to update Firestore for item status
        async function updateItemStatus(itemId, newStatus) {
            const itemStatusRef = doc(db, "config", "item_status");
            const updateData = {};
            updateData[`${itemId}.available`] = newStatus;

            try {
                await updateDoc(itemStatusRef, updateData, { merge: true });
                console.log(`Status de disponibilidade de ${itemId} atualizado para ${newStatus}`);
            } catch (e) {
                console.error("Erro ao atualizar o status: ", e);
            }
        }
        
        // NEW FUNCTION: Update Firestore for half-pizza status
        async function updateMeiaMeiaStatus(itemId, newStatus) {
            const itemStatusRef = doc(db, "config", "item_status");
            const updateData = {};
            updateData[`${itemId}.meiaMeiaEnabled`] = newStatus;

            try {
                await updateDoc(itemStatusRef, updateData, { merge: true });
                console.log(`Status de meia a meia de ${itemId} atualizado para ${newStatus}`);
            } catch (e) {
                console.error("Erro ao atualizar o status de meia a meia: ", e);
            }
        }

        // Function to update Firestore for item visibility
        async function updateItemVisibility(itemId, newVisibility) {
            const itemStatusRef = doc(db, "config", "item_status");
            const updateData = {};
            updateData[`${itemId}.visible`] = newVisibility;

            try {
                await updateDoc(itemStatusRef, updateData, { merge: true });
                console.log(`Visibilidade de ${itemId} atualizada para ${newVisibility}`);
            } catch (e) {
                console.error("Erro ao atualizar a visibilidade: ", e);
            }
        }

        // Filter and render items based on search and filters
        function filterAndRender() {
            const searchTerm = searchInput.value.toLowerCase();
            const activeTab = document.querySelector('.tab-btn.active');
            const category = activeTab.textContent.trim().toLowerCase();
            const activeStatusBtn = document.querySelector('#filter-status-container .filter-btn.active');
            const statusFilter = activeStatusBtn.dataset.status;

            filteredCardapioData[category] = cardapioData.filter(item => {
                const nameMatch = item.name.toLowerCase().includes(searchTerm) || (item.category && item.category.toLowerCase().includes(searchTerm));
                const categoryMatch = item.category.toLowerCase() === category || (category === 'pizzas' && item.category.toLowerCase() === 'pizzas-inteiras');
                
                let statusMatch = false;
                switch (statusFilter) {
                    case 'Disponíveis':
                        statusMatch = item.visible && item.available;
                        break;
                    case 'Esgotados':
                        statusMatch = item.visible && !item.available;
                        break;
                    case 'Ocultos':
                        statusMatch = !item.visible;
                        break;
                    default: // 'Todos'
                        statusMatch = true;
                }
                
                return nameMatch && categoryMatch && statusMatch;
            });
            renderItems(filteredCardapioData[category], category);
        }

        // Render function
        function renderItems(items, category) {
            const panel = document.getElementById(`${category}-panel`);
            if (!panel) return;
            panel.innerHTML = '';
            
            const groupedItems = groupByCategory(items);
            
            for (const group in groupedItems) {
                const groupDiv = document.createElement('div');
                groupDiv.classList.add('bg-white', 'p-4', 'rounded-lg', 'shadow-md', 'mb-4', 'availability-group');
                groupDiv.innerHTML = `<h2 class="text-xl font-bold mb-4 text-gray-800" data-category-group>${group}</h2>`;

                groupedItems[group].forEach(item => {
                    const rowDiv = document.createElement('div');
                    rowDiv.classList.add('availability-row');
                    rowDiv.dataset.itemId = item.id;
                    rowDiv.dataset.itemCategory = item.category;

                    const visibilityChecked = item.visible ? 'checked' : '';
                    const availabilityChecked = item.available ? 'checked' : '';
                    const meiaMeiaChecked = item.meiaMeiaEnabled ? 'checked' : '';

                    rowDiv.innerHTML = `
                        <div class="availability-row-text-container">
                            <h3 class="font-medium text-gray-800">${item.name}</h3>
                            <p class="text-sm text-gray-500">
                                Preço: R$ ${parseFloat(item.price).toFixed(2).replace('.', ',')}
                            </p>
                        </div>
                        <div class="flex items-center space-x-4">
                            ${(item.category && item.category.toLowerCase() === 'pizzas-inteiras') ? `
                                <div class="flex flex-col items-center">
                                    <span class="text-xs text-gray-500">Meia Pizza</span>
                                    <label class="switch">
                                        <input type="checkbox" data-action="toggle-meia-meia" ${meiaMeiaChecked}>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            ` : ''}
                            <div class="flex flex-col items-center">
                                <span class="text-xs text-gray-500">Disponível</span>
                                <label class="switch">
                                    <input type="checkbox" data-action="toggle-available" ${availabilityChecked}>
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="flex flex-col items-center">
                                <span class="text-xs text-gray-500">Visível</span>
                                <label class="switch">
                                    <input type="checkbox" data-action="toggle-visible" ${visibilityChecked}>
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                    `;
                    groupDiv.appendChild(rowDiv);
                });
                panel.appendChild(groupDiv);
            }
            
            setupItemEventListeners();
        }
        
        function setupItemEventListeners() {
            const panel = document.querySelector('.tab-panel.active');
            if (!panel) return;
            
            panel.querySelectorAll('input[type="checkbox"]').forEach(input => {
                input.addEventListener('change', (e) => {
                    const itemId = e.target.closest('.availability-row').dataset.itemId;
                    const action = e.target.dataset.action;
                    const isChecked = e.target.checked;
                    
                    if (action === 'toggle-available') {
                        updateItemStatus(itemId, isChecked);
                    } else if (action === 'toggle-visible') {
                        updateItemVisibility(itemId, isChecked);
                    } else if (action === 'toggle-meia-meia') {
                        updateMeiaMeiaStatus(itemId, isChecked);
                    }
                });
            });
        }
        
        function groupByCategory(items) {
            if (!Array.isArray(items)) return {};
            return items.reduce((acc, item) => {
                const category = item.category || 'Outros';
                if (!acc[category]) {
                    acc[category] = [];
                }
                acc[category].push(item);
                return acc;
            }, {});
        }

    </script>
</body>
</html>
