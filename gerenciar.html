<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Disponibilidade - Sâmia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="https://raw.githubusercontent.com/WillianSoares93/cardapio_samia/refs/heads/main/logo.png" type="image/png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f3f4f6;
            visibility: hidden; /* Esconde o corpo até a autenticação ser verificada */
            overflow: hidden;
        }
        .tab-btn {
            transition: all 0.2s ease-in-out;
            border-bottom: 4px solid transparent;
        }
        .tab-btn.active {
            border-bottom-color: #ef4444; /* Red color for the active tab */
            color: #1f2937;
        }
        .filter-btn {
            transition: all 0.2s ease-in-out;
        }
        /* Estilos para o Toggle Switch */
        .toggle-bg:after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            background: white;
            width: 1.25rem; /* h-5 */
            height: 1.25rem; /* w-5 */
            border-radius: 9999px;
            transition: transform 0.2s ease-in-out;
        }
        input:checked + .toggle-bg:after {
            transform: translateX(100%);
            border-color: white;
        }
        input:checked + .toggle-bg {
            background-color: #22c55e; /* green-500 */
        }
        input:disabled + .toggle-bg {
            cursor: not-allowed;
            background-color: #d1d5db; /* gray-400 */
        }
        /* --- ESTILOS PARA BARRA LATERAL AJUSTADOS --- */
        .main-container {
            display: grid;
            grid-template-columns: 0px 1fr; /* Barra lateral escondida por padrão */
            height: 100vh; /* Ocupa a altura total da tela */
            transition: grid-template-columns 0.3s ease-in-out;
        }
        .main-container.sidebar-open {
            grid-template-columns: 80px 1fr; /* Mostra a barra lateral */
        }
        .sidebar-nav {
            background-color: #2C3E50;
            overflow: hidden;
        }
        .sidebar-btn {
            color: #BDC3C7;
            transition: all 0.2s ease-in-out;
        }
        .sidebar-btn:hover {
            background-color: #34495E;
            color: white;
        }
        .sidebar-btn.active {
            background-color: #3b82f6;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="main-container">
        <!-- Sidebar Vertical Esquerda -->
        <aside class="sidebar-nav flex flex-col justify-between py-4">
            <!-- Main Navigation -->
            <div>
                <a href="pdv.html" class="sidebar-btn w-full flex flex-col items-center p-3 text-xs" title="Painel de Pedidos">
                    <i class="fas fa-receipt fa-2x"></i>
                    <span>PEDIDOS</span>
                </a>
                <a href="venda-balcao.html" class="sidebar-btn w-full flex flex-col items-center p-3 text-xs" title="Venda Balcão">
                    <i class="fas fa-cash-register fa-2x"></i>
                    <span>BALCÃO</span>
                </a>
                <a href="editar-cardapio.html" class="sidebar-btn w-full flex flex-col items-center p-3 text-xs" title="Editar Cardápio">
                    <i class="fas fa-edit fa-2x"></i>
                    <span>EDITAR</span>
                </a>
                <a href="gerenciar.html" class="sidebar-btn active w-full flex flex-col items-center p-3 text-xs" title="Gerenciar Itens">
                    <i class="fas fa-tasks fa-2x"></i>
                    <span>GERENCIAR</span>
                </a>
                <a href="relatorio.html" class="sidebar-btn w-full flex flex-col items-center p-3 text-xs" title="Relatórios">
                    <i class="fas fa-chart-line fa-2x"></i>
                    <span>RELATÓRIOS</span>
                </a>
            </div>
            <!-- Bottom Actions -->
            <div class="space-y-2">
                 <div class="text-center px-2 py-3 text-xs text-gray-400 overflow-hidden" title="Usuário Logado">
                    <i class="fas fa-user-circle fa-2x mb-1"></i>
                    <span id="current-user" class="block truncate"></span>
                </div>
                <button id="logout-btn-sidebar" class="sidebar-btn w-full flex flex-col items-center p-3 text-xs" title="Sair">
                    <i class="fas fa-sign-out-alt fa-2x text-red-400"></i>
                    <span class="text-red-400">SAIR</span>
                </button>
            </div>
        </aside>

        <main id="main-content" class="overflow-y-auto">
            <header class="bg-white shadow-md">
                <div class="max-w-7xl mx-auto py-2 px-4 sm:px-6 lg:px-8 flex justify-start items-center">
                    <h1 class="text-xl font-bold text-gray-800">Gerenciamento de Itens</h1>
                </div>
            </header>

            <main class="max-w-5xl mx-auto p-4 sm:p-6 lg:p-8">
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    
                    <div class="border-b border-gray-200 mb-4">
                        <nav id="availability-tabs" class="-mb-px flex space-x-6" aria-label="Tabs">
                            <button class="tab-btn active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg text-gray-500 hover:text-gray-700 hover:border-gray-300" data-target="item-panel">
                                Itens do Cardápio
                            </button>
                            <button class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg text-gray-500 hover:text-gray-700 hover:border-gray-300" data-target="ingredient-panel">
                                Ingredientes Hambúrguer
                            </button>
                            <button class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg text-gray-500 hover:text-gray-700 hover:border-gray-300" data-target="extras-panel">
                                Adicionais
                            </button>
                        </nav>
                    </div>

                    <div id="availability-container">
                        <div id="item-panel" class="tab-panel">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <input type="text" id="search-item" placeholder="Buscar item..." class="md:col-span-1 p-2 border rounded-md">
                                <select id="item-category-select" class="md:col-span-1 p-2 border rounded-md"></select>
                                <div id="item-status-filters" class="md:col-span-1 flex items-center justify-around bg-gray-100 p-1 rounded-md"></div>
                            </div>
                            <div class="space-y-4 max-h-[60vh] overflow-y-auto p-2">
                                <div class="flex items-center justify-between p-3 border-b sticky top-0 bg-gray-50 z-10">
                                    <span class="font-bold text-gray-600 w-2/6">Item</span>
                                    <div class="flex items-center justify-around w-4/6">
                                        <span class="font-bold text-gray-600 w-1/4 text-center">Disponível</span>
                                        <span class="font-bold text-gray-600 w-1/4 text-center">Visível</span>
                                        <span class="font-bold text-gray-600 w-1/4 text-center">Aceita Adicionais</span>
                                        <span class="font-bold text-gray-600 w-1/4 text-center">Permite Meia</span>
                                    </div>
                                </div>
                                <div id="item-availability-list" class="space-y-4">
                                    <p class="text-gray-500">Carregando itens...</p>
                                </div>
                            </div>
                        </div>

                        <div id="ingredient-panel" class="tab-panel hidden">
                             <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <input type="text" id="search-ingredient" placeholder="Buscar ingrediente..." class="md:col-span-1 p-2 border rounded-md">
                                <select id="ingredient-category-select" class="md:col-span-1 p-2 border rounded-md"></select>
                                <div id="ingredient-status-filters" class="md:col-span-1 flex items-center justify-around bg-gray-100 p-1 rounded-md"></div>
                            </div>
                             <div class="space-y-4 max-h-[60vh] overflow-y-auto p-2">
                                <div class="flex items-center justify-between p-3 border-b sticky top-0 bg-gray-50 z-10">
                                    <span class="font-bold text-gray-600 w-2/5">Ingrediente</span>
                                    <div class="flex items-center justify-around w-3/5">
                                        <span class="font-bold text-gray-600 w-1/2 text-center">Disponível</span>
                                        <span class="font-bold text-gray-600 w-1/2 text-center">Visível</span>
                                    </div>
                                </div>
                                <div id="ingredient-availability-list" class="space-y-4">
                                    <p class="text-gray-500">Carregando ingredientes...</p>
                                </div>
                            </div>
                        </div>

                        <div id="extras-panel" class="tab-panel hidden">
                             <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <input type="text" id="search-extra" placeholder="Buscar adicional..." class="md:col-span-1 p-2 border rounded-md">
                                <select id="extra-category-select" class="md:col-span-1 p-2 border rounded-md"></select>
                                <div id="extra-status-filters" class="md:col-span-1 flex items-center justify-around bg-gray-100 p-1 rounded-md"></div>
                            </div>
                             <div class="space-y-4 max-h-[60vh] overflow-y-auto p-2">
                                <div class="flex items-center justify-between p-3 border-b sticky top-0 bg-gray-50 z-10">
                                    <span class="font-bold text-gray-600 w-2/5">Adicional</span>
                                    <div class="flex items-center justify-around w-3/5">
                                        <span class="font-bold text-gray-600 w-1/2 text-center">Disponível</span>
                                        <span class="font-bold text-gray-600 w-1/2 text-center">Visível</span>
                                    </div>
                                </div>
                                <div id="extra-availability-list" class="space-y-4">
                                    <p class="text-gray-500">Carregando adicionais...</p>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </main>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

// Suas credenciais do Firebase
const firebaseConfig = {
  apiKey: "AIzaSyB9LJ-7bOvHGYyFE_H2Qd7XFcyjmSPq_ro",
  authDomain: "samia-cardapio.firebaseapp.com",
  projectId: "samia-cardapio",
  storageBucket: "samia-cardapio.firebasestorage.app",
  messagingSenderId: "223260436641",
  appId: "1:223260436641:web:adf78e77a0267f66f1e8e0"
};

        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        document.addEventListener('DOMContentLoaded', () => {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    document.body.style.visibility = 'visible';
                     const currentUserEl = document.getElementById('current-user');
                    if (currentUserEl) {
                        currentUserEl.textContent = user.email;
                    }
                    initializeManager();
                } else {
                    window.location.href = `login.html?redirect=gerenciar.html`;
                }
            });

            document.getElementById('logout-btn-sidebar').addEventListener('click', () => signOut(auth));

            // Sidebar logic
            const mainContainer = document.querySelector('.main-container');
            const sidebar = document.querySelector('.sidebar-nav');
            const mainContent = document.getElementById('main-content'); 

            document.addEventListener('mousemove', (e) => {
                if (e.clientX < 20) {
                    mainContainer.classList.add('sidebar-open');
                }
            });
            sidebar.addEventListener('mouseleave', () => {
                mainContainer.classList.remove('sidebar-open');
            });
            mainContent.addEventListener('mouseenter', () => {
                mainContainer.classList.remove('sidebar-open');
            });
        });


        const itemAvailabilityList = document.getElementById('item-availability-list');
        const ingredientAvailabilityList = document.getElementById('ingredient-availability-list');
        const extraAvailabilityList = document.getElementById('extra-availability-list');
        const tabsContainer = document.getElementById('availability-tabs');
        const tabPanels = document.querySelectorAll('.tab-panel');

        let allItems = [];
        let allIngredients = [];
        let allExtras = [];
        
        let itemStatus = {};
        let itemVisibility = {};
        let itemExtrasStatus = {}; 
        let pizzaHalfStatus = {};
        
        let ingredientStatus = {};
        let ingredientVisibility = {};

        let extraStatus = {};
        let extraVisibility = {};

        async function initializeManager() {
            await fetchMenuData();
            renderItemAvailabilityList();
            renderIngredientAvailabilityList();
            renderExtraAvailabilityList();
            listenToStatusChanges();
            setupTabs();
            setupFilters();
        }

        function setupTabs() {
            tabsContainer.addEventListener('click', (e) => {
                const clickedTab = e.target.closest('.tab-btn');
                if (!clickedTab) return;

                tabsContainer.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                clickedTab.classList.add('active');

                const targetPanelId = clickedTab.dataset.target;
                tabPanels.forEach(panel => {
                    panel.id === targetPanelId ? panel.classList.remove('hidden') : panel.classList.add('hidden');
                });
                filterLists(); 
            });
        }

        function setupFilters() {
            ['item', 'ingredient', 'extra'].forEach(type => {
                document.getElementById(`search-${type}`).addEventListener('input', filterLists);
                document.getElementById(`${type}-category-select`).addEventListener('change', filterLists);
                document.getElementById(`${type}-status-filters`).addEventListener('click', (e) => {
                    if (e.target.tagName === 'BUTTON') {
                        document.querySelectorAll(`#${type}-status-filters button`).forEach(btn => {
                            btn.classList.remove('bg-white', 'shadow');
                            btn.classList.add('text-gray-500');
                        });
                        e.target.classList.add('bg-white', 'shadow');
                        e.target.classList.remove('text-gray-500');
                        filterLists();
                    }
                });
            });
        }

        async function fetchMenuData() {
            try {
                const response = await fetch('/api/menu');
                if (!response.ok) throw new Error('Falha ao buscar o cardápio');
                const data = await response.json();
                allItems = data.cardapio || [];
                allIngredients = data.ingredientesHamburguer || [];
                allExtras = data.ingredientesPizza || [];
            } catch (error) {
                console.error("Erro ao carregar dados do menu:", error);
                itemAvailabilityList.innerHTML = '<p class="text-red-500">Erro ao carregar itens.</p>';
                ingredientAvailabilityList.innerHTML = '<p class="text-red-500">Erro ao carregar ingredientes.</p>';
                extraAvailabilityList.innerHTML = '<p class="text-red-500">Erro ao carregar adicionais.</p>';
            }
        }

        function listenToStatusChanges() {
            onSnapshot(doc(db, "config", "item_status"), (doc) => {
                itemStatus = doc.exists() ? doc.data() : {};
                updateAllRows(); filterLists();
            });
            onSnapshot(doc(db, "config", "item_visibility"), (doc) => {
                itemVisibility = doc.exists() ? doc.data() : {};
                updateAllRows(); filterLists();
            });
            onSnapshot(doc(db, "config", "item_extras_status"), (doc) => { 
                itemExtrasStatus = doc.exists() ? doc.data() : {};
                updateAllRows(); filterLists();
            });
            onSnapshot(doc(db, "config", "pizza_half_status"), (doc) => {
                pizzaHalfStatus = doc.exists() ? doc.data() : {};
                updateAllRows(); filterLists();
            });
            onSnapshot(doc(db, "config", "ingredient_status"), (doc) => {
                ingredientStatus = doc.exists() ? doc.data() : {};
                updateAllRows(); filterLists();
            });
            onSnapshot(doc(db, "config", "ingredient_visibility"), (doc) => {
                ingredientVisibility = doc.exists() ? doc.data() : {};
                updateAllRows(); filterLists();
            });
            onSnapshot(doc(db, "config", "extra_status"), (doc) => {
                extraStatus = doc.exists() ? doc.data() : {};
                updateAllRows(); filterLists();
            });
            onSnapshot(doc(db, "config", "extra_visibility"), (doc) => {
                extraVisibility = doc.exists() ? doc.data() : {};
                updateAllRows(); filterLists();
            });
        }
        
        function updateAllRows() {
            document.querySelectorAll('.availability-row').forEach(row => {
                const type = row.dataset.type;
                const itemId = row.dataset.itemId;
                
                let currentStatus, currentVisibility;

                if (type === 'item') {
                    currentStatus = itemStatus;
                    currentVisibility = itemVisibility;
                } else if (type === 'ingredient') {
                    currentStatus = ingredientStatus;
                    currentVisibility = ingredientVisibility;
                } else if (type === 'extra') {
                    currentStatus = extraStatus;
                    currentVisibility = extraVisibility;
                } else {
                    return; 
                }
                
                if (!currentStatus || !currentVisibility) return;

                const isAvailable = currentStatus[itemId] !== false;
                const isVisible = currentVisibility[itemId] !== false;
                
                const availabilityToggle = row.querySelector('.availability-toggle');
                const visibilityToggle = row.querySelector('.visibility-toggle');
                
                if(availabilityToggle) availabilityToggle.checked = isAvailable;
                if(visibilityToggle) visibilityToggle.checked = isVisible;
                
                if(availabilityToggle) {
                    availabilityToggle.disabled = !isVisible;
                    if (!isVisible) {
                        availabilityToggle.closest('label').classList.add('opacity-50');
                    } else {
                        availabilityToggle.closest('label').classList.remove('opacity-50');
                    }
                }
                
                if (type === 'item') {
                    const item = allItems.find(i => i.id === itemId);
                    const defaultExtras = item ? item.isPizza : false;
                    const acceptsExtras = itemExtrasStatus[itemId] === undefined ? defaultExtras : itemExtrasStatus[itemId];
                    const allowsHalf = pizzaHalfStatus[itemId] === undefined ? true : pizzaHalfStatus[itemId];

                    const extrasToggle = row.querySelector('.extras-toggle');
                    if (extrasToggle) {
                        extrasToggle.checked = acceptsExtras;
                        extrasToggle.disabled = !isVisible;
                         if (!isVisible) {
                            extrasToggle.closest('label').classList.add('opacity-50');
                        } else {
                            extrasToggle.closest('label').classList.remove('opacity-50');
                        }
                    }

                    const halfToggle = row.querySelector('.half-toggle');
                    if (halfToggle) {
                        halfToggle.checked = allowsHalf;
                        halfToggle.disabled = !isVisible;
                         if (!isVisible) {
                            halfToggle.closest('label').classList.add('opacity-50');
                        } else {
                            halfToggle.closest('label').classList.remove('opacity-50');
                        }
                    }
                }
            });
        }

        function renderItemAvailabilityList() {
            renderList(allItems, itemAvailabilityList, 'item');
            populateCategorySelect(allItems, document.getElementById('item-category-select'));
            renderStatusFilters(document.getElementById('item-status-filters'), 'item');
        }

        function renderIngredientAvailabilityList() {
            renderList(allIngredients, ingredientAvailabilityList, 'ingredient');
            populateCategorySelect(allIngredients, document.getElementById('ingredient-category-select'));
            renderStatusFilters(document.getElementById('ingredient-status-filters'), 'ingredient');
        }
        
        function renderExtraAvailabilityList() {
            renderList(allExtras, extraAvailabilityList, 'extra');
            populateCategorySelect(allExtras, document.getElementById('extra-category-select'));
            renderStatusFilters(document.getElementById('extra-status-filters'), 'extra');
        }

        function renderList(items, container, type) {
            container.innerHTML = '';
            if (!Array.isArray(items) || items.length === 0) {
                container.innerHTML = `<p class="text-gray-500">Nenhum item encontrado.</p>`;
                return;
            }
            const itemsByCategory = groupByCategory(items);
            for (const category in itemsByCategory) {
                const categoryDiv = document.createElement('div');
                categoryDiv.dataset.categoryGroup = category;
                categoryDiv.innerHTML = `<h3 class="text-lg font-medium text-gray-700 mt-4 border-t pt-4">${category}</h3>`;
                const list = document.createElement('div');
                list.className = 'mt-2 space-y-3';
                itemsByCategory[category].forEach(item => {
                    if (item.id) {
                        list.appendChild(createAvailabilityRow(item, type));
                    } else {
                        console.warn('Item sem ID encontrado e ignorado:', item);
                    }
                });
                categoryDiv.appendChild(list);
                container.appendChild(categoryDiv);
            }
        }

        function populateCategorySelect(items, selectElement) {
            const categories = ['Todos', ...new Set(items.map(item => item.category || 'Outros'))];
            const currentVal = selectElement.value;
            selectElement.innerHTML = '';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                selectElement.appendChild(option);
            });
            if (currentVal) selectElement.value = currentVal;
        }

        function renderStatusFilters(container, type) {
            if (container.children.length > 0) return;
            const statuses = ['Todos', 'Disponíveis', 'Esgotados', 'Ocultos'];
            statuses.forEach((status, index) => {
                const button = document.createElement('button');
                button.className = `filter-btn flex-1 p-1 rounded-md text-sm font-semibold ${index === 0 ? 'bg-white shadow' : 'text-gray-500'}`;
                button.textContent = status;
                button.dataset.status = status;
                container.appendChild(button);
            });
        }

        function createAvailabilityRow(item, type) {
            const row = document.createElement('div');
            row.className = 'availability-row flex items-center justify-between p-3 border rounded-md bg-gray-50';
            row.dataset.name = item.name.toLowerCase();
            row.dataset.category = item.category || 'Outros';
            row.dataset.itemId = item.id;
            row.dataset.type = type;
            
            let currentStatus, currentVisibility;
            
            // CORREÇÃO: Garante que as variáveis de estado corretas sejam usadas para cada tipo.
            if (type === 'item') {
                currentStatus = itemStatus;
                currentVisibility = itemVisibility;
            } else if (type === 'ingredient') {
                currentStatus = ingredientStatus;
                currentVisibility = ingredientVisibility;
            } else if (type === 'extra') {
                currentStatus = extraStatus;
                currentVisibility = extraVisibility;
            }

            const isAvailable = currentStatus[item.id] !== false;
            const isVisible = currentVisibility[item.id] !== false;
            
            let togglesHtml = '';
            if (type === 'item') {
                const defaultExtras = item.isPizza;
                const acceptsExtras = itemExtrasStatus[item.id] === undefined ? defaultExtras : itemExtrasStatus[item.id];
                const allowsHalf = item.isPizza ? (pizzaHalfStatus[item.id] === undefined ? true : pizzaHalfStatus[item.id]) : false;
                
                const halfToggleContainerClass = item.isPizza ? 'w-1/4' : 'w-1/4 invisible';

                togglesHtml = `
                    <div class="flex items-center justify-around w-4/6">
                        <label class="flex items-center justify-center cursor-pointer w-1/4 ${!isVisible ? 'opacity-50' : ''}">
                            <div class="relative">
                                <input type="checkbox" class="sr-only peer availability-toggle" data-type="availability" ${isAvailable ? 'checked' : ''} ${!isVisible ? 'disabled' : ''}>
                                <div class="toggle-bg w-11 h-6 bg-gray-200 rounded-full peer"></div>
                            </div>
                        </label>
                        <label class="flex items-center justify-center cursor-pointer w-1/4">
                            <div class="relative">
                                <input type="checkbox" class="sr-only peer visibility-toggle" data-type="visibility" ${isVisible ? 'checked' : ''}>
                                <div class="toggle-bg w-11 h-6 bg-gray-200 rounded-full peer"></div>
                            </div>
                        </label>
                        <label class="flex items-center justify-center cursor-pointer w-1/4 ${!isVisible ? 'opacity-50' : ''}">
                            <div class="relative">
                                <input type="checkbox" class="sr-only peer extras-toggle" data-type="extras" ${acceptsExtras ? 'checked' : ''} ${!isVisible ? 'disabled' : ''}>
                                <div class="toggle-bg w-11 h-6 bg-gray-200 rounded-full peer"></div>
                            </div>
                        </label>
                         <div class="${halfToggleContainerClass}">
                             <label class="flex items-center justify-center cursor-pointer ${!isVisible ? 'opacity-50' : ''}">
                                <div class="relative">
                                    <input type="checkbox" class="sr-only peer half-toggle" data-type="half" ${allowsHalf ? 'checked' : ''} ${!isVisible ? 'disabled' : ''}>
                                    <div class="toggle-bg w-11 h-6 bg-gray-200 rounded-full peer"></div>
                                </div>
                            </label>
                        </div>
                    </div>`;
            } else { // Ingredientes ou Adicionais
                 togglesHtml = `
                    <div class="flex items-center justify-around w-3/5">
                        <label class="flex items-center justify-center cursor-pointer w-1/2 ${!isVisible ? 'opacity-50' : ''}">
                            <div class="relative">
                                <input type="checkbox" class="sr-only peer availability-toggle" data-type="availability" ${isAvailable ? 'checked' : ''} ${!isVisible ? 'disabled' : ''}>
                                <div class="toggle-bg w-11 h-6 bg-gray-200 rounded-full peer"></div>
                            </div>
                        </label>
                        <label class="flex items-center justify-center cursor-pointer w-1/2">
                            <div class="relative">
                                <input type="checkbox" class="sr-only peer visibility-toggle" data-type="visibility" ${isVisible ? 'checked' : ''}>
                                <div class="toggle-bg w-11 h-6 bg-gray-200 rounded-full peer"></div>
                            </div>
                        </label>
                    </div>`;
            }

            row.innerHTML = `
                <span class="font-medium text-gray-800 w-${type === 'item' ? '2/6' : '2/5'}">${item.name}</span>
                ${togglesHtml}
            `;

            row.querySelector('.availability-toggle').addEventListener('change', (e) => {
                updateStatus(item.id, type, { isAvailable: e.target.checked });
            });
            row.querySelector('.visibility-toggle').addEventListener('change', (e) => {
                const newVisibility = e.target.checked;
                updateStatus(item.id, type, { isAvailable: newVisibility, isVisible: newVisibility });
            });
            
            const extrasToggle = row.querySelector('.extras-toggle');
            if (extrasToggle) {
                 extrasToggle.addEventListener('change', (e) => {
                    updateStatus(item.id, type, { acceptsExtras: e.target.checked });
                });
            }
            const halfToggle = row.querySelector('.half-toggle');
            if (halfToggle) {
                 halfToggle.addEventListener('change', (e) => {
                    updateStatus(item.id, type, { allowsHalf: e.target.checked });
                });
            }

            return row;
        }

        async function updateStatus(id, type, { isAvailable, isVisible, acceptsExtras, allowsHalf }) {
            try {
                if(!id) {
                    throw new Error("ID do item está vazio. A operação não pode ser concluída.");
                }

                const finalAvailability = (isVisible === false) ? false : isAvailable;

                if (type === 'item') {
                    if (isVisible !== undefined) {
                        await setDoc(doc(db, "config", "item_visibility"), { [id]: isVisible }, { merge: true });
                    }
                    if (finalAvailability !== undefined) {
                        await setDoc(doc(db, "config", "item_status"), { [id]: finalAvailability }, { merge: true });
                    }
                    if (acceptsExtras !== undefined) {
                        await setDoc(doc(db, "config", "item_extras_status"), { [id]: acceptsExtras }, { merge: true });
                    }
                    if (allowsHalf !== undefined) {
                        await setDoc(doc(db, "config", "pizza_half_status"), { [id]: allowsHalf }, { merge: true });
                    }
                } else if (type === 'ingredient') {
                    if (isVisible !== undefined) {
                        await setDoc(doc(db, "config", "ingredient_visibility"), { [id]: isVisible }, { merge: true });
                    }
                    if (finalAvailability !== undefined) {
                        await setDoc(doc(db, "config", "ingredient_status"), { [id]: finalAvailability }, { merge: true });
                    }
                } else if (type === 'extra') {
                    if (isVisible !== undefined) {
                        await setDoc(doc(db, "config", "extra_visibility"), { [id]: isVisible }, { merge: true });
                    }
                    if (finalAvailability !== undefined) {
                        await setDoc(doc(db, "config", "extra_status"), { [id]: finalAvailability }, { merge: true });
                    }
                }

            } catch (error) {
                console.error("Erro ao atualizar status:", error);
                alert("Não foi possível atualizar o status. Tente novamente.");
            }
        }

        function filterLists() {
            const activePanel = document.querySelector('.tab-panel:not(.hidden)');
            if (!activePanel) return;
            
            let type = activePanel.id.split('-')[0];
            if (type === 'extras') {
                type = 'extra';
            }
            
            const searchInput = document.getElementById(`search-${type}`);
            const categorySelect = document.getElementById(`${type}-category-select`);
            const activeStatusBtn = document.querySelector(`#${type}-status-filters .bg-white`);

            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            const selectedCategory = categorySelect ? categorySelect.value : 'Todos';
            const activeStatus = activeStatusBtn ? activeStatusBtn.dataset.status : 'Todos';

            activePanel.querySelectorAll('.availability-row').forEach(row => {
                const itemId = row.dataset.itemId;
                const nameMatch = row.dataset.name.includes(searchTerm);
                const categoryMatch = selectedCategory === 'Todos' || row.dataset.category === selectedCategory;

                let currentStatusDb, currentVisibilityDb;

                if (type === 'item') {
                    currentStatusDb = itemStatus;
                    currentVisibilityDb = itemVisibility;
                } else if (type === 'ingredient') {
                    currentStatusDb = ingredientStatus;
                    currentVisibilityDb = ingredientVisibility;
                } else if (type === 'extra') { 
                    currentStatusDb = extraStatus;
                    currentVisibilityDb = extraVisibility;
                }

                if (!currentStatusDb || !currentVisibilityDb) {
                    row.style.display = 'flex'; 
                    return;
                }

                const currentIsAvailable = currentStatusDb[itemId] !== false;
                const currentIsVisible = currentVisibilityDb[itemId] !== false;
                
                let statusMatch = false;
                switch (activeStatus) {
                    case 'Disponíveis':
                        statusMatch = currentIsVisible && currentIsAvailable;
                        break;
                    case 'Esgotados':
                        statusMatch = currentIsVisible && !currentIsAvailable;
                        break;
                    case 'Ocultos':
                        statusMatch = !currentIsVisible;
                        break;
                    default: // 'Todos'
                        statusMatch = true;
                }

                if (nameMatch && categoryMatch && statusMatch) {
                    row.style.display = 'flex';
                } else {
                    row.style.display = 'none';
                }
            });

            activePanel.querySelectorAll('[data-category-group]').forEach(titleDiv => {
                const hasVisibleItems = Array.from(titleDiv.querySelectorAll('.availability-row')).some(row => row.style.display !== 'none');
                titleDiv.style.display = hasVisibleItems ? 'block' : 'none';
            });
        }

        function groupByCategory(items) {
            if (!Array.isArray(items)) return {};
            return items.reduce((acc, item) => {
                const category = item.category || 'Outros';
                if (!acc[category]) {
                    acc[category] = [];
                }
                acc[category].push(item);
                return acc;
            }, {});
        }

    </script>

</body>
</html>
