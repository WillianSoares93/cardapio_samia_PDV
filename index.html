<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sâmia - Cardápio Online</title>
    <meta name="theme-color" content="#f8f4e9"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="https://raw.githubusercontent.com/WillianSoares93/cardapio_samia_PDV/refs/heads/main/logo.png" type="image/png">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');
        html {
            scroll-behavior: smooth;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8f4e9;
        }
        .flavor-card {
            transition: all 0.3s ease;
        }
        .flavor-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }
        .half-pizza-card {
            background-color: #fff;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-pizza-option {
            transition: all 0.3s ease;
        }
        .btn-pizza-option.active {
            background-color: #FBBF24;
            color: #1f2937;
        }
        .btn-pizza-option:disabled {
            background-color: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
        }
        .cart-item-card {
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        .cart-item-card:hover {
            transform: scale(1.02);
        }
        .category-scroll-btn {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(5px);
            border-radius: 9999px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        .category-scroll-btn:hover {
            background-color: white;
            transform: scale(1.05);
        }
        .fixed-bottom-button {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            position: relative;
        }
        .pizza-half-message {
            font-size: 0.75rem;
            line-height: 1rem;
            color: #6b7280;
            text-align: center;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body class="bg-[#f8f4e9]">

    <!-- Modal de Mensagens Genéricas -->
    <div id="message-modal" class="modal z-[2000]">
        <div class="modal-content text-center">
            <h3 id="modal-message-title" class="font-bold text-lg mb-2 text-gray-800"></h3>
            <p id="modal-message-text" class="text-gray-600 mb-4"></p>
            <button id="close-modal-btn" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition">Fechar</button>
        </div>
    </div>

    <!-- Modal de Adição de Item -->
    <div id="item-modal" class="modal">
        <div class="modal-content">
            <button id="close-modal-btn-item" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-xl font-bold">&times;</button>
            <div id="modal-content-details"></div>
            <div class="flex items-center justify-between mt-4">
                <div class="flex items-center">
                    <button id="quantity-minus" class="bg-gray-300 text-gray-700 px-3 py-1 rounded-full text-lg font-bold hover:bg-gray-400 transition">-</button>
                    <span id="quantity-display" class="px-4 text-lg font-semibold">1</span>
                    <button id="quantity-plus" class="bg-gray-300 text-gray-700 px-3 py-1 rounded-full text-lg font-bold hover:bg-gray-400 transition">+</button>
                </div>
                <button id="add-to-cart-btn" class="px-6 py-2 bg-red-600 text-white rounded-full font-bold shadow-md hover:bg-red-700 transition">Adicionar ao Carrinho</button>
            </div>
        </div>
    </div>
    
    <!-- Modal do Carrinho -->
    <div id="cart-modal" class="modal z-[1500]">
        <div class="modal-content w-[90%] max-w-lg relative">
            <button id="close-cart-btn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-xl font-bold">&times;</button>
            <h2 class="text-2xl font-bold mb-4 text-gray-800 text-center">Seu Carrinho</h2>
            <div id="cart-items" class="max-h-80 overflow-y-auto mb-4 border-b border-gray-200"></div>
            <div class="flex justify-between items-center mb-4 text-lg font-semibold text-gray-800 border-t border-gray-200 pt-4">
                <span>Subtotal:</span>
                <span id="cart-total">R$ 0,00</span>
            </div>
            <div id="finalizar-buttons" class="flex flex-col space-y-3">
                <button id="address-btn" class="w-full px-6 py-3 bg-green-600 text-white rounded-full font-bold shadow-lg hover:bg-green-700 transition flex items-center justify-center space-x-2">
                    <i class="fas fa-map-marker-alt"></i><span>Continuar com o Endereço</span>
                </button>
                <button id="clear-cart-btn" class="w-full px-6 py-3 bg-gray-200 text-gray-700 rounded-full font-bold hover:bg-gray-300 transition">Limpar Carrinho</button>
            </div>
        </div>
    </div>

    <!-- Modal de Endereço -->
    <div id="address-modal" class="modal z-[1600]">
        <div class="modal-content">
            <button id="close-address-btn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-xl font-bold">&times;</button>
            <h2 class="text-2xl font-bold mb-4 text-gray-800 text-center">Dados de Contato</h2>
            <form id="address-form" class="space-y-4">
                <input type="text" id="client-name" placeholder="Seu Nome" required class="w-full p-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-red-500">
                <input type="tel" id="whatsapp" placeholder="WhatsApp (DDD + Número)" required pattern="[0-9]{10,11}" title="Apenas números, com DDD. Ex: 11987654321" class="w-full p-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-red-500">
                <select id="delivery-option" class="w-full p-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-red-500">
                    <option value="delivery">Entrega</option>
                    <option value="retirada">Retirada no Local</option>
                </select>
                <div id="delivery-fields" class="space-y-4">
                    <input type="text" id="rua" placeholder="Rua e Número" required class="w-full p-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-red-500">
                    <input type="text" id="bairro" placeholder="Bairro" required class="w-full p-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-red-500">
                    <input type="text" id="referencia" placeholder="Ponto de Referência (Opcional)" class="w-full p-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-red-500">
                </div>
                <button type="submit" class="w-full px-6 py-3 bg-red-600 text-white rounded-full font-bold shadow-lg hover:bg-red-700 transition">Continuar</button>
            </form>
        </div>
    </div>

    <!-- Modal de Pagamento -->
    <div id="payment-modal" class="modal z-[1700]">
        <div class="modal-content">
            <button id="close-payment-btn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-xl font-bold">&times;</button>
            <h2 class="text-2xl font-bold mb-4 text-gray-800 text-center">Pagamento</h2>
            <div class="mb-4">
                <p class="text-lg text-gray-600">Subtotal: <span id="payment-subtotal"></span></p>
                <p class="text-lg text-gray-600">Taxa de Entrega: <span id="payment-delivery-fee"></span></p>
                <p id="payment-discount-row" class="text-lg text-green-600 hidden">Desconto: <span id="payment-discount"></span></p>
                <p class="text-xl font-bold text-gray-800">Total: <span id="payment-total"></span></p>
            </div>
            <form id="payment-form" class="space-y-4">
                <label class="block">
                    <input type="radio" name="payment-method" value="dinheiro" class="mr-2" required> Dinheiro
                </label>
                <div id="troco-container" class="hidden pl-6">
                    <input type="number" id="troco-para" placeholder="Precisa de troco para quanto?" class="w-full p-2 rounded-md border border-gray-300">
                </div>
                <label class="block">
                    <input type="radio" name="payment-method" value="cartao" class="mr-2"> Cartão de Crédito/Débito
                </label>
                <label class="block">
                    <input type="radio" name="payment-method" value="pix" class="mr-2"> PIX
                </label>
                <button id="finish-order-btn" type="submit" class="w-full px-6 py-3 bg-red-600 text-white rounded-full font-bold shadow-lg hover:bg-red-700 transition">Finalizar Pedido</button>
            </form>
        </div>
    </div>

    <!-- Modal de QRCode -->
    <div id="qrcode-modal" class="modal z-[1800]">
        <div class="modal-content">
            <button id="close-qrcode-modal-btn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-xl font-bold">&times;</button>
            <h2 class="text-2xl font-bold mb-4 text-gray-800 text-center">PIX para Pagamento</h2>
            <div id="qrcode" class="flex justify-center mb-4"></div>
            <p class="text-center text-gray-600">Leia o QR Code para pagar ou use a chave PIX abaixo.</p>
            <p id="pix-key" class="text-center font-bold text-red-600 break-words mt-2"></p>
        </div>
    </div>

    <!-- Modal de Instalação (PWA) -->
    <div id="install-prompt-modal" class="modal">
        <div class="modal-content text-center">
            <h3 class="font-bold text-lg mb-2 text-gray-800">Instalar o aplicativo</h3>
            <p class="text-gray-600 mb-4">Adicione o Cardápio Sâmia à sua tela inicial para um acesso rápido e fácil!</p>
            <button id="install-btn" class="px-6 py-3 bg-red-600 text-white rounded-full font-bold shadow-lg hover:bg-red-700 transition">
                <i class="fas fa-download mr-2"></i> Instalar
            </button>
            <button id="close-install-prompt-modal-btn" class="mt-4 px-4 py-2 text-gray-500 hover:text-gray-700 transition">Fechar</button>
        </div>
    </div>

    <div id="loader" class="fixed inset-0 flex items-center justify-center bg-white z-[2000]">
        <div class="animate-spin rounded-full h-32 w-32 border-b-4 border-red-500"></div>
    </div>

    <header class="bg-white sticky top-0 z-50 shadow-md">
        <div class="container mx-auto p-4 flex items-center justify-center relative">
            <img id="logo" src="https://raw.githubusercontent.com/WillianSoares93/cardapio_samia_PDV/refs/heads/main/logo.png" alt="Sâmia Pizzaria" class="h-16">
        </div>
        <nav id="category-nav" class="flex overflow-x-auto justify-start sm:justify-center py-2 px-4 space-x-2">
            <!-- Botões de categoria serão injetados aqui -->
        </nav>
    </header>
    
    <main class="container mx-auto p-4 min-h-screen">
        <section id="promotion-section" class="mb-8 hidden">
            <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-4">Promoção do Dia!</h2>
            <div id="promotions-container" class="bg-red-500 text-white rounded-xl shadow-lg p-6 flex flex-col items-center text-center">
                <!-- Conteúdo da promoção será injetado aqui -->
            </div>
        </section>

        <section id="menu-section">
            <!-- Itens do cardápio serão injetados aqui -->
        </section>

        <section id="contact-section" class="my-8 py-8 border-t border-gray-300">
            <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-4">Contato e Horário de Funcionamento</h2>
            <div id="contact-container" class="bg-white rounded-xl shadow-lg p-6">
                <!-- Informações de contato serão injetadas aqui -->
            </div>
        </section>
    </main>

    <button id="cart-button" class="fixed-bottom-button fixed bottom-4 right-4 bg-green-600 text-white p-4 rounded-full shadow-lg z-40 transition-all transform hover:scale-110">
        <i class="fas fa-shopping-cart text-2xl"></i>
    </button>
    <button id="promotion-button" class="fixed-bottom-button fixed bottom-20 right-4 bg-yellow-500 text-white p-4 rounded-full shadow-lg z-40 transition-all transform hover:scale-110 hidden">
        <i class="fas fa-tag text-2xl"></i>
    </button>
    
    <script type="module">
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB9LJ-7bOvHGYyFE_H2Qd7XFcyjmSPq_ro",
            authDomain: "samia-cardapio.firebaseapp.com",
            projectId: "samia-cardapio",
            storageBucket: "samia-cardapio.firebasestorage.app",
            messagingSenderId: "223260436641",
            appId: "1:223260436641:web:adf78e77a0267f66f1e8e0"
        };
        
        let app;
        if (!getApps().length) {
            app = initializeApp(firebaseConfig);
        } else {
            app = getApp();
        }
        const db = getFirestore(app);

        // Variáveis globais
        let menuData = {
            cardapio: [],
            promocoes: [],
            deliveryFees: [],
            contact: []
        };
        let cart = {};
        let activeFlavors = [];
        let deferredPrompt;
        let selectedPizzaMode = 'inteira'; // 'inteira' ou 'meia'
        let currentHalfPizzaPrice = 0;
        let selectedHalfFlavors = { 1: null, 2: null };
        let selectedHalfPrices = { 1: 0, 2: 0 };
        
        // Elementos do DOM
        const loader = document.getElementById('loader');
        const menuSection = document.getElementById('menu-section');
        const cartButton = document.getElementById('cart-button');
        const cartModal = document.getElementById('cart-modal');
        const closeCartBtn = document.getElementById('close-cart-btn');
        const cartItemsContainer = document.getElementById('cart-items');
        const cartTotalDisplay = document.getElementById('cart-total');
        const clearCartBtn = document.getElementById('clear-cart-btn');
        const addressBtn = document.getElementById('address-btn');
        const addressModal = document.getElementById('address-modal');
        const closeAddressBtn = document.getElementById('close-address-btn');
        const addressForm = document.getElementById('address-form');
        const deliveryOptionSelect = document.getElementById('delivery-option');
        const deliveryFields = document.getElementById('delivery-fields');
        const paymentModal = document.getElementById('payment-modal');
        const closePaymentBtn = document.getElementById('close-payment-btn');
        const paymentForm = document.getElementById('payment-form');
        const paymentSubtotalDisplay = document.getElementById('payment-subtotal');
        const paymentDeliveryFeeDisplay = document.getElementById('payment-delivery-fee');
        const paymentTotalDisplay = document.getElementById('payment-total');
        const trocoContainer = document.getElementById('troco-container');
        const qrcodeModal = document.getElementById('qrcode-modal');
        const closeQrcodeModalBtn = document.getElementById('close-qrcode-modal-btn');
        const messageModal = document.getElementById('message-modal');
        const modalMessageText = document.getElementById('modal-message-text');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const installPromptModal = document.getElementById('install-prompt-modal');
        const closeInstallPromptModalBtn = document.getElementById('close-install-prompt-modal-btn');
        const installBtn = document.getElementById('install-btn');
        const promotionSection = document.getElementById('promotion-section');
        const promotionsContainer = document.getElementById('promotions-container');
        const promotionButton = document.getElementById('promotion-button');

        // Utils
        const formatPrice = (price) => `R$ ${parseFloat(price).toFixed(2).replace('.', ',')}`;
        
        function showMessageModal(title, text) {
            document.getElementById('modal-message-title').textContent = title;
            document.getElementById('modal-message-text').textContent = text;
            messageModal.style.display = 'flex';
        }
        
        closeModalBtn.addEventListener('click', () => {
            messageModal.style.display = 'none';
        });

        // Carregar dados
        document.addEventListener('DOMContentLoaded', () => {
            fetchMenuData();
            registerServiceWorker();
            setupPWAInstallPrompt();
            
            // Ocultar a section de promoções se não houver promoções
            updatePromotionButtonVisibility();
        });

        async function fetchMenuData() {
            try {
                const response = await fetch('/api/menu');
                if (!response.ok) {
                    throw new Error('Erro ao carregar os dados do cardápio.');
                }
                menuData = await response.json();
                
                // Ouve por mudanças no Firestore em tempo real
                onSnapshot(doc(db, "config", "item_status"), (docSnap) => {
                    const statusData = docSnap.exists() ? docSnap.data() : {};
                    renderMenu(menuData.cardapio, statusData);
                    renderPromotions(menuData.promocoes);
                    renderContact(menuData.contact);
                    updatePromotionButtonVisibility();
                });

            } catch (error) {
                console.error("Erro ao carregar o cardápio:", error);
                loader.style.display = 'none';
                showMessageModal('Erro', 'Não foi possível carregar o cardápio. Tente recarregar a página.');
            }
        }

        function renderMenu(items, statusData) {
            const groupedItems = groupByCategory(items);
            let menuHtml = '';
            
            // Renderiza os botões de navegação por categoria
            const nav = document.getElementById('category-nav');
            nav.innerHTML = '';
            Object.keys(groupedItems).forEach(category => {
                const hasVisibleItems = groupedItems[category].some(item => (statusData[item.id]?.visible !== false) && item.available !== 'false');
                if (hasVisibleItems) {
                    nav.innerHTML += `
                        <a href="#category-${category.replace(/\s+/g, '-')}" class="px-4 py-2 text-sm sm:text-base font-semibold text-gray-700 rounded-full hover:bg-gray-200 transition capitalize whitespace-nowrap">
                            ${category}
                        </a>
                    `;
                }
            });

            // Renderiza o cardápio
            for (const category in groupedItems) {
                const items = groupedItems[category];
                const categoryId = `category-${category.replace(/\s+/g, '-')}`;
                const hasVisibleItems = items.some(item => (statusData[item.id]?.visible !== false) && item.available !== 'false');
                
                if (!hasVisibleItems) continue;

                menuHtml += `
                    <div id="${categoryId}" class="mb-8">
                        <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 capitalize mb-4">${category}</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                `;
                items.forEach(item => {
                    // Pega o status do Firestore, com um fallback se não existir
                    const itemStatus = statusData[item.id] || {};
                    const isAvailable = (itemStatus.available !== false) && (item.available !== 'false');
                    const isVisible = (itemStatus.visible !== false) && (item.available !== 'false'); // Usa o `available` do CSV como fallback de visibilidade
                    
                    if (isVisible) {
                        const price = parseFloat(item.price);
                        const isPizza = item.category.toLowerCase() === 'pizzas';
                        const halfPizzaAvailable = itemStatus.halfPizzaAvailable !== false;
                        
                        // Lógica de desativação do botão de meia pizza
                        let halfButtonClass = `bg-gray-200 text-gray-700 hover:bg-gray-300`;
                        let halfButtonDisabled = false;
                        let halfButtonMessage = '';
                        if (isPizza) {
                            if (!halfPizzaAvailable) {
                                halfButtonClass = 'bg-gray-200 text-gray-400 cursor-not-allowed';
                                halfButtonDisabled = true;
                                halfButtonMessage = `<p class="pizza-half-message">Esse sabor de pizza não fazemos meia a meia.</p>`;
                            }
                        }

                        menuHtml += `
                            <div class="flavor-card p-4 sm:p-6 bg-white rounded-xl shadow-lg flex items-center justify-between space-x-4 ${!isAvailable ? 'opacity-50' : ''}">
                                <div class="flex-1">
                                    <h3 class="font-bold text-lg sm:text-xl text-gray-900">${item.name}</h3>
                                    <p class="text-sm text-gray-600 mt-1">${item.description}</p>
                                    ${item.sub_description ? `<p class="text-xs text-gray-500 mt-1 italic">${item.sub_description}</p>` : ''}
                                    ${item.price_10_slices && isPizza ? `<p class="text-sm font-semibold text-gray-800 mt-2">10 Fatias: ${formatPrice(item.price_10_slices)}</p>` : ''}
                                    <p class="text-lg font-bold text-red-500 mt-2">${formatPrice(price)}</p>
                                </div>
                                <div class="flex-shrink-0 flex flex-col items-center space-y-2">
                                    <button class="add-to-cart-btn w-12 h-12 bg-red-500 text-white rounded-full shadow-md hover:bg-red-600 transition ${!isAvailable ? 'opacity-50 cursor-not-allowed' : ''}"
                                        data-item-id="${item.id}"
                                        data-item-name="${item.name}"
                                        data-item-price="${price}"
                                        data-item-category="${item.category}"
                                        ${!isAvailable ? 'disabled' : ''}>
                                        <i class="fas fa-plus"></i>
                                    </button>
                                    ${isPizza ? `
                                        <button class="select-half-pizza-btn w-12 h-12 bg-yellow-500 text-white rounded-full shadow-md hover:bg-yellow-600 transition ${halfButtonClass}"
                                            data-item-id="${item.id}"
                                            data-item-name="${item.name}"
                                            data-item-price="${price}"
                                            ${halfButtonDisabled ? 'disabled' : ''}>
                                            <i class="fas fa-cut"></i>
                                        </button>
                                        ${halfButtonMessage}
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    }
                });
                menuHtml += `</div></div>`;
            }
            menuSection.innerHTML = menuHtml;
            loader.style.display = 'none';
        }

        // Restante do código... (permanece o mesmo, apenas o trecho acima foi alterado)
        function renderPromotions(promotions) {
            if (promotions && promotions.length > 0 && promotions[0].title) {
                const promotion = promotions[0];
                promotionsContainer.innerHTML = `
                    <h3 class="text-2xl font-bold">${promotion.title}</h3>
                    <p class="text-lg mt-2">${promotion.description}</p>
                    <p class="text-xl font-bold mt-4">${formatPrice(promotion.price)}</p>
                `;
                promotionSection.style.display = 'block';
                promotionButton.classList.remove('hidden');
            } else {
                promotionSection.style.display = 'none';
                promotionButton.classList.add('hidden');
            }
        }

        function renderContact(contactData) {
            if (contactData && contactData.length > 0) {
                const contactInfo = contactData[0];
                document.getElementById('contact-container').innerHTML = `
                    <p class="text-lg text-gray-700"><i class="fas fa-phone-alt mr-2 text-red-500"></i>Telefone: ${contactInfo.telefone}</p>
                    <p class="text-lg text-gray-700 mt-2"><i class="fas fa-clock mr-2 text-red-500"></i>Horário: ${contactInfo.horario_funcionamento}</p>
                `;
            }
        }
        
        function groupByCategory(items) {
            const grouped = {};
            items.forEach(item => {
                const category = item.category || 'Outros';
                if (!grouped[category]) {
                    grouped[category] = [];
                }
                grouped[category].push(item);
            });
            return grouped;
        }

        document.addEventListener('click', (e) => {
            if (e.target.closest('.add-to-cart-btn')) {
                const btn = e.target.closest('.add-to-cart-btn');
                const item = {
                    id: btn.dataset.itemId,
                    name: btn.dataset.itemName,
                    price: parseFloat(btn.dataset.itemPrice),
                    quantity: 1,
                    category: btn.dataset.itemCategory
                };
                if (item.category.toLowerCase() === 'pizzas' && selectedPizzaMode === 'meia') {
                    showMessageModal('Ops!', 'Para adicionar uma pizza inteira ao carrinho, selecione a opção "Pizza Inteira" primeiro.');
                    return;
                }
                addToCart(item);
                updateCartDisplay();
            } else if (e.target.closest('.select-half-pizza-btn')) {
                handleHalfPizzaSelection(e.target.closest('.select-half-pizza-btn'));
            }
        });
        
        function handleHalfPizzaSelection(btn) {
            if (!btn) return;
            selectedPizzaMode = 'meia';
            
            const itemId = btn.dataset.itemId;
            const itemName = btn.dataset.itemName;
            const itemPrice = parseFloat(btn.dataset.itemPrice);
            
            const cardElement = btn.closest('.flavor-card');
            
            // Toggle de seleção
            if (activeFlavors.includes(itemId)) {
                activeFlavors = activeFlavors.filter(id => id !== itemId);
                cardElement.classList.remove('border-green-500', 'border-4');
                // Remove dos sabores selecionados
                if (selectedHalfFlavors[1] === itemName) {
                    selectedHalfFlavors[1] = null;
                    selectedHalfPrices[1] = 0;
                } else if (selectedHalfFlavors[2] === itemName) {
                    selectedHalfFlavors[2] = null;
                    selectedHalfPrices[2] = 0;
                }
            } else {
                if (activeFlavors.length >= 2) {
                    showMessageModal('Limite de Sabores', 'Você pode escolher no máximo dois sabores para meia pizza.');
                    return;
                }
                activeFlavors.push(itemId);
                cardElement.classList.add('border-green-500', 'border-4');
                // Adiciona aos sabores selecionados
                if (!selectedHalfFlavors[1]) {
                    selectedHalfFlavors[1] = itemName;
                    selectedHalfPrices[1] = itemPrice;
                } else if (!selectedHalfFlavors[2]) {
                    selectedHalfFlavors[2] = itemName;
                    selectedHalfPrices[2] = itemPrice;
                }
            }
            
            // Verifica se as duas metades foram escolhidas
            if (Object.values(selectedHalfFlavors).filter(f => f).length === 2) {
                const finalPrice = Math.max(selectedHalfPrices[1], selectedHalfPrices[2]);
                currentHalfPizzaPrice = finalPrice;
                const orderItem = {
                    id: 'pizza-meia-meia',
                    name: `Pizza Meia/Meia: ${selectedHalfFlavors[1]} e ${selectedHalfFlavors[2]}`,
                    price: finalPrice,
                    quantity: 1,
                    category: 'pizzas'
                };
                addToCart(orderItem);
                
                // Reseta a seleção após adicionar ao carrinho
                activeFlavors = [];
                selectedHalfFlavors = { 1: null, 2: null };
                selectedHalfPrices = { 1: 0, 2: 0 };
                
                // Remove as bordas verdes
                document.querySelectorAll('.flavor-card.border-green-500').forEach(card => card.classList.remove('border-green-500', 'border-4'));
                
                updateCartDisplay();
            }
        }
        
        function addToCart(item) {
            if (cart[item.id]) {
                cart[item.id].quantity += item.quantity;
            } else {
                cart[item.id] = { ...item };
            }
        }

        function updateCartDisplay() {
            cartItemsContainer.innerHTML = '';
            let total = 0;
            const items = Object.values(cart);
            
            if (items.length === 0) {
                cartItemsContainer.innerHTML = `<p class="text-center text-gray-500 py-4">Seu carrinho está vazio.</p>`;
                cartTotalDisplay.textContent = formatPrice(0);
                addressBtn.disabled = true;
                return;
            }
            
            addressBtn.disabled = false;
            
            items.forEach(item => {
                const subtotal = item.price * item.quantity;
                total += subtotal;
                
                const itemHtml = `
                    <div class="flex items-center justify-between p-3 border-b last:border-b-0">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-800">${item.name}</h4>
                            <p class="text-sm text-gray-500">${formatPrice(item.price)} x ${item.quantity} = ${formatPrice(subtotal)}</p>
                        </div>
                        <div class="flex space-x-2 ml-4">
                            <button class="update-quantity-btn px-2 py-1 bg-gray-200 rounded-full hover:bg-gray-300 transition" data-id="${item.id}" data-action="minus">-</button>
                            <button class="update-quantity-btn px-2 py-1 bg-gray-200 rounded-full hover:bg-gray-300 transition" data-id="${item.id}" data-action="plus">+</button>
                            <button class="remove-item-btn px-2 py-1 bg-red-500 text-white rounded-full hover:bg-red-600 transition" data-id="${item.id}"><i class="fas fa-trash-alt text-xs"></i></button>
                        </div>
                    </div>
                `;
                cartItemsContainer.innerHTML += itemHtml;
            });
            
            cartTotalDisplay.textContent = formatPrice(total);
        }

        cartButton.addEventListener('click', () => {
            cartModal.style.display = 'flex';
            updateCartDisplay();
        });
        
        closeCartBtn.addEventListener('click', () => {
            cartModal.style.display = 'none';
        });

        clearCartBtn.addEventListener('click', () => {
            cart = {};
            updateCartDisplay();
            showMessageModal('Carrinho Limpo', 'Seu carrinho foi esvaziado com sucesso.');
        });
        
        document.addEventListener('click', (e) => {
            if (e.target.closest('.update-quantity-btn')) {
                const btn = e.target.closest('.update-quantity-btn');
                const id = btn.dataset.id;
                const action = btn.dataset.action;
                
                if (action === 'plus') {
                    cart[id].quantity++;
                } else if (action === 'minus' && cart[id].quantity > 1) {
                    cart[id].quantity--;
                }
                updateCartDisplay();
            }
            
            if (e.target.closest('.remove-item-btn')) {
                const btn = e.target.closest('.remove-item-btn');
                const id = btn.dataset.id;
                delete cart[id];
                updateCartDisplay();
                
                if (Object.keys(cart).length === 0) {
                    cartModal.style.display = 'none';
                }
            }
        });
        
        addressBtn.addEventListener('click', () => {
            cartModal.style.display = 'none';
            addressModal.style.display = 'flex';
        });

        closeAddressBtn.addEventListener('click', () => {
            addressModal.style.display = 'none';
        });

        deliveryOptionSelect.addEventListener('change', (e) => {
            if (e.target.value === 'delivery') {
                deliveryFields.style.display = 'block';
                deliveryFields.querySelectorAll('input').forEach(input => input.required = true);
            } else {
                deliveryFields.style.display = 'none';
                deliveryFields.querySelectorAll('input').forEach(input => input.required = false);
            }
        });
        
        addressForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const selectedAddress = {
                clientName: document.getElementById('client-name').value,
                whatsapp: document.getElementById('whatsapp').value,
                option: document.getElementById('delivery-option').value
            };
            
            if (selectedAddress.option === 'delivery') {
                selectedAddress.rua = document.getElementById('rua').value;
                selectedAddress.bairro = document.getElementById('bairro').value;
                selectedAddress.referencia = document.getElementById('referencia').value;
            }

            const total = calculateTotal();
            if (total.subtotal === 0) {
                showMessageModal('Carrinho Vazio', 'Adicione itens ao seu carrinho antes de prosseguir.');
                return;
            }
            
            // Abrir modal de pagamento
            paymentSubtotalDisplay.textContent = formatPrice(total.subtotal);
            paymentDeliveryFeeDisplay.textContent = formatPrice(total.deliveryFee);
            paymentTotalDisplay.textContent = formatPrice(total.finalTotal);
            if (total.discount > 0) {
                document.getElementById('payment-discount-row').classList.remove('hidden');
                document.getElementById('payment-discount').textContent = ` - ${formatPrice(total.discount)}`;
            } else {
                 document.getElementById('payment-discount-row').classList.add('hidden');
            }
            
            addressModal.style.display = 'none';
            paymentModal.style.display = 'flex';
        });

        closePaymentBtn.addEventListener('click', () => {
            paymentModal.style.display = 'none';
        });

        paymentForm.addEventListener('change', (e) => {
            if (e.target.name === 'payment-method') {
                if (e.target.value === 'dinheiro') {
                    trocoContainer.style.display = 'block';
                } else {
                    trocoContainer.style.display = 'none';
                    document.getElementById('troco-para').value = '';
                }
            }
        });

        paymentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const finishOrderBtn = document.getElementById('finish-order-btn');
            finishOrderBtn.disabled = true;
            finishOrderBtn.textContent = 'Finalizando...';
            
            const selectedAddress = {
                clientName: document.getElementById('client-name').value,
                whatsapp: document.getElementById('whatsapp').value,
                option: document.getElementById('delivery-option').value,
                rua: document.getElementById('rua').value,
                bairro: document.getElementById('bairro').value,
                referencia: document.getElementById('referencia').value
            };

            const paymentMethod = e.target.querySelector('input[name="payment-method"]:checked').value;
            let trocoPara = null;
            if (paymentMethod === 'dinheiro') {
                trocoPara = document.getElementById('troco-para').value;
                if (trocoPara && parseFloat(trocoPara) < parseFloat(paymentTotalDisplay.textContent.replace('R$ ', '').replace(',', '.'))) {
                    showMessageModal('Valor Inválido', 'O valor para troco deve ser igual ou maior que o total do pedido.');
                    finishOrderBtn.disabled = false;
                    finishOrderBtn.textContent = 'Finalizar Pedido';
                    return;
                }
            }

            const orderDetails = {
                order: Object.values(cart),
                selectedAddress: selectedAddress,
                total: calculateTotal(),
                paymentMethod: paymentMethod,
                trocoPara: trocoPara,
                whatsappNumber: menuData.contact[0].whatsapp
            };
            
            try {
                const response = await fetch('/api/criar-pedido', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderDetails)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    if (paymentMethod === 'pix' && menuData.contact[0].pix_key) {
                        const qrcodeContainer = document.getElementById('qrcode');
                        const pixKeyDisplay = document.getElementById('pix-key');
                        
                        qrcodeContainer.innerHTML = ''; // Limpa o QR Code anterior
                        
                        new QRCode(qrcodeContainer, {
                            text: menuData.contact[0].pix_key,
                            width: 200,
                            height: 200,
                            colorDark : "#000000",
                            colorLight : "#f8f4e9",
                            correctLevel : QRCode.CorrectLevel.H
                        });
                        pixKeyDisplay.textContent = menuData.contact[0].pix_key;
                        
                        paymentModal.style.display = 'none';
                        qrcodeModal.style.display = 'flex';
                    } else {
                         // Redireciona para o WhatsApp após salvar o pedido
                         window.location.href = result.whatsappUrl;
                    }
                } else {
                    showMessageModal('Erro no Pedido', result.error || 'Ocorreu um erro ao finalizar o pedido. Tente novamente.');
                }
            } catch (error) {
                console.error("Erro ao finalizar pedido:", error);
                showMessageModal('Erro de Conexão', 'Não foi possível finalizar o pedido. Verifique sua conexão e tente novamente.');
            } finally {
                finishOrderBtn.disabled = false;
                finishOrderBtn.textContent = 'Finalizar Pedido';
            }
        });

        closeQrcodeModalBtn.addEventListener('click', () => {
            qrcodeModal.style.display = 'none';
            cart = {}; // Limpa o carrinho
            updateCartDisplay();
        });

        promotionButton.addEventListener('click', () => {
            const promoSection = document.getElementById('promotion-section');
            if (promoSection) {
                promoSection.scrollIntoView({ behavior: 'smooth' });
            }
        });

        function updatePromotionButtonVisibility() {
            const promotionSection = document.getElementById('promotion-section');
            if (promotionSection && promotionSection.style.display !== 'none') {
                promotionButton.classList.remove('hidden');
            } else {
                promotionButton.classList.add('hidden');
            }
        }

        window.addEventListener('scroll', () => {
            const isAtBottom = window.innerHeight + window.scrollY >= document.body.offsetHeight - 10;
            const isAtTop = window.scrollY < 200; // Define um valor para considerar "topo"
            
            if (isAtBottom) {
                cartButton.style.opacity = '0';
                cartButton.style.pointerEvents = 'none';
                promotionButton.style.opacity = '0';
                promotionButton.style.pointerEvents = 'none';
            } else {
                cartButton.style.opacity = '1';
                cartButton.style.pointerEvents = 'auto';
                if (promotionSection.style.display !== 'none') {
                    promotionButton.style.opacity = '1';
                    promotionButton.style.pointerEvents = 'auto';
                }
            }
        });

        function calculateTotal() {
            const subtotal = Object.values(cart).reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const deliveryFee = menuData.deliveryFees.length > 0 && deliveryOptionSelect.value === 'delivery' ? parseFloat(menuData.deliveryFees[0].price) : 0;
            
            let discount = 0;
            if (menuData.promocoes.length > 0) {
                const promotion = menuData.promocoes[0];
                if (subtotal >= parseFloat(promotion.min_value)) {
                    discount = parseFloat(promotion.discount);
                }
            }

            const finalTotal = (subtotal + deliveryFee) - discount;
            
            return {
                subtotal,
                deliveryFee,
                discount,
                finalTotal: Math.max(0, finalTotal)
            };
        }
        
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/service-worker.js').then(registration => {
                        console.log('Service Worker registrado com sucesso:', registration.scope);
                    }).catch(err => {
                        console.error('Falha no registro do Service Worker:', err);
                    });
                });
            }
        }
        
        function setupPWAInstallPrompt() {
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                if (installPromptModal) {
                    installPromptModal.style.display = 'flex';
                }
            });
            
            installBtn.addEventListener('click', () => {
                installPromptModal.style.display = 'none';
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            showMessageModal('Instalado!', 'O Cardápio está sendo instalado, logo ele aparecerá na sua tela de app.');
                        } else {
                            showMessageModal('Você pode instalar o Sâmia Cardápio a qualquer momento pelo menu do navegador.');
                        }
                        deferredPrompt = null; 
                    });
                }
            });

            closeInstallPromptModalBtn.addEventListener('click', () => {
                installPromptModal.style.display = 'none';
            });

            window.addEventListener('appinstalled', () => {
                installPromptModal.style.display = 'none';
            });
            
            window.addEventListener('scroll', () => {
                const isAtBottom = window.innerHeight + window.scrollY >= document.body.offsetHeight - 10;
                
                if (isAtBottom) {
                    cartButton.style.opacity = '0';
                    cartButton.style.pointerEvents = 'none';
                    promotionButton.style.opacity = '0';
                    promotionButton.style.pointerEvents = 'none';
                } else {
                    cartButton.style.opacity = '1';
                    cartButton.style.pointerEvents = 'auto';
                    promotionButton.style.opacity = '1';
                    promotionButton.style.pointerEvents = 'auto';
                    updatePromotionButtonVisibility();
                }
            });

        });
    </script>
</body>
</html>
