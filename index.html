...
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sâmia - Cardápio Online</title>
    <meta name="theme-color" content="#f8f4e9"/>
    <!-- Aviso: O CDN do Tailwind é ótimo para desenvolvimento, mas para produção considere usar PostCSS ou CLI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="https://i.imgur.com/bEgTi0O.png" type="image/png">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');
        html {
            scroll-behavior: smooth;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8f4e9;
        }
        .flavor-card {
            transition: all 0.3s ease;
        }
        .flavor-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .btn-order {
            background: linear-gradient(135deg, #f59e0b, #ef4444);
            transition: all 0.3s ease;
        }
        .btn-order:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);
        }
        .btn-add-more {
            background: linear-gradient(135deg, #fbbf24, #fcd34d);
            transition: all 0.3s ease;
        }
        .btn-add-more:hover {
            transform: scale(1.02);
            box-shadow: 0 3px 10px rgba(251, 191, 36, 0.4);
        }
        .header-bg {
            background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('https://i.imgur.com/EzD31Gk.jpeg');
            background-size: cover;
            background-position: center;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            position: relative;
            animation: fadeIn 0.3s ease-out;
            border: 2px solid #ef4444;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { transform: translateY(0); }
        }
        .message-modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .message-modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
            text-align: center;
            animation: fadeIn 0.3s ease-out;
        }
        .promotion-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        .promotion-popup-content {
            background-color: #fff;
            padding: 40px;
            border-radius: 15px;
            width: 90%;
            max-width: 550px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            text-align: center;
            position: relative;
            animation: popIn 0.4s ease-out;
            border: 3px solid #dc2626;
            overflow-y: auto;
            max-height: 90vh;
        }
        @keyframes popIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .promotion-popup-content h3 {
            font-size: 2.25rem;
            font-weight: bold;
            color: #dc2626;
            margin-bottom: 15px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        .promotion-popup-content p {
            font-size: 1.125rem;
            color: #374151;
            margin-bottom: 25px;
            line-height: 1.6;
        }
        .promotion-popup-content .close-button {
            top: 15px;
            right: 25px;
            font-size: 32px;
            color: #6b7280;
        }
        .promotion-popup-content .close-button:hover {
            color: #1f2937;
        }
        .promotion-item {
            background-color: #fee2e2;
            border: 1px solid #ef4444;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            text-align: left;
        }
        .promotion-item h4 {
            font-weight: bold;
            color: #dc2626;
            margin-bottom: 5px;
        }
        .promotion-item p {
            font-size: 0.95rem;
            color: #4b5563;
            margin-bottom: 5px;
        }
        .promotion-item .price {
            font-weight: bold;
            color: #dc2626;
            font-size: 1.1rem;
        }
        #promotion-button {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 20px;
            background-color: #dc2626;
            color: white;
            padding: 15px 20px;
            border-radius: 50px;
            font-weight: bold;
            font-size: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            cursor: pointer;
            z-index: 1500;
            transition: all 0.3s ease;
            animation: pulse 1.5s infinite;
            align-items: center;
            gap: 8px;
        }
        #promotion-button:hover {
            background-color: #b91c1c;
        }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 15px rgba(220, 38, 38, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
        }
        .pizza-size-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 12px;
            background-color: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            transition: all 0.3s ease-in-out;
            text-align: center;
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        }
        .pizza-size-option:hover {
            border-color: #dc2626;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
            transform: translateY(-4px);
        }
        .pizza-size-option .font-bold.text-lg {
            font-size: 1rem;
            color: #1f2937;
        }
        .pizza-size-option .text-red-600.font-bold {
            font-size: 1.125rem;
            color: #dc2626;
        }
        .pizza-size-option button {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }
        @media (max-width: 1023px) {
            .category-bar-mobile-sticky {
                position: sticky;
                top: 0;
                z-index: 10;
                background-color: #f8f4e9; /* Cor de fundo para a barra */
                padding-top: 1rem;
                padding-bottom: 0.5rem;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }
        }
        .pizza-category-section {
             /* Margem no topo para compensar a altura da barra de categoria pegajosa */
            scroll-margin-top: 6rem;
        }
        .suggested-drink-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f0fdf4;
            border: 1px solid #dcfce7;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .suggested-drink-item .drink-name {
            font-weight: 600;
            color: #16a34a;
        }
        .suggested-drink-item .drink-price {
            font-weight: 700;
            color: #15803d;
        }
        .suggested-drink-item button {
            background-color: #22c55e;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .suggested-drink-item button:hover {
            background-color: #16a34a;
        }
        .btn-confirm-green {
            background: linear-gradient(135deg, #22c55e, #10b981);
            transition: all 0.3s ease;
        }
        .btn-confirm-green:hover {
            background: linear-gradient(135deg, #10b981, #059669);
            transform: scale(1.02);
            box-shadow: 0 2px 4px rgba(34, 197, 94, 0.4);
        }
        .fly-to-cart-animation {
            position: fixed;
            background-color: #ef4444;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: bold;
            z-index: 9999;
            pointer-events: none;
            animation: flyToCart 0.8s ease-in-out forwards;
            opacity: 1;
            overflow: hidden;
        }
        .fly-to-cart-animation img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        @keyframes flyToCart {
            0% {
                left: var(--start-x);
                top: var(--start-y);
                transform: scale(1);
                opacity: 1;
            }
            70% {
                transform: scale(1.2);
                opacity: 0.8;
            }
            100% {
                left: var(--end-x);
                top: var(--end-y);
                transform: scale(0);
                opacity: 0;
            }
        }
        .payment-option {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .payment-option:hover {
            background-color: #f9fafb;
            border-color: #dc2626;
        }
        .payment-option.selected {
            background-color: #fee2e2;
            border-color: #dc2626;
            box-shadow: 0 2px 8px rgba(220, 38, 38, 0.2);
        }
        .payment-option input[type="radio"] {
            margin-right: 12px;
            accent-color: #dc2626;
        }
        .payment-option .icon {
            font-size: 1.5rem;
            margin-right: 12px;
            color: #4b5563;
        }
        .payment-option.selected .icon {
            color: #dc2626;
        }
        .payment-option .text-content {
            flex-grow: 1;
        }
        .payment-option .text-content h4 {
            font-weight: 600;
            color: #1f2937;
        }
        .payment-option .text-content p {
            font-size: 0.875rem;
            color: #6b7280;
        }
        .pix-code-container {
            word-break: break-all;
            white-space: normal;
        }
        .qrcode-container {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .address-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .address-modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            position: relative;
            animation: fadeIn 0.3s ease-out;
            border: 2px solid #ef4444;
        }
        .no-image-placeholder {
            background-color: #dc2626;
            height: 160px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            text-align: center;
            padding: 10px;
            object-fit: cover;
        }
        .builder-modal {
            max-width: 600px;
        }
        .ingredient-category {
            margin-bottom: 24px;
        }
        .ingredient-category h4 {
            font-size: 1.25rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e5e7eb;
        }
        .ingredient-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f9fafb;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: 1px solid #e5e7eb;
        }
        .ingredient-option:hover {
            border-color: #dc2626;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        }
        .ingredient-option input[type="radio"],
        .ingredient-option input[type="checkbox"] {
            margin-right: 12px;
            accent-color: #dc2626;
        }
        .ingredient-option .price {
            font-weight: bold;
            color: #dc2626;
            white-space: nowrap;
        }
        .ingredient-option.selected {
            background-color: #fee2e2;
            border-color: #dc2626;
            box-shadow: 0 2px 8px rgba(220, 38, 38, 0.2);
        }
        .builder-summary {
            background-color: #fff;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .builder-summary h5 {
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 8px;
        }
        .builder-summary ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .builder-summary li {
            font-size: 0.875rem;
            color: #4b5563;
        }
        .scope-button {
            transition: all 0.2s ease-in-out;
        }
        .scope-button.active {
            background-color: #ef4444;
            color: white;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <header class="header-bg text-white py-16 px-4 text-center">
        <div class="max-w-4xl mx-auto">
            <img src="https://i.imgur.com/bEgTi0O.png" alt="Logotipo Sâmia" class="h-64 mx-auto mb-4 object-contain">
            <p class="text-2xl mb-8">Pizzaria, Pastelaria e Hamburgueria</p>
            <div class="flex justify-center space-x-4">
                <a href="#menu" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-full transition duration-300">
                    Ver Cardápio
                </a>
            </div>
        </div>
    </header>

    <section id="menu" class="py-8 px-4 max-w-6xl mx-auto">
        <div class="text-center mb-8">
            <h2 class="text-4xl font-bold text-gray-800 mb-4">Nosso Cardápio</h2>
            <p class="text-gray-600 text-lg mx-auto">Bateu a fome? A Samia resolve!</p>
        </div>

        <div class="text-gray-500 text-sm text-center mb-4 lg:hidden">
            <i class="fas fa-hand-point-right mr-1"></i> Arraste para o lado para ver outras opções
        </div>

        <div class="category-bar-mobile-sticky lg:static lg:p-0">
            <div id="category-buttons-container" class="flex space-x-2 mb-6 overflow-x-auto pb-2
                        lg:flex-row lg:space-x-2 lg:mb-6 lg:overflow-visible lg:pb-0">
                <!-- Botões de categoria gerados pelo JS -->
            </div>
        </div>

        <div id="pizza-list">
            <div id="dynamic-pizza-sections">
                 <!-- Seções de cardápio geradas pelo JS -->
            </div>
        </div>
    </section>

    <!-- Botão flutuante do carrinho -->
    <button id="cart-button" class="fixed bottom-4 right-4 bg-red-600 text-white w-16 h-16 rounded-full flex items-center justify-center shadow-lg z-40">
        <i class="fas fa-shopping-cart text-2xl"></i>
        <span id="cartCount" class="absolute -top-1 -right-1 bg-yellow-400 text-red-700 text-xs font-bold rounded-full h-6 w-6 flex items-center justify-center border-2 border-white hidden">0</span>
    </button>

    <!-- Botão flutuante de promoções -->
    <button id="promotion-button">
        <i class="fas fa-tags"></i>
        <span>Promoções</span>
    </button>

    <!-- Sidebar do Pedido -->
    <div id="orderSidebar" class="fixed top-0 right-0 h-full w-full max-w-md bg-white shadow-xl z-50 transform translate-x-full transition-transform duration-300 overflow-y-auto">
        <div class="p-6">
            <!-- Cabeçalho da Sidebar -->
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">Seu Pedido</h3>
                <button id="close-sidebar-btn" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <!-- Itens do Pedido -->
            <div id="orderItems" class="mb-6">
                <p class="text-gray-500 text-center py-8" id="emptyOrderMessage">Seu pedido está vazio</p>
                <!-- Itens adicionados aqui pelo JS -->
            </div>

            <!-- Resumo do Pedido -->
            <div class="border-t border-gray-200 pt-4 mb-6">
                <div class="flex justify-between mb-2">
                    <span class="text-gray-600">Subtotal:</span>
                    <span id="subtotal" class="font-bold">R$ 0,00</span>
                </div>

                <div id="discount-section" class="flex justify-between items-center mb-2 hidden text-red-600">
                    <span class="text-gray-600">Desconto: <span id="discount-percentage-display"></span></span>
                    <span id="discount-value-display" class="font-bold">- R$ 0,00</span>
                </div>

                <div class="flex items-center mb-2 pt-2 border-t border-gray-100">
                    <input type="checkbox" id="pickupCheckbox" class="h-4 w-4 text-red-600 border-gray-300 rounded focus:ring-red-500">
                    <label for="pickupCheckbox" class="ml-2 block text-sm text-gray-900">Irei fazer a Retirada</label>
                </div>

                <div id="deliveryFeeSection" class="flex justify-between mb-2">
                    <span class="text-gray-600">Taxa de entrega:</span>
                    <div id="deliveryFeeContainer" class="flex items-center">
                        <span id="deliveryFeeDisplay" class="font-bold"></span>
                        <button id="informAddressBtn" class="ml-2 px-3 py-1 bg-red-600 text-white rounded-md text-sm hover:bg-red-700 transition hidden">
                            Informar Endereço
                        </button>
                        <button id="editDeliveryAddressBtn" class="ml-2 text-blue-500 hover:text-blue-700 text-sm hidden">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                </div>

                <div class="flex justify-between text-lg font-bold">
                    <span>Total:</span>
                    <span id="total">R$ 0,00</span>
                </div>

                <div class="mt-4">
                    <label for="order-observation" class="block text-sm font-medium text-gray-700">Observações:</label>
                    <textarea id="order-observation" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm" placeholder="Ex: Tirar a cebola, ponto da carne, etc."></textarea>
                </div>
            </div>

            <!-- Resumo do Endereço (se aplicável) -->
            <div id="address-summary-section" class="border border-gray-200 rounded-lg p-4 mb-6 bg-gray-50 hidden">
                <h4 class="font-bold text-gray-800 mb-2">Detalhes da Entrega:</h4>
                <p id="client-name-display" class="text-gray-700 text-sm"></p>
                <p id="contact-display" class="text-gray-700 text-sm"></p>
                <p id="address-display" class="text-gray-700 text-sm"></p>
                <p id="neighborhood-display" class="text-gray-600 text-sm"></p>
                <p id="reference-display" class="text-gray-600 text-sm italic"></p>
                <button id="editAddressBtn" class="mt-3 px-4 py-2 bg-blue-500 text-white rounded-md text-sm hover:bg-blue-600 transition">
                    Editar Detalhes
                </button>
            </div>

            <!-- Botões de Ação da Sidebar -->
            <button id="back-to-menu-btn" class="btn-add-more w-full py-3 text-white font-bold rounded-full mb-4">
                Adicionar mais
            </button>

            <button id="checkoutButton" class="btn-order w-full py-3 text-white font-bold rounded-full mb-4">
                Finalizar Pedido
            </button>

            </div>
    </div>

    <!-- Modal de Opções de Pizza -->
    <div id="pizza-option-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-pizza-option-modal">&times;</span>
            <h3 class="text-xl font-bold text-gray-800 mb-4" id="modal-pizza-name"></h3>
            <p class="text-gray-600 mb-6" id="modal-pizza-description"></p>
            <div id="pizza-size-options" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                 <!-- Opções de tamanho geradas pelo JS -->
            </div>
        </div>
    </div>

    <!-- Modal de Montagem de Hambúrguer -->
    <div id="burger-builder-modal" class="modal">
        <div class="modal-content builder-modal">
            <span class="close-button" id="close-burger-builder-modal">&times;</span>
            <h3 class="text-xl font-bold text-gray-800 mb-4">Monte Seu Hambúrguer</h3>

            <div id="burger-ingredients-container" class="mb-4">
                <!-- Ingredientes gerados pelo JS -->
            </div>

            <div class="flex justify-between items-center bg-gray-100 p-4 rounded-lg mt-4">
                <span class="text-lg font-bold">Total:</span>
                <span id="burger-total-price" class="text-2xl font-bold text-red-600">R$ 0,00</span>
            </div>

            <button id="add-custom-burger-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-full transition w-full">
                Adicionar ao Pedido
            </button>
        </div>
    </div>

    <!-- Modal de Mensagem Simples -->
    <div id="message-modal" class="message-modal">
        <div class="modal-content">
            <span class="close-button" id="close-message-modal">&times;</span>
            <p class="text-lg font-semibold text-gray-800 mb-4" id="message-modal-text"></p>
            <button id="ok-message-modal" class="px-4 py-2 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition">OK</button>
        </div>
    </div>

    <!-- Popup de Promoções -->
    <div id="promotion-popup" class="promotion-popup">
        <div class="modal-content">
            <span class="close-button" id="close-promotion-popup">&times;</span>
            <h3>Promoções Especiais!</h3>
            <p>Confira as nossas ofertas exclusivas e não perca tempo!</p>
            <div id="promotions-list">
                <!-- Lista de promoções gerada pelo JS -->
            </div>
            <button id="close-promotion-popup-btn" class="px-6 py-3 mt-6 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition w-full">
                Fechar Promoções
            </button>
        </div>
    </div>

    <!-- Modal de Sugestão de Bebidas -->
    <div id="drink-suggestion-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-drink-suggestion-modal">&times;</span>
            <h3 class="text-xl font-bold text-gray-800 mb-4">Que tal uma bebida para acompanhar?</h3>
            <p class="text-gray-600 mb-6">Adicione uma bebida para deixar seu pedido ainda mais completo!</p>
            <div id="suggested-drinks-list" class="mb-6 max-h-60 overflow-y-auto">
                <!-- Sugestões de bebidas geradas pelo JS -->
            </div>
            <button id="proceed-without-drinks" class="btn-order w-full py-3 text-white font-bold rounded-full">
                Finalizar sem Bebidas
            </button>
        </div>
    </div>

    <!-- Modal de Confirmação (sem bebida) -->
    <div id="confirm-no-drink-modal" class="message-modal">
        <div class="modal-content">
            <span class="close-button" id="close-confirm-no-drink-modal">&times;</span>
            <p class="text-lg font-semibold text-gray-800 mb-4">Tem certeza?</p>
            <p class="text-gray-600 mb-6">Deseja realmente finalizar o pedido sem adicionar uma bebida?</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-no-drink-no-btn" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-lg font-bold hover:bg-gray-400 transition">Não, voltar</button>
                <button id="confirm-no-drink-yes" class="px-6 py-2 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition">Sim, finalizar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Instalação do PWA -->
    <div id="install-prompt-modal" class="message-modal">
        <div class="modal-content">
            <span class="close-button" id="close-install-prompt-modal">&times;</span>
            <p class="text-lg font-semibold text-gray-800 mb-4">Instale o App Sâmia Cardápio para uma experiência completa!</p>
            <p class="text-gray-600 mb-6">Adicione nosso aplicativo à sua tela inicial para acesso rápido e fácil.</p>
            <button id="install-app-button" class="px-6 py-3 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition w-full">
                Instalar Aplicativo
            </button>
        </div>
    </div>

    <!-- Modal de Seleção de Pagamento -->
    <div id="payment-method-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-payment-method-modal">&times;</span>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Escolha a Forma de Pagamento</h3>
            <p class="text-gray-600 text-lg mb-4">Total Pedido: <span id="payment-modal-total" class="font-bold text-red-600">R$ 0,00</span></p>

            <div id="payment-options-container" class="flex flex-col gap-3 mb-6">
                <!-- Opções de pagamento geradas pelo JS -->
                <label class="payment-option" data-method="Dinheiro">
                    <input type="radio" name="paymentMethod" value="Dinheiro" class="form-radio">
                    <i class="fas fa-money-bill-wave icon"></i>
                    <div class="text-content">
                        <h4>Dinheiro</h4>
                        <p></p> <!-- Descrição opcional -->
                    </div>
                </label>
                <label class="payment-option" data-method="Cartão de Crédito/Débito">
                    <input type="radio" name="paymentMethod" value="Cartão de Crédito/Débito" class="form-radio">
                    <i class="fas fa-credit-card icon"></i>
                    <div class="text-content">
                        <h4>Cartão de Crédito/Débito</h4>
                        <p></p> <!-- Descrição opcional -->
                    </div>
                </label>
                <label class="payment-option items-start" data-method="Pix">
                    <div class="flex flex-col w-full">
                        <div class="flex items-center">
                            <input type="radio" name="paymentMethod" value="Pix" class="form-radio">
                            <i class="fas fa-qrcode icon"></i>
                            <div class="text-content">
                                <h4>Pix</h4>
                            </div>
                        </div>
                        <!-- Detalhes do Pix (chave e QR) -->
                        <div id="pix-details-container" class="hidden mt-2 w-full flex flex-col items-center">
                            <p class="text-xs text-black mb-1">Toque para copiar a chave pix</p>
                            <div id="pix-key-container" class="p-2 bg-gray-100 rounded-md text-sm w-full flex items-center justify-between cursor-pointer">
                                <span id="pix-key-display" class="font-mono text-gray-700 text-sm pix-code-container"></span>
                                <button id="copy-pix-btn" class="ml-2 text-gray-500 hover:text-gray-700" title="Copiar Chave Pix">
                                    <i class="fas fa-copy"></i>
                                </button>
                                <span id="copy-feedback" class="text-green-600 text-xs ml-2 hidden">Copiado!</span>
                            </div>
                            <p class="text-xs text-black mt-4 mb-1">QR Code PIX</p>
                            <div id="qrcode-container" class="qrcode-container"></div> <!-- Container para o QR Code -->
                        </div>
                    </div>
                </label>
            </div>

            <!-- Input de Troco (para Dinheiro) -->
            <div id="troco-input-container" class="hidden mt-4 mb-6 p-4 border border-gray-300 rounded-lg bg-gray-50">
                <label for="trocoPara" class="block text-gray-700 text-sm font-bold mb-2">
                    Troco para (R$):
                </label>
                <input type="number" id="trocoPara" step="0.01" min="0" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mb-2">
                <p class="text-gray-600 text-sm">
                    Troco total: <span id="trocoTotalDisplay" class="font-bold text-red-600">R$ 0,00</span>
                </p>
            </div>

            <button id="confirm-payment-method-btn" class="px-6 py-3 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition w-full">
                Confirmar Pagamento
            </button>
        </div>
    </div>

    <!-- Modal de Endereço -->
    <div id="address-input-modal" class="address-modal">
        <div class="modal-content">
            <span class="close-button" id="close-address-modal">&times;</span>
            <h3 class="text-xl font-bold text-gray-800 mb-4">Informe seus Dados</h3>
             <div class="mb-4">
                <label for="clientNameInput" class="block text-gray-700 text-sm font-bold mb-2">
                    Nome do Cliente:
                </label>
                <input type="text" id="clientNameInput" placeholder="Seu nome" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>
            <div class="mb-4">
                <label for="contactInput" class="block text-gray-700 text-sm font-bold mb-2">
                    Contato (Telefone):
                </label>
                <input type="tel" id="contactInput" placeholder="(99) 99999-9999" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>
            <div id="address-fields-container">
                <div class="mb-4">
                    <label for="neighborhoodSelect" class="block text-gray-700 text-sm font-bold mb-2">
                        Bairro:
                    </label>
                    <select id="neighborhoodSelect" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <option value="">Selecione um bairro</option>
                        <!-- Opções de bairro geradas pelo JS -->
                    </select>
                </div>
                <div class="mb-4">
                    <label for="streetInput" class="block text-sm font-medium text-gray-700 mb-2">
                        Rua:
                    </label>
                    <input type="text" id="streetInput" placeholder="Nome da Rua" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div class="mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <label for="numberInput" class="block text-gray-700 text-sm font-bold">
                            Número:
                        </label>
                        <div class="flex items-center">
                            <input type="checkbox" id="noNumberCheckbox" class="form-checkbox text-red-600">
                            <label for="noNumberCheckbox" class="ml-2 text-gray-700 text-sm">Sem Número</label>
                        </div>
                    </div>
                    <input type="number" inputmode="numeric" id="numberInput" placeholder="Número" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div class="mb-6">
                    <label for="referencePointInput" class="block text-gray-700 text-sm font-bold mb-2">
                        Ponto de Referência (Opcional):
                    </label>
                    <input type="text" id="referencePointInput" placeholder="Ex: Próximo à praça" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
            </div>
            <button id="confirmAddressBtn" class="btn-confirm-green w-full py-2 px-4 rounded-full text-white font-bold transition duration-300">
                Confirmar Dados
            </button>
        </div>
    </div>

    <!-- Modal para perguntar sobre adicionais -->
    <div id="ask-pizza-extras-modal" class="message-modal">
        <div class="modal-content">
            <p class="text-lg font-semibold text-gray-800 mb-4" id="ask-extras-title"></p>
            <p class="text-gray-600 mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="ask-extras-no-btn" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-lg font-bold hover:bg-gray-400 transition">Não, obrigado</button>
                <button id="ask-extras-yes-btn" class="px-6 py-2 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition">Sim, quero!</button>
            </div>
        </div>
    </div>


  <!-- Modal de Confirmação de Pedido Duplicado -->
<div id="duplicate-confirm-modal" class="message-modal">
    <div class="modal-content">
        <span class="close-button" id="close-duplicate-confirm-modal">&times;</span>
        <p class="text-lg font-semibold text-gray-800 mb-4">Pedido Semelhante Encontrado</p>
        <p id="duplicate-confirm-message" class="text-gray-600 mb-6">Esse pedido foi registrado há X minutos. Gostaria de pedir novamente esse mesmo pedido?</p>
        <div class="flex justify-center gap-4">
            <button id="duplicate-confirm-no-btn" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-lg font-bold hover:bg-gray-400 transition">Não</button>
            <button id="duplicate-confirm-yes-btn" class="px-6 py-2 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition">Sim, pedir novamente</button>
        </div>
    </div>
</div>


    <!-- Modal para construir adicionais da pizza -->
    <div id="pizza-extras-builder-modal" class="modal">
        <div class="modal-content builder-modal">
            <span class="close-button" id="close-pizza-extras-builder-modal">&times;</span>
            <h3 class="text-xl font-bold text-gray-800 mb-4" id="pizza-extras-builder-title"></h3>
            <div id="pizza-extras-scope-buttons" class="flex flex-wrap gap-2 mb-4 border-b pb-4">
                <!-- Botões de escopo serão inseridos aqui -->
            </div>
            <div id="pizza-extras-ingredients-container" class="mb-4 max-h-80 overflow-y-auto p-2"></div>
            <div class="flex justify-between items-center bg-gray-100 p-4 rounded-lg mt-4">
                <span class="text-lg font-bold">Total da Pizza:</span>
                <span id="pizza-extras-total-price" class="text-2xl font-bold text-red-600">R$ 0,00</span>
            </div>
            <button id="add-pizza-with-extras-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-full transition w-full mt-4">
                Confirmar Adicionais
            </button>
        </div>
    </div>

    <footer class="bg-gray-800 text-white py-8 px-4">
        <div class="max-w-6xl mx-auto">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-center md:text-left">
                <div>
                    <h3 class="xl font-bold mb-4">Sâmia</h3>
                    <p class="text-gray-400">Bem-vindo à Samia! Um cardápio completo com pizzas especiais, hambúrgueres artesanais, petiscos crocantes, pastéis irresistíveis, sucos naturais e vitaminas deliciosas.</p>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4">Horário de Funcionamento</h3>
                    <p class="text-gray-400">De Segunda a Quarta: 17:30 - 23:00</p>
                    <p class="text-gray-400">De Sexta a Domingo: 17:30 - 00:00</p>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4">Contato</h3>
                    <p class="text-gray-400"><i class="fas fa-phone mr-2"></i> <span id="footer-phone"></span></p>
                    <p class="text-gray-400"><i class="fas fa-envelope mr-2"></i> <span id="footer-email"></span></p>
                    <div class="flex justify-center md:justify-start space-x-4 mt-2" id="social-links-container">
                         <!-- Links de redes sociais gerados pelo JS -->
                    </div>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-8 pt-6 text-center text-gray-400">
                <p class="mb-2">
                    <a href="https://wa.me/5587996070638?text=Ol%C3%A1%20vi%20o%20card%C3%A1pio%20digital%20desenvolveu%20para%20Pizzaria%20S%C3%A2mia%20e%20fiquei%20interessado%2C%20gostaria%20de%20solicitar%20um%20or%C3%A7amento%20para%20o%20meu%20projeto" target="_blank" class="hover:text-white">Desenvolvido por Willian Soares</a>
                </p>
                <p>&copy; 2025 Sâmia. Todos os direitos reservados.</p>
            </div>
        </div>
    </footer>

    <!-- SCRIPTS -->
    <script type="module">
        // Importa as funções do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', function() {
// Suas credenciais do Firebase
const firebaseConfig = {
  apiKey: "AIzaSyB9LJ-7bOvHGYyFE_H2Qd7XFcyjmSPq_ro",
  authDomain: "samia-cardapio.firebaseapp.com",
  projectId: "samia-cardapio",
  storageBucket: "samia-cardapio.firebasestorage.app",
  messagingSenderId: "223260436641",
  appId: "1:223260436641:web:adf78e77a0267f66f1e8e0"
};


            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            // --- FIM DA CONFIGURAÇÃO DO FIREBASE ---

            // Variáveis de estado
            let order = []; // Armazena os itens do pedido atual
            let allMenuData = []; // Armazena todos os itens do cardápio carregados
            let allPromotionsData = []; // Armazena todas as promoções carregadas
            let deliveryFeesData = []; // Armazena as taxas de entrega por bairro
            let allBurgerIngredients = {}; // Armazena ingredientes de hambúrguer por categoria
            let allPizzaIngredients = {}; // Armazena ingredientes extras de pizza por categoria
            let isSelectingHalfPizza = false; // Flag para indicar seleção de meia pizza
            let isFirstHalfPromotional = false; // Flag para regra de meia pizza promocional
            let deferredPrompt; // Para o prompt de instalação do PWA
            let selectedPaymentMethod = null; // Armazena a forma de pagamento selecionada
            let isCheckoutInitiated = false; // Controla se o checkout foi iniciado (para fluxo de modais)
            let discountPromotion = null; // Armazena a promoção de desconto (se ativa)
            let contactInfo = {}; // Armazena informações de contato da empresa
            let isPickupOrder = false; // Flag para indicar se é pedido para retirada
            let currentBurgerBasePrice = 0; // Preço base do hambúrguer sendo montado
            let itemVisibility = {}; // Status de visibilidade dos itens (Firestore)
            let unavailableItems = {}; // Status de disponibilidade dos itens (Firestore)
            let ingredientVisibility = {}; // Status de visibilidade dos ingredientes (Firestore)
            let ingredientStatus = {}; // Status de disponibilidade dos ingredientes (Firestore)
            let extraVisibility = {}; // Status de visibilidade dos adicionais (Firestore)
            let extraStatus = {}; // Status de disponibilidade dos adicionais (Firestore)
            let pizzaHalfStatus = {}; // Status de permissão de meia-meia (Firestore)
            let itemExtrasStatus = {}; // Status de permissão de adicionais por item (Firestore)
            let currentPizzaExtrasState = {}; // Estado atual dos adicionais sendo editados

            // Estado do endereço selecionado
            let selectedAddress = {
                clientName: null,
                telefone: null,
                bairro: null,
                rua: null,
                numero: null,
                referencia: null,
                deliveryFee: 0.00
            };

            // URL da imagem padrão
            const defaultImage = 'https://www.bakelitsul.com.br/Assets/img/sem-produto-detalhe.png';

            // Seletores de elementos do DOM (constantes para performance)
            const orderSidebar = document.getElementById('orderSidebar');
            const cartCount = document.getElementById('cartCount');
            const orderItemsContainer = document.getElementById('orderItems');
            const emptyOrderMessage = document.getElementById('emptyOrderMessage');
            const messageModal = document.getElementById('message-modal');
            const messageModalText = document.getElementById('message-modal-text');
            const promotionPopup = document.getElementById('promotion-popup');
            const closePromotionPopupBtn = document.getElementById('close-promotion-popup');
            const closePromotionPopupBtnBottom = document.getElementById('close-promotion-popup-btn');
            const promotionsListEl = document.getElementById('promotions-list');
            const promotionButton = document.getElementById('promotion-button');
            const cartButton = document.getElementById('cart-button');
            const subtotalEl = document.getElementById('subtotal');
            const deliveryFeeDisplay = document.getElementById('deliveryFeeDisplay');
            const totalEl = document.getElementById('total');
            const checkoutButton = document.getElementById('checkoutButton');
            const closeSidebarBtn = document.getElementById('close-sidebar-btn');
            const backToMenuBtn = document.getElementById('back-to-menu-btn');
            const pizzaOptionModal = document.getElementById('pizza-option-modal');
            const closePizzaOptionModalBtn = document.getElementById('close-pizza-option-modal');
            const modalPizzaName = document.getElementById('modal-pizza-name');
            const modalPizzaDescription = document.getElementById('modal-pizza-description');
            const pizzaSizeOptions = document.getElementById('pizza-size-options');
            const burgerBuilderModal = document.getElementById('burger-builder-modal');
            const closeBurgerBuilderModalBtn = document.getElementById('close-burger-builder-modal');
            const burgerIngredientsContainer = document.getElementById('burger-ingredients-container');
            const burgerTotalPriceEl = document.getElementById('burger-total-price');
            const addCustomBurgerBtn = document.getElementById('add-custom-burger-btn');
            const drinkSuggestionModal = document.getElementById('drink-suggestion-modal');
            const closeDrinkSuggestionModalBtn = document.getElementById('close-drink-suggestion-modal');
            const suggestedDrinksList = document.getElementById('suggested-drinks-list');
            const proceedWithoutDrinksBtn = document.getElementById('proceed-without-drinks');
            const confirmNoDrinkModal = document.getElementById('confirm-no-drink-modal');
            const closeConfirmNoDrinkModalBtn = document.getElementById('close-confirm-no-drink-modal');
            const confirmNoDrinkYesBtn = document.getElementById('confirm-no-drink-yes');
            const confirmNoDrinkNoBtn = document.getElementById('confirm-no-drink-no-btn');
            const installPromptModal = document.getElementById('install-prompt-modal');
            const closeInstallPromptModalBtn = document.getElementById('close-install-prompt-modal');
            const installAppButton = document.getElementById('install-app-button');
            const paymentMethodModal = document.getElementById('payment-method-modal');
            const closePaymentMethodModalBtn = document.getElementById('close-payment-method-modal');
            const paymentOptionsContainer = document.getElementById('payment-options-container');
            const confirmPaymentMethodBtn = document.getElementById('confirm-payment-method-btn');
            const trocoInputContainer = document.getElementById('troco-input-container');
            const trocoParaInput = document.getElementById('trocoPara');
            const trocoTotalDisplay = document.getElementById('trocoTotalDisplay');
            const paymentModalTotal = document.getElementById('payment-modal-total');
            const pixKeyContainer = document.getElementById('pix-key-container');
            const pixDetailsContainer = document.getElementById('pix-details-container');
            const pixKeyDisplay = document.getElementById('pix-key-display');
            const copyPixBtn = document.getElementById('copy-pix-btn');
            const copyFeedback = document.getElementById('copy-feedback');
            const addressInputModal = document.getElementById('address-input-modal');
            const closeAddressModalBtn = document.getElementById('close-address-modal');
            const clientNameInput = document.getElementById('clientNameInput');
            const contactInput = document.getElementById('contactInput');
            const neighborhoodSelect = document.getElementById('neighborhoodSelect');
            const streetInput = document.getElementById('streetInput');
            const numberInput = document.getElementById('numberInput');
            const noNumberCheckbox = document.getElementById('noNumberCheckbox');
            const referencePointInput = document.getElementById('referencePointInput');
            const confirmAddressBtn = document.getElementById('confirmAddressBtn');
            const addressSummarySection = document.getElementById('address-summary-section');
            const clientNameDisplay = document.getElementById('client-name-display');
            const contactDisplay = document.getElementById('contact-display');
            const addressDisplay = document.getElementById('address-display');
            const neighborhoodDisplay = document.getElementById('neighborhood-display');
            const referenceDisplay = document.getElementById('reference-display');
            const editAddressBtn = document.getElementById('editAddressBtn');
            const informAddressBtn = document.getElementById('informAddressBtn');
            const editDeliveryAddressBtn = document.getElementById('editDeliveryAddressBtn');
            const discountSection = document.getElementById('discount-section');
            const discountPercentageDisplay = document.getElementById('discount-percentage-display');
            const discountValueDisplay = document.getElementById('discount-value-display');
            const footerPhone = document.getElementById('footer-phone');
            const footerEmail = document.getElementById('footer-email');
            const socialLinksContainer = document.getElementById('social-links-container');
            const pickupCheckbox = document.getElementById('pickupCheckbox');
            const addressFieldsContainer = document.getElementById('address-fields-container');
            const askPizzaExtrasModal = document.getElementById('ask-pizza-extras-modal');
            const askExtrasTitle = document.getElementById('ask-extras-title');
            const askExtrasYesBtn = document.getElementById('ask-extras-yes-btn');
            const askExtrasNoBtn = document.getElementById('ask-extras-no-btn');
            const pizzaExtrasBuilderModal = document.getElementById('pizza-extras-builder-modal');
            const pizzaExtrasBuilderTitle = document.getElementById('pizza-extras-builder-title');
            const closePizzaExtrasBuilderModalBtn = document.getElementById('close-pizza-extras-builder-modal');
            const pizzaExtrasIngredientsContainer = document.getElementById('pizza-extras-ingredients-container');
            const pizzaExtrasTotalPrice = document.getElementById('pizza-extras-total-price');
            const addPizzaWithExtrasBtn = document.getElementById('add-pizza-with-extras-btn');

            // Variáveis auxiliares
            let currentPizzaData = {}; // Armazena dados da pizza selecionada para o modal de opções
            let firstHalfPizza = null; // Armazena dados da primeira metade da pizza
            let isSelectingSecondHalf = false; // Flag para indicar seleção da segunda metade
            let qrCodeInstance = null; // Instância do QRCode.js
            let isScrollingFromClick = false; // Evita que o observer de categoria atualize durante scroll programático
            let categoryObserver; // Intersection Observer para categorias
            let firstPizzaSectionId = null; // ID da primeira seção de pizza (para scroll em caso de erro)

            // Definição dos tamanhos de pizza
            const sizes = [
                { slices: 4, label: '4 Fatias', priceKey: 'price4Slices' },
                { slices: 6, label: '6 Fatias', priceKey: 'price6Slices' },
                { slices: 8, label: '8 Fatias', priceKey: 'basePrice' },
                { slices: 10, label: '10 Fatias', priceKey: 'price10Slices' }
            ];

            // --- FUNÇÕES UTILITÁRIAS ---

            // Calcula e formata a diferença de tempo
            function formatTimeDifference(timestampMillis) {
                if (!timestampMillis) return 'há pouco tempo';
                const now = Date.now();
                // Calcula a diferença em SEGUNDOS, já considerando o sinal
                const differenceSeconds = Math.round((now - timestampMillis) / 1000);

                // Se for negativo, mostra como "há 0 segundos" (ou outra mensagem)
                if (differenceSeconds < 0) {
                    // return `há ${Math.abs(differenceSeconds)} segundo(s) no futuro?`; // Debug
                    return 'há menos de 1 segundo'; // Mensagem mais amigável
                } else if (differenceSeconds < 60) {
                    return `há ${differenceSeconds} segundo${differenceSeconds !== 1 ? 's' : ''}`;
                } else if (differenceSeconds < 3600) {
                    const minutes = Math.floor(differenceSeconds / 60);
                    return `há ${minutes} minuto${minutes > 1 ? 's' : ''}`;
                } else if (differenceSeconds < 86400) {
                    const hours = Math.floor(differenceSeconds / 3600);
                    return `há ${hours} hora${hours > 1 ? 's' : ''}`;
                } else {
                    const days = Math.floor(differenceSeconds / 86400);
                    return `há ${days} dia${days > 1 ? 's' : ''}`;
                }
            }


            // Formata o nome do produto para exibição (adiciona categoria se necessário)
            function formatProductName(name, category) {
                if (!category) return name;

                let lowerCaseCategory = category.toLowerCase();

                // Regras mais específicas para o português
                if (lowerCaseCategory.endsWith('ais')) {
                    lowerCaseCategory = lowerCaseCategory.slice(0, -3) + 'al'; // Tradicionais -> Tradicional
                } else if (lowerCaseCategory.endsWith('es')) {
                    lowerCaseCategory = lowerCaseCategory.slice(0, -2); // Doces -> Doce
                } else if (lowerCaseCategory.endsWith('s')) {
                    lowerCaseCategory = lowerCaseCategory.slice(0, -1); // Pizzas -> Pizza
                }

                const lowerCaseName = name.toLowerCase();

                if (!lowerCaseName.includes(lowerCaseCategory)) {
                    if (category.toLowerCase().includes('pizza')) {
                        return `${capitalizeFirstLetter(lowerCaseCategory)} de ${name}`;
                    }
                    return `${capitalizeFirstLetter(lowerCaseCategory)} ${name}`;
                }
                return name;
            }

            // Formata o nome da categoria de pizza para exibição
            function formatPizzaCategory(category) {
                if (!category) return 'PIZZAS';
                const upperCategory = category.toUpperCase();
                if (upperCategory.startsWith('PIZZA')) {
                    return category;
                }
                return `PIZZA(s) ${upperCategory}`;
            }

            // Verifica se o PWA está instalado
            function isPwaInstalled() {
                if (window.matchMedia('(display-mode: standalone)').matches) {
                    return true;
                }
                if (navigator.standalone) { // Para iOS
                    return true;
                }
                return false;
            }

            // Alterna a visibilidade da sidebar do pedido
            function toggleOrderSidebar() {
                orderSidebar.classList.toggle('translate-x-full');
                orderSidebar.classList.toggle('translate-x-0');

                if (orderSidebar.classList.contains('translate-x-0')) {
                    // Quando a sidebar abre, esconde o botão de promoções
                    promotionButton.style.display = 'none';
                    // Rola para o final da sidebar
                    orderSidebar.scrollTop = orderSidebar.scrollHeight;
                } else {
                    // Quando a sidebar fecha, verifica se o botão de promoções deve ser exibido
                    updatePromotionButtonVisibility();
                }
            }

            // Fecha a sidebar do pedido
            function closeOrderSidebar() {
                orderSidebar.classList.add('translate-x-full');
                orderSidebar.classList.remove('translate-x-0');
                updatePromotionButtonVisibility(); // Verifica a visibilidade do botão de promoções
            }

            // Exibe um modal de mensagem simples
            function showMessageModal(message, onOkCallback = null) {
                messageModalText.textContent = message;
                messageModal.style.display = 'flex';
                updatePromotionButtonVisibility(); // Esconde o botão de promoções se um modal abrir

                // Remove listeners antigos para evitar chamadas múltiplas
                let okBtn = document.getElementById('ok-message-modal');
                let closeBtn = document.getElementById('close-message-modal');

                // Recria os botões para garantir que apenas um listener seja anexado
                const newOkBtn = okBtn.cloneNode(true);
                okBtn.parentNode.replaceChild(newOkBtn, okBtn);
                const newCloseBtn = closeBtn.cloneNode(true);
                closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);

                // Função para fechar o modal e chamar o callback
                const hideAndCallback = () => {
                    hideMessageModal();
                    if (onOkCallback) onOkCallback();
                };

                // Adiciona os novos listeners
                newOkBtn.addEventListener('click', hideAndCallback);
                newCloseBtn.addEventListener('click', hideAndCallback);
                // Listener para fechar clicando fora
                messageModal.onclick = (event) => {
                    if (event.target === messageModal) {
                        hideAndCallback();
                    }
                };
            }

            // Esconde o modal de mensagem simples
            function hideMessageModal() {
                messageModal.style.display = 'none';
                updatePromotionButtonVisibility(); // Verifica a visibilidade do botão de promoções ao fechar
            }

            // Cancela a seleção de meia pizza em andamento
            function resetHalfPizzaSelection() {
                if (isSelectingHalfPizza && firstHalfPizza) {
                    // Remove o item temporário 'pending-half-pizza' do pedido se existir
                    const pendingHalfIndex = order.findIndex(orderItem => orderItem.id === 'pending-half-pizza');
                    if (pendingHalfIndex > -1) {
                        order.splice(pendingHalfIndex, 1);
                        updateOrderDisplay(); // Atualiza a sidebar
                    }
                    // Reseta as flags
                    firstHalfPizza = null;
                    isSelectingSecondHalf = false;
                    isSelectingHalfPizza = false;
                    isFirstHalfPromotional = false;
                    toggleAddItemButtons(true); // Reabilita todos os botões de adicionar
                    toggleCategoryButtons(true); // Reabilita todos os botões de categoria
                    showMessageModal('Seleção de meia pizza cancelada.');
                }
            }

             // Atualiza a interface principal (categorias e itens)
             function updateUI() {
                // Filtra os itens principais com base na visibilidade do Firestore
                const visibleItems = allMenuData.filter(item => itemVisibility[item.id] !== false);

                // Cria as categorias e o menu com os itens filtrados
                const orderedCategories = [];
                const seenCategories = new Set();
                visibleItems.forEach(item => {
                    if (item.category && !seenCategories.has(item.category)) {
                        seenCategories.add(item.category);
                        orderedCategories.push(item.category);
                    }
                });

                createCategoryButtons(orderedCategories); // Cria/Recria botões de categoria
                populateMenu(visibleItems, orderedCategories); // Preenche o menu com os itens
                setupCategoryObserver(); // Reconfigura o observer de scroll
            }

            // Atualiza o conteúdo de popups abertos se os dados (disponibilidade) mudarem
            function refreshOpenPopups() {
                 if (burgerBuilderModal.style.display === 'flex') {
                    const currentBurgerId = burgerBuilderModal.dataset.burgerId;
                    const orderIndex = burgerBuilderModal.dataset.editIndex;
                    const burgerItem = allMenuData.find(item => item.id === currentBurgerId);
                    if (burgerItem) {
                        const existingItem = orderIndex ? order[parseInt(orderIndex)] : null;
                        // Reabre o modal com dados atualizados (inclusive disponibilidade de ingredientes)
                        openBurgerBuilderModal(burgerItem, orderIndex ? parseInt(orderIndex) : null, existingItem);
                    }
                }
                if(pizzaExtrasBuilderModal.style.display === 'flex') {
                    const orderIndex = parseInt(pizzaExtrasBuilderModal.dataset.orderIndex);
                    if(!isNaN(orderIndex) && order[orderIndex]){
                         // Reabre o modal de extras com dados atualizados
                        openPizzaExtrasBuilderModal(orderIndex);
                    }
                }
            }

            // Escuta por mudanças nos status/visibilidade no Firestore e atualiza a UI
            function listenToControls() {
                onSnapshot(doc(db, "config", "item_status"), (doc) => {
                    unavailableItems = doc.exists() ? doc.data() : {};
                    updateUI(); // Atualiza a lista de itens
                    if (drinkSuggestionModal.style.display === 'flex') {
                        refreshDrinkSuggestionModal(); // Atualiza sugestões se o modal estiver aberto
                    }
                });
                onSnapshot(doc(db, "config", "item_visibility"), (doc) => {
                    itemVisibility = doc.exists() ? doc.data() : {};
                    updateUI(); // Atualiza a lista de itens
                    if (drinkSuggestionModal.style.display === 'flex') {
                        refreshDrinkSuggestionModal(); // Atualiza sugestões se o modal estiver aberto
                    }
                });
                onSnapshot(doc(db, "config", "pizza_half_status"), (doc) => {
                    pizzaHalfStatus = doc.exists() ? doc.data() : {};
                    // Atualiza a propriedade 'allowHalf' em todos os itens de pizza
                    allMenuData.forEach(item => {
                        if (item.isPizza && item.id) {
                            item.allowHalf = pizzaHalfStatus[item.id] !== false;
                        }
                    });
                    // Se o modal de opções de pizza estiver aberto, atualiza suas opções
                    if (pizzaOptionModal.style.display === 'flex' && currentPizzaData.id) {
                        const updatedPizza = allMenuData.find(p => p.id === currentPizzaData.id);
                        if (updatedPizza) {
                            renderPizzaOptions(updatedPizza);
                        }
                    }
                });
                 onSnapshot(doc(db, "config", "item_extras_status"), (doc) => {
                    itemExtrasStatus = doc.exists() ? doc.data() : {};
                     // Atualiza a propriedade 'acceptsExtras' em todos os itens
                    allMenuData.forEach(item => {
                        if (item.id) {
                           const defaultExtras = item.isPizza; // Pizzas aceitam por padrão
                           item.acceptsExtras = itemExtrasStatus[item.id] === undefined ? defaultExtras : itemExtrasStatus[item.id];
                        }
                    });
                     // Atualiza o pedido atual também, caso algum item já esteja no carrinho
                     order.forEach(orderItem => {
                         if(orderItem.id && orderItem.type !== 'promotion') {
                             const originalItem = allMenuData.find(menuItem => menuItem.name === (orderItem.name.split(': ')[1] || orderItem.name)); // Encontra o item original
                              if(originalItem) {
                                const defaultExtras = originalItem.isPizza;
                                orderItem.acceptsExtras = itemExtrasStatus[originalItem.id] === undefined ? defaultExtras : itemExtrasStatus[originalItem.id];
                             }
                         }
                     });
                     updateOrderDisplay(); // Atualiza a sidebar para mostrar/esconder botões de extras
                });
                onSnapshot(doc(db, "config", "ingredient_status"), (doc) => {
                    ingredientStatus = doc.exists() ? doc.data() : {};
                    refreshOpenPopups(); // Atualiza modais abertos (montador de hambúrguer)
                });
                onSnapshot(doc(db, "config", "ingredient_visibility"), (doc) => {
                    ingredientVisibility = doc.exists() ? doc.data() : {};
                    refreshOpenPopups(); // Atualiza modais abertos
                });
                onSnapshot(doc(db, "config", "extra_status"), (doc) => {
                    extraStatus = doc.exists() ? doc.data() : {};
                    refreshOpenPopups(); // Atualiza modais abertos (adicionais de pizza)
                });
                onSnapshot(doc(db, "config", "extra_visibility"), (doc) => {
                    extraVisibility = doc.exists() ? doc.data() : {};
                    refreshOpenPopups(); // Atualiza modais abertos
                });
            }

            // Preenche a seção do menu com os itens carregados e filtrados
            function populateMenu(menuItems, orderedCategories) {
                const dynamicSectionsContainer = document.getElementById('dynamic-pizza-sections');
                dynamicSectionsContainer.innerHTML = ''; // Limpa antes de recriar
                firstPizzaSectionId = null; // Reseta o ID da primeira seção de pizza

                // Agrupa itens por categoria
                const itemsByCategory = {};
                menuItems.forEach(item => {
                    if (item.category) {
                        if (!itemsByCategory[item.category]) {
                            itemsByCategory[item.category] = [];
                        }
                        itemsByCategory[item.category].push(item);
                    }
                });

                // Cria as seções HTML para cada categoria na ordem definida
                orderedCategories.forEach(category => {
                    const sectionId = `${category.toLowerCase().replace(/\s+/g, '-')}-section`;
                    let sectionEl = document.getElementById(sectionId); // Tenta encontrar seção existente

                    if (!sectionEl) { // Se não existe, cria
                        sectionEl = document.createElement('div');
                        sectionEl.id = sectionId;
                        sectionEl.dataset.category = category; // Armazena a categoria no elemento
                        sectionEl.className = 'pizza-category-section mb-8';

                        // Verifica se é uma categoria de pizza para formatação do título e scroll
                        const isPizzaCategory = itemsByCategory[category] && itemsByCategory[category].some(item => item.isPizza);
                        if (isPizzaCategory && !firstPizzaSectionId) {
                            firstPizzaSectionId = sectionId; // Guarda o ID da primeira seção de pizza
                        }
                        const title = isPizzaCategory ? `Pizzas ${capitalizeFirstLetter(category)}` : capitalizeFirstLetter(category);

                        // Cria a estrutura da seção
                        sectionEl.innerHTML = `
                            <h3 class="text-xl font-bold text-white p-2 rounded-md bg-red-600 mb-6">${title}</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="${category}-items"></div>
                        `;
                        dynamicSectionsContainer.appendChild(sectionEl);
                    }

                    // Preenche a seção com os itens da categoria
                    const categoryItemsEl = document.getElementById(`${category}-items`);
                    categoryItemsEl.innerHTML = ''; // Limpa itens antigos da categoria

                    if (itemsByCategory[category]) {
                        itemsByCategory[category].forEach(item => {
                            let itemHtml = '';
                            const isUnavailable = unavailableItems[item.id] === false; // Verifica disponibilidade

                            // Lógica para imagem (com placeholder)
                            const trimmedImageUrl = String(item.imageUrl || '').trim();
                            let imageElement = '';
                            if (trimmedImageUrl.toLowerCase() === 'sem imagem' || !trimmedImageUrl) {
                                imageElement = `<div class="no-image-placeholder">Sâmia</div>`;
                            } else {
                                imageElement = `<img src="${trimmedImageUrl}" alt="Imagem de ${item.name}" class="w-full h-40 object-cover" onerror="this.parentElement.innerHTML = '<div class=\\'no-image-placeholder\\'>Sâmia</div>';">`;
                            }

                            // Define classes e atributos com base na disponibilidade
                            const cardOpacityClass = isUnavailable ? 'opacity-60' : '';
                            const buttonDisabledAttr = isUnavailable ? 'disabled' : '';
                            const buttonText = isUnavailable ? 'Esgotado' : (item.isCustomizable ? 'Montar' : 'Adicionar');
                            const buttonClasses = isUnavailable
                                ? 'bg-gray-400 cursor-not-allowed'
                                : 'bg-red-600 hover:bg-red-700';

                            // Cria o HTML do card do item (diferente para pizza e outros itens)
                            if (item.isPizza) {
                                // HTML para card de pizza (com múltiplos preços)
                                let pricesHtml = '<div class="flex flex-col items-start">';
                                let pricesRow1 = '';
                                let pricesRow2 = '';
                                // Adiciona preços dos tamanhos disponíveis
                                if (item.price4Slices > 0) pricesRow1 += `<div class="text-center px-1"><span class="text-xs text-gray-500">4 Fatias</span><p class="font-bold text-red-600 whitespace-nowrap">R$ ${item.price4Slices.toFixed(2).replace('.', ',')}</p></div>`;
                                if (item.price6Slices > 0) pricesRow1 += `<div class="text-center ml-2 border-l border-gray-200 pl-2"><span class="text-xs text-gray-500">6 Fatias</span><p class="font-bold text-red-600 whitespace-nowrap">R$ ${item.price6Slices.toFixed(2).replace('.', ',')}</p></div>`;
                                if (item.basePrice > 0) pricesRow2 += `<div class="text-center px-1"><span class="text-xs text-gray-500">8 Fatias</span><p class="font-bold text-red-600 whitespace-nowrap">R$ ${item.basePrice.toFixed(2).replace('.', ',')}</p></div>`;
                                if (item.price10Slices > 0) pricesRow2 += `<div class="text-center ml-2 border-l border-gray-200 pl-2"><span class="text-xs text-gray-500">10 Fatias</span><p class="font-bold text-red-600 whitespace-nowrap">R$ ${item.price10Slices.toFixed(2).replace('.', ',')}</p></div>`;
                                // Monta as linhas de preço
                                if (pricesRow1) pricesHtml += `<div class="flex justify-center items-center">${pricesRow1}</div>`;
                                if (pricesRow2) pricesHtml += `<div class="flex justify-center items-center mt-2">${pricesRow2}</div>`;
                                pricesHtml += '</div>';

                                itemHtml = `
                                    <div class="flavor-card bg-white rounded-xl overflow-hidden shadow-lg flex flex-col ${cardOpacityClass}">
                                        ${imageElement}
                                        <div class="p-6 flex flex-col flex-grow">
                                            <h3 class="text-xl font-bold text-gray-800 mb-2">${item.name}</h3>
                                            <p class="text-gray-600 text-sm mb-4 flex-grow">${item.description}</p>
                                            <div class="mt-auto pt-4 border-t border-gray-100">
                                                <div class="flex justify-between items-center">
                                                    ${pricesHtml}
                                                    <button class="add-item-btn ${buttonClasses} text-white px-4 py-2 rounded-full text-sm font-medium transition duration-300 flex-shrink-0 ml-4"
                                                            data-item-id="${item.id}" data-image-url="${trimmedImageUrl}" ${buttonDisabledAttr}>
                                                        ${buttonText}
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            } else {
                                // HTML para card de item normal (preço único)
                                itemHtml = `
                                    <div class="flavor-card bg-white rounded-xl overflow-hidden shadow-lg ${cardOpacityClass}">
                                        ${imageElement}
                                        <div class="p-6">
                                            <h3 class="text-xl font-bold text-gray-800 mb-2">${item.name}</h3>
                                            <p class="text-gray-600 text-sm mb-4">${item.description}</p>
                                            <div class="flex justify-between items-center">
                                                <span class="font-bold text-red-600 text-lg">R$ ${item.basePrice.toFixed(2).replace('.', ',')}</span>
                                                <button class="add-item-btn ${buttonClasses} text-white px-4 py-2 rounded-full text-sm font-medium transition duration-300"
                                                        data-item-id="${item.id}" ${buttonDisabledAttr}>
                                                    ${buttonText}
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }
                            // Adiciona o HTML do item à sua categoria
                            categoryItemsEl.insertAdjacentHTML('beforeend', itemHtml);
                        });
                    }
                });

                // Reanexa os listeners aos botões "Adicionar" após recriar os cards
                attachAddButtonListeners();
            }

            // Carrega todos os dados do menu (itens, promoções, taxas, ingredientes) da API
            async function loadMenuAndRender() {
                try {
                    const response = await fetch('/api/menu'); // Faz a requisição para a API
                    if (!response.ok) throw new Error(`Erro ao buscar dados da API: ${response.statusText}`);

                    const data = await response.json(); // Converte a resposta para JSON

                    // Processa os dados recebidos
                    allMenuData = data.cardapio; // Itens principais
                    allPromotionsData = data.promocoes; // Promoções
                    deliveryFeesData = data.deliveryFees; // Taxas de entrega

                    // Organiza ingredientes de hambúrguer por categoria
                    const rawBurgerIngredients = data.ingredientesHamburguer;
                    allBurgerIngredients = rawBurgerIngredients.reduce((acc, current) => {
                        const category = current.category || 'Outros';
                        if (!acc[category]) acc[category] = [];
                        acc[category].push(current);
                        return acc;
                    }, {});

                    // Organiza adicionais de pizza por categoria
                    const rawPizzaIngredients = data.ingredientesPizza || [];
                     allPizzaIngredients = rawPizzaIngredients.reduce((acc, current) => {
                        const category = current.category || 'Adicionais';
                        if (!acc[category]) acc[category] = [];
                        acc[category].push(current);
                        return acc;
                    }, {});

                    // Processa informações de contato
                    contactInfo = data.contact.reduce((acc, curr) => {
                        if (curr.data && curr.value) acc[curr.data.toLowerCase().replace(/[^a-z0-9]/g, '')] = curr.value;
                        return acc;
                    }, {});

                    // Verifica se existe promoção de desconto ativa
                    discountPromotion = allPromotionsData.find(promo => promo.name === 'Desconto no Pedido' && promo.active);

                    // Inicia a escuta por mudanças de status/visibilidade no Firestore
                    listenToControls();

                    // Preenche elementos da interface com dados carregados
                    populateNeighborhoodDropdown(deliveryFeesData); // Dropdown de bairros no modal de endereço
                    populateContactInfo(data.contact); // Informações no rodapé
                    updatePromotionButtonVisibility(); // Exibe ou esconde botão de promoções
                    updateCartCount(); // Atualiza contador do carrinho
                    updateOrderDisplay(); // Atualiza a sidebar do pedido
                    updateCheckoutButtonText(); // Define texto inicial do botão de finalizar
                    showAddressSummary(); // Exibe resumo do endereço se já houver dados

                } catch (error) {
                    console.error('Erro ao carregar o cardápio:', error);
                    showMessageModal('Não foi possível carregar o cardápio no momento. Por favor, tente novamente mais tarde.');
                }
            }

            // Abre o modal para montar hambúrguer
            function openBurgerBuilderModal(baseBurgerItem, editIndex = null, existingItem = null) {
                burgerBuilderModal.dataset.burgerId = baseBurgerItem.id; // Guarda ID do hambúrguer base
                burgerBuilderModal.dataset.editIndex = editIndex !== null ? editIndex : ''; // Guarda índice se estiver editando
                burgerIngredientsContainer.innerHTML = ''; // Limpa ingredientes anteriores
                currentBurgerBasePrice = baseBurgerItem.basePrice; // Define preço base

                // Itera sobre as categorias de ingredientes
                for (const categoryName in allBurgerIngredients) {
                    const ingredients = allBurgerIngredients[categoryName];
                    // Filtra ingredientes visíveis
                    const visibleIngredients = ingredients.filter(ing => ingredientVisibility[ing.id] !== false);

                    if (visibleIngredients.length > 0) {
                        const firstIngredient = visibleIngredients[0];
                        const isSingleChoice = firstIngredient.isSingleChoice; // É escolha única (radio) ou múltipla (checkbox/quantidade)?
                        const limit = firstIngredient.limit || Infinity; // Limite de itens diferentes na categoria
                        const isRequired = firstIngredient.isRequired || false; // Categoria obrigatória?

                        const categoryDiv = document.createElement('div');
                        categoryDiv.className = 'ingredient-category';
                        categoryDiv.dataset.limit = limit; // Guarda limite da categoria
                        categoryDiv.dataset.categoryName = categoryName; // Guarda nome da categoria

                        // Define o título da categoria com informações de limite/obrigatoriedade
                        let categoryTitle = capitalizeFirstLetter(categoryName);
                        if (isRequired) {
                            categoryTitle += ' (Obrigatório)';
                        } else if (limit !== Infinity && limit > 1) {
                            categoryTitle += ` (Escolha até ${limit} variedades)`;
                        } else if (isSingleChoice) {
                             categoryTitle += ` (Escolha 1)`;
                        }

                        categoryDiv.innerHTML = `<h4>${categoryTitle}</h4>`; // Adiciona título

                        // Itera sobre os ingredientes visíveis da categoria
                        visibleIngredients.forEach(ingredient => {
                            const isUnavailable = ingredientStatus[ingredient.id] === false; // Verifica disponibilidade
                            const ingredientLimit = ingredient.ingredientLimit || 1; // Limite de quantidade para este ingrediente específico
                            const priceDisplay = ingredient.price > 0 ? `+ R$ ${ingredient.price.toFixed(2).replace('.', ',')}` : ''; // Formata preço
                            const label = document.createElement('label');
                            label.className = `ingredient-option ${isUnavailable ? 'opacity-50 cursor-not-allowed' : ''}`; // Adiciona classe se indisponível

                            // Cria HTML do input (radio ou quantidade)
                            if (isSingleChoice) { // Radio button
                                const isChecked = existingItem && existingItem.ingredients.some(ing => ing.name === ingredient.name); // Verifica se estava selecionado (edição)
                                label.innerHTML = `
                                    <input type="radio" id="${categoryName}-${ingredient.id}" name="${categoryName}" value="${ingredient.id}" data-price="${ingredient.price}" class="form-radio" ${isUnavailable ? 'disabled' : ''} ${isChecked ? 'checked' : ''}>
                                    <span class="flex-grow">${ingredient.name} ${isUnavailable ? '(Esgotado)' : ''}</span>
                                    <span class="price ml-2">${priceDisplay}</span>
                                `;
                                if (isChecked) label.classList.add('selected'); // Marca como selecionado visualmente
                                // Listener para atualizar preço e estilo ao mudar seleção
                                label.querySelector('input').addEventListener('change', (e) => {
                                    document.querySelectorAll(`input[name="${categoryName}"]`).forEach(el => {
                                        el.closest('.ingredient-option').classList.remove('selected');
                                    });
                                    if (label.querySelector('input:checked')) {
                                        label.classList.add('selected');
                                    }
                                    updateBurgerPrice();
                                });
                            } else { // Botões de quantidade
                                let quantity = 0;
                                // Verifica quantidade se estiver editando
                                if (existingItem && existingItem.ingredients) {
                                    const existingIng = existingItem.ingredients.find(ing => ing.name === ingredient.name);
                                    if (existingIng) {
                                        quantity = existingIng.quantity || 0;
                                    }
                                }
                                label.innerHTML = `
                                    <div class="flex-grow">
                                        <span>${ingredient.name} ${isUnavailable ? '(Esgotado)' : ''}</span>
                                        <span class="price ml-2">${priceDisplay}</span>
                                    </div>
                                    <div class="flex items-center space-x-3" data-ingredient-id="${ingredient.id}" data-price="${ingredient.price}" data-limit="${ingredientLimit}">
                                        <button type="button" class="quantity-btn minus-btn bg-gray-200 w-7 h-7 rounded-full flex items-center justify-center text-lg font-bold" ${isUnavailable ? 'disabled' : ''}>-</button>
                                        <span class="quantity-display font-bold text-lg w-4 text-center">${quantity}</span>
                                        <button type="button" class="quantity-btn plus-btn bg-gray-200 w-7 h-7 rounded-full flex items-center justify-center text-lg font-bold" ${isUnavailable ? 'disabled' : ''}>+</button>
                                    </div>
                                `;
                                if (quantity > 0) label.classList.add('selected'); // Marca visualmente se quantidade > 0
                            }
                            categoryDiv.appendChild(label); // Adiciona opção à categoria
                        });
                        burgerIngredientsContainer.appendChild(categoryDiv); // Adiciona categoria ao modal
                    }
                }

                updateBurgerPrice(); // Calcula preço inicial

                // Define texto do botão (Adicionar ou Atualizar)
                if (editIndex !== null) {
                    addCustomBurgerBtn.textContent = 'Atualizar Hambúrguer';
                } else {
                    addCustomBurgerBtn.textContent = 'Adicionar ao Pedido';
                }

                // Define ação do botão principal
                addCustomBurgerBtn.onclick = () => addCustomBurgerToOrder(baseBurgerItem, editIndex);

                burgerBuilderModal.style.display = 'flex'; // Exibe o modal
                updatePromotionButtonVisibility(); // Esconde botão de promoções
            }

            // Atualiza o preço total no modal de montagem de hambúrguer
            function updateBurgerPrice() {
                let total = currentBurgerBasePrice; // Começa com o preço base
                // Soma preço dos radios selecionados
                document.querySelectorAll('#burger-ingredients-container input[type="radio"]:checked').forEach(input => {
                    total += parseFloat(input.dataset.price);
                });
                // Soma preço dos itens com quantidade > 0
                document.querySelectorAll('#burger-ingredients-container .quantity-display').forEach(display => {
                    const quantity = parseInt(display.textContent);
                    if (quantity > 0) {
                        const container = display.closest('[data-ingredient-id]');
                        const price = parseFloat(container.dataset.price);
                        total += quantity * price;
                    }
                });
                // Atualiza o elemento HTML com o preço formatado
                burgerTotalPriceEl.textContent = 'R$ ' + total.toFixed(2).replace('.', ',');
            }

            // Adiciona o hambúrguer montado ao pedido
            function addCustomBurgerToOrder(baseBurgerItem, editIndex = null) {
                const selectedIngredients = [];
                let finalTotal = currentBurgerBasePrice;

                // Verifica se todas as categorias obrigatórias foram preenchidas
                let allRequiredCategoriesFilled = true;
                for (const categoryName in allBurgerIngredients) {
                    const isRequired = allBurgerIngredients[categoryName][0]?.isRequired || false;
                    if (isRequired) {
                        const categoryDiv = burgerBuilderModal.querySelector(`.ingredient-category[data-category-name="${categoryName}"]`);
                        const checkedInput = categoryDiv.querySelector('input:checked');
                        let quantityCount = 0;
                        categoryDiv.querySelectorAll('.quantity-display').forEach(d => quantityCount += parseInt(d.textContent));
                        if (!checkedInput && quantityCount === 0) {
                            showMessageModal(`Por favor, escolha uma opção na categoria "${capitalizeFirstLetter(categoryName)}".`);
                            allRequiredCategoriesFilled = false;
                            break; // Sai do loop se uma obrigatória não foi preenchida
                        }
                    }
                }
                if (!allRequiredCategoriesFilled) return; // Interrompe se faltar obrigatória

                // Coleta os ingredientes selecionados (radios e quantidades)
                burgerBuilderModal.querySelectorAll('.ingredient-category').forEach(categoryDiv => {
                    const categoryName = categoryDiv.dataset.categoryName;
                    if (allBurgerIngredients[categoryName]) {
                        // Coleta radios selecionados
                        categoryDiv.querySelectorAll('input[type="radio"]:checked').forEach(input => {
                            const ingredient = allBurgerIngredients[categoryName].find(ing => ing.id === input.value);
                            if (ingredient) {
                                selectedIngredients.push({
                                    name: ingredient.name,
                                    price: ingredient.price,
                                    quantity: 1 // Radio sempre tem quantidade 1
                                });
                                finalTotal += ingredient.price; // Soma preço do radio
                            }
                        });
                        // Coleta itens com quantidade > 0
                        categoryDiv.querySelectorAll('.quantity-display').forEach(display => {
                            const quantity = parseInt(display.textContent);
                            if (quantity > 0) {
                                const container = display.closest('[data-ingredient-id]');
                                const ingredientId = container.dataset.ingredientId;
                                const ingredient = allBurgerIngredients[categoryName].find(ing => ing.id === ingredientId);
                                if (ingredient) {
                                     selectedIngredients.push({
                                        name: ingredient.name,
                                        price: ingredient.price,
                                        quantity: quantity // Guarda a quantidade selecionada
                                    });
                                    finalTotal += quantity * ingredient.price; // Soma preço * quantidade
                                }
                            }
                        });
                    }
                });

                // Cria o objeto do novo hambúrguer para o pedido
                const newBurger = {
                    id: editIndex !== null ? order[editIndex].id : Date.now() + Math.random(), // ID único ou ID existente (edição)
                    type: 'custom_burger',
                    name: 'Hambúrguer Personalizado',
                    price: finalTotal,
                    basePrice: baseBurgerItem.basePrice, // Preço base original
                    description: `Monte seu hambúrguer.`,
                    ingredients: selectedIngredients, // Lista de ingredientes selecionados
                    category: baseBurgerItem.category,
                    originalItem: baseBurgerItem // Referência ao item base do cardápio
                };

                // Atualiza ou adiciona o hambúrguer no pedido
                if (editIndex !== null) {
                    order[editIndex] = newBurger; // Substitui o item existente
                    updateOrderDisplay();
                    showTemporaryFeedback('✔️ Hambúrguer atualizado!', 'bg-blue-500');
                } else {
                    addToOrder(newBurger, addCustomBurgerBtn); // Adiciona novo item
                }

                burgerBuilderModal.style.display = 'none'; // Fecha o modal
                updatePromotionButtonVisibility(); // Atualiza visibilidade do botão de promoções
            }

            // Capitaliza a primeira letra de uma string
            function capitalizeFirstLetter(string) {
                if (!string) return '';
                return string.charAt(0).toUpperCase() + string.slice(1).toLowerCase();
            }

            // Cria os botões de filtro de categoria
            function createCategoryButtons(categories) {
                const categoryButtonsContainer = document.getElementById('category-buttons-container');
                categoryButtonsContainer.innerHTML = ''; // Limpa botões existentes

                // Itera sobre as categorias e cria um botão para cada
                categories.forEach((category, index) => {
                    const button = document.createElement('button');
                    const sectionId = `${category.toLowerCase().replace(/\s+/g, '-')}-section`; // ID da seção correspondente
                    button.className = 'category-btn px-4 py-2 rounded-full bg-gray-200 text-gray-800 whitespace-nowrap lg:flex-grow-0 lg:flex-shrink-0'; // Estilos

                    // Formata o nome do botão (adiciona "Pizzas" se for categoria de pizza)
                    const firstItemOfCategory = allMenuData.find(item => item.category === category);
                    const isPizzaCategory = firstItemOfCategory && firstItemOfCategory.isPizza;
                    button.textContent = isPizzaCategory ? `Pizzas ${capitalizeFirstLetter(category)}` : capitalizeFirstLetter(category);

                    button.dataset.category = category; // Armazena a categoria no botão
                    button.dataset.targetId = sectionId; // Armazena o ID da seção alvo

                    // Adiciona listener de clique para rolar para a seção e ativar o botão
                    button.addEventListener('click', function(event) {
                        const targetId = this.dataset.targetId;
                        const targetElement = document.getElementById(targetId);

                        if (targetElement) {
                            isScrollingFromClick = true; // Flag para evitar que o observer ative durante o scroll
                            targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' }); // Rola suavemente
                            setActiveCategoryButton(category); // Marca o botão como ativo
                            // Reseta a flag após um tempo
                            setTimeout(() => {
                                isScrollingFromClick = false;
                            }, 1000); // 1 segundo de timeout
                        }
                    });
                    categoryButtonsContainer.appendChild(button); // Adiciona botão ao container
                });
            }


            // Adiciona listeners aos botões "Adicionar" dos itens do cardápio
            function attachAddButtonListeners() {
                document.querySelectorAll('.add-item-btn').forEach(button => {
                    // Remove listener antigo para evitar duplicação (caso a função seja chamada múltiplas vezes)
                    button.removeEventListener('click', handleAddButtonClick);
                    // Adiciona o novo listener
                    button.addEventListener('click', handleAddButtonClick);
                });
            }

            // Habilita ou desabilita os botões "Adicionar" e de categoria durante a seleção de meia pizza
            function toggleAddItemButtons(enableAll = true) {
                document.querySelectorAll('.add-item-btn').forEach(button => {
                    const itemId = button.dataset.itemId;
                    const item = allMenuData.find(i => i.id === itemId);

                    if (enableAll || !isSelectingHalfPizza) { // Se não estiver selecionando meia pizza, habilita todos
                        button.removeAttribute('disabled');
                        button.classList.remove('opacity-50', 'cursor-not-allowed');
                    } else { // Se estiver selecionando meia pizza, aplica regras
                        let disable = false;
                        // Regra para promoção: ambas as metades devem ser (ou não ser) promocionais
                        if (isFirstHalfPromotional) { // Se a primeira metade é promocional
                            if (!item || item.category.toLowerCase() !== 'promocionais') {
                                disable = true; // Desabilita se a segunda não for promocional
                            }
                        } else { // Se a primeira metade não é promocional
                            if (item && item.category.toLowerCase() === 'promocionais') {
                                disable = true; // Desabilita se a segunda for promocional
                            }
                        }
                        // Regra de permissão de meia-meia: verifica status do Firestore
                        if (item && pizzaHalfStatus[item.id] === false) {
                            disable = true; // Desabilita se o item não permite meia-meia
                        }

                        // Aplica o estado desabilitado ou habilitado
                        if (disable) {
                            button.setAttribute('disabled', 'true');
                            button.classList.add('opacity-50', 'cursor-not-allowed');
                        } else {
                            button.removeAttribute('disabled');
                            button.classList.remove('opacity-50', 'cursor-not-allowed');
                        }
                    }
                });
            }

            function toggleCategoryButtons(enableAll = true) {
                document.querySelectorAll('.category-btn').forEach(button => {
                    const category = button.dataset.category.toLowerCase();
                    if (enableAll || !isSelectingHalfPizza) { // Se não está selecionando meia, habilita tudo
                        button.removeAttribute('disabled');
                        button.classList.remove('opacity-50', 'cursor-not-allowed');
                    } else { // Se está selecionando meia, aplica regras
                        if (isFirstHalfPromotional) { // Se primeira metade é promo
                            if (category === 'promocionais') { // Só habilita a categoria promo
                                button.removeAttribute('disabled');
                                button.classList.remove('opacity-50', 'cursor-not-allowed');
                            } else { // Desabilita outras categorias
                                button.setAttribute('disabled', 'true');
                                button.classList.add('opacity-50', 'cursor-not-allowed');
                            }
                        } else { // Se primeira metade não é promo
                            if (category === 'promocionais') { // Desabilita a categoria promo
                                button.setAttribute('disabled', 'true');
                                button.classList.add('opacity-50', 'cursor-not-allowed');
                            } else { // Habilita outras categorias
                                button.removeAttribute('disabled');
                                button.classList.remove('opacity-50', 'cursor-not-allowed');
                            }
                        }
                    }
                });
            }

            // Renderiza as opções de tamanho e botões (inteira/meia) no modal de pizza
            function renderPizzaOptions(item) {
                modalPizzaName.textContent = item.name;
                modalPizzaDescription.textContent = item.description;
                pizzaSizeOptions.innerHTML = ''; // Limpa opções anteriores

                // Filtra tamanhos com preço definido (> 0)
                const availableSizes = sizes.filter(size => item[size.priceKey] > 0);

                // Ajusta grid do modal (2 colunas por padrão, ou mais se muitos tamanhos)
                if (availableSizes.length <= 2) {
                    pizzaSizeOptions.classList.remove('sm:grid-cols-2', 'lg:grid-cols-4');
                    pizzaSizeOptions.classList.add('sm:grid-cols-2');
                } else {
                    pizzaSizeOptions.classList.remove('sm:grid-cols-2');
                    pizzaSizeOptions.classList.add('sm:grid-cols-2', 'lg:grid-cols-4'); // Layout responsivo
                }

                // Cria o HTML para cada tamanho disponível
                availableSizes.forEach(size => {
                    const sizePrice = item[size.priceKey];
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'pizza-size-option';

                    const allowsHalf = pizzaHalfStatus[item.id] !== false; // Verifica permissão de meia-meia

                    // Botão para adicionar pizza inteira
                    const fullPizzaButtonHtml = `
                        <button class="add-full-size-pizza-btn px-4 py-2 bg-red-600 text-white rounded-md text-sm hover:bg-red-700 transition w-full"
                                data-slices="${size.slices}" data-price-key="${size.priceKey}">
                            Adicionar Inteira
                        </button>
                    `;

                    // Botão para iniciar meia pizza (habilitado/desabilitado conforme permissão)
                    let halfPizzaButtonHtml = '';
                    if (allowsHalf) {
                        halfPizzaButtonHtml = `
                            <button class="add-half-size-pizza-btn px-4 py-2 bg-blue-600 text-white rounded-md text-sm hover:bg-blue-700 transition w-full"
                                    data-slices="${size.slices}" data-price-key="${size.priceKey}">
                                Adicionar Meia Pizza
                            </button>
                        `;
                    } else {
                         halfPizzaButtonHtml = `
                            <button class="add-half-size-pizza-btn px-4 py-2 bg-gray-400 text-white rounded-md text-sm cursor-not-allowed w-full"
                                    disabled>
                                Adicionar Meia Pizza
                            </button>
                        `;
                    }

                    // Mensagem indicando se permite meia-meia ou não
                    let halfPizzaMessageHtml = '';
                    if (!allowsHalf) {
                        halfPizzaMessageHtml = `<div class="text-xs text-center text-gray-500 mt-1 h-6">Este sabor não permite meia a meia.</div>`;
                    } else {
                        halfPizzaMessageHtml = `<div class="h-6 mt-1"></div>`; // Espaço vazio para manter layout
                    }

                    // Monta o HTML da opção de tamanho
                    optionDiv.innerHTML = `
                        <span class="font-bold text-base text-gray-800">${size.label}</span>
                        <span class="font-bold text-red-600 text-lg mb-2">R$ ${sizePrice.toFixed(2).replace('.', ',')}</span>
                        <div class="flex flex-col gap-2 mt-2 w-full">
                            ${fullPizzaButtonHtml}
                            ${halfPizzaButtonHtml}
                        </div>
                        ${halfPizzaMessageHtml}
                    `;
                    pizzaSizeOptions.appendChild(optionDiv); // Adiciona ao modal

                    // Adiciona listener para o botão "Inteira"
                    optionDiv.querySelector('.add-full-size-pizza-btn').addEventListener('click', function() {
                        const selectedSlices = parseInt(this.dataset.slices);
                        const selectedPriceKey = this.dataset.priceKey;
                        const newName = `${selectedSlices} FATIAS: ${currentPizzaData.name}`; // Nome formatado
                        // Adiciona ao pedido
                        addToOrder({
                            id: Date.now() + Math.random(), // ID único
                            type: 'full', name: newName, price: currentPizzaData[selectedPriceKey],
                            description: currentPizzaData.description,
                            category: formatPizzaCategory(currentPizzaData.category), // Formata categoria
                            selected_slices: selectedSlices,
                            extras: [], // Inicia sem extras
                            acceptsExtras: currentPizzaData.acceptsExtras // Herda permissão de extras
                        }, this, currentPizzaData.imageUrl); // Passa imagem para animação
                        pizzaOptionModal.style.display = 'none'; // Fecha modal
                        updatePromotionButtonVisibility(); // Atualiza botão promoções
                    });

                    // Adiciona listener para o botão "Meia" (se habilitado)
                    const halfPizzaBtn = optionDiv.querySelector('.add-half-size-pizza-btn');
                    if (halfPizzaBtn && !halfPizzaBtn.disabled) {
                        halfPizzaBtn.addEventListener('click', function() {
                            const selectedSlices = parseInt(this.dataset.slices);
                            const selectedPriceKey = this.dataset.priceKey;
                            // Guarda dados da primeira metade
                            firstHalfPizza = {
                                name: currentPizzaData.name,
                                price: currentPizzaData[selectedPriceKey] / 2, // Metade do preço
                                description: currentPizzaData.description,
                                original_full_price: currentPizzaData[selectedPriceKey], // Preço cheio original
                                selected_slices: selectedSlices,
                                priceKeyForSlices: selectedPriceKey, // Chave do preço para este tamanho
                                category: currentPizzaData.category // Categoria original
                            };
                            isSelectingSecondHalf = true; // Flag para indicar que a próxima seleção é a segunda metade
                            isSelectingHalfPizza = true; // Flag geral de seleção de meia pizza
                            isFirstHalfPromotional = (currentPizzaData.category.toLowerCase() === 'promocionais'); // Verifica se é promocional
                            pizzaOptionModal.style.display = 'none'; // Fecha modal
                            updatePromotionButtonVisibility();

                            toggleAddItemButtons(false); // Desabilita botões conforme regras de meia pizza
                            toggleCategoryButtons(false); // Desabilita categorias conforme regras

                            // Adiciona um item temporário ao pedido para indicar a seleção em andamento
                            addToOrderOnly({
                                type: 'half_pending', name: `½ ${currentPizzaData.name}`,
                                price: currentPizzaData[selectedPriceKey] / 2,
                                description: `Primeira metade: ${currentPizzaData.description}`,
                                id: 'pending-half-pizza', // ID fixo para identificar
                                category: formatPizzaCategory(currentPizzaData.category),
                                selected_slices: selectedSlices
                            }, this, currentPizzaData.imageUrl); // Passa imagem para animação

                            // Exibe mensagem instruindo a escolher a segunda metade
                            setTimeout(() => {
                                showMessageModal('Agora, escolha a segunda metade da sua pizza.');
                            }, 100);
                        });
                    }
                });
            }


            // Abre o modal de opções de tamanho para a pizza clicada
            function openPizzaOptionsModal(item) {
                currentPizzaData = { ...item }; // Armazena os dados da pizza atual
                renderPizzaOptions(item); // Renderiza as opções de tamanho
                pizzaOptionModal.style.display = 'flex'; // Exibe o modal
                promotionButton.style.display = 'none'; // Esconde o botão de promoções
            }

            // Lida com o clique em um botão "Adicionar" ou "Montar"
            function handleAddButtonClick(e) {
                const clickedButton = e.target; // O botão que foi clicado
                const itemId = clickedButton.dataset.itemId; // ID do item
                const item = allMenuData.find(i => i.id === itemId); // Encontra o item no cardápio

                if (!item) return; // Se não encontrar o item, sai

                const itemImageUrl = item.isPizza ? item.imageUrl : null; // Pega URL da imagem (se for pizza)

                if (item.isCustomizable) { // Se for hambúrguer montável
                    openBurgerBuilderModal(item); // Abre o modal de montagem
                    return;
                }

                if (isSelectingSecondHalf) { // Se estiver selecionando a segunda metade da pizza
                    if (!item.isPizza) { // Se o item clicado não for pizza
                        showMessageModal('Por favor, escolha uma pizza para a segunda metade.');
                        return;
                    }
                     // Verifica se a segunda metade permite ser meia-meia
                    if (pizzaHalfStatus[item.id] === false) {
                        showMessageModal(`O sabor "${item.name}" não está disponível para meia a meia.`);
                        return;
                    }
                    // Aplica regra de promoção (ambas devem ser ou não ser promocionais)
                    if (isFirstHalfPromotional && item.category.toLowerCase() !== 'promocionais') {
                        showMessageModal('Para pizzas promocionais, a segunda metade deve ser também de uma pizza promocional.', () => {
                            // Rola para a seção de promoções
                            document.getElementById('promocionais-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
                            setActiveCategoryButton('promocionais'); // Ativa o botão da categoria
                        });
                        return;
                    } else if (!isFirstHalfPromotional && item.category.toLowerCase() === 'promocionais') {
                        showMessageModal('Você começou a montar uma pizza meio a meio com um sabor não promocional. A segunda metade não pode ser de uma pizza promocional.');
                        return;
                    }

                    // Remove o item temporário 'pending-half-pizza'
                    const pendingHalfIndex = order.findIndex(orderItem => orderItem.id === 'pending-half-pizza');
                    if (pendingHalfIndex > -1) {
                        order.splice(pendingHalfIndex, 1);
                    }

                    // Monta o nome e calcula o preço da pizza meio a meio
                    const cleanFirstName = firstHalfPizza.name;
                    const combinedName = `${firstHalfPizza.selected_slices} FATIAS: Meia ${cleanFirstName} & Meia ${item.name}`;
                    const priceFirstHalfFullSize = firstHalfPizza.original_full_price;
                    const priceSecondHalfFullSize = item[firstHalfPizza.priceKeyForSlices]; // Preço da 2ª metade no tamanho escolhido
                    const combinedPrice = ((priceFirstHalfFullSize || 0) / 2) + ((priceSecondHalfFullSize || 0) / 2); // Soma das metades
                    const combinedDescription = `${firstHalfPizza.description.replace('Primeira metade: ', '')} e ${item.description}`;

                    // Adiciona a pizza meio a meio ao pedido
                    addToOrder({
                        id: Date.now() + Math.random(), // ID único
                        type: 'split', name: combinedName, price: combinedPrice,
                        description: combinedDescription, category: 'PIZZA(s) MEIA A MEIA', // Categoria fixa
                        selected_slices: firstHalfPizza.selected_slices,
                        extras: [], // Inicia sem extras
                        acceptsExtras: item.acceptsExtras // Herda permissão de extras (poderia ser OR das duas metades)
                    }, clickedButton, itemImageUrl); // Passa imagem para animação

                    // Reseta as flags de seleção de meia pizza
                    firstHalfPizza = null;
                    isSelectingSecondHalf = false;
                    isSelectingHalfPizza = false;
                    isFirstHalfPromotional = false;
                    toggleAddItemButtons(true); // Reabilita botões
                    toggleCategoryButtons(true); // Reabilita categorias
                    showTemporaryFeedback('Pizza meio a meia adicionada ao pedido!', 'bg-green-500'); // Feedback visual

                } else if (item.isPizza) { // Se for pizza (e não está selecionando segunda metade)
                    openPizzaOptionsModal(item); // Abre modal de tamanhos
                } else { // Se for qualquer outro item (não pizza, não montável)
                    // Adiciona o item ao pedido
                    addToOrder({
                        id: Date.now() + Math.random(), // ID único
                        type: 'full',
                        name: item.name,
                        price: item.basePrice, // Preço base
                        description: item.description,
                        category: item.category,
                        extras: [], // Inicia sem extras
                        acceptsExtras: item.acceptsExtras // Herda permissão de extras
                    }, clickedButton, itemImageUrl); // Passa imagem para animação
                }
            }

            // Adiciona um item ao pedido (com feedback visual e modal de extras se aplicável)
            function addToOrder(item, clickedButton = null, itemImageUrl = null) {
                const uniqueId = item.id || (Date.now() + Math.random()); // Garante um ID único no carrinho
                const itemWithId = { ...item, id: uniqueId }; // Cria cópia com ID único

                order.push(itemWithId); // Adiciona ao array do pedido
                updateOrderDisplay(); // Atualiza a sidebar
                updateCartCount(); // Atualiza o contador do carrinho

                if (clickedButton) {
                    animateItemToCart(clickedButton, itemImageUrl); // Inicia animação visual
                }

                showTemporaryFeedback('✔️ Adicionado ao pedido!', 'bg-green-500'); // Mostra toast de sucesso

                // Verifica se o item aceita extras e é do tipo que pode ter extras (pizza inteira ou meia)
                if (item.acceptsExtras && (item.type === 'full' || item.type === 'split')) {
                    // Encontra o item original no cardápio para pegar a configuração correta de 'acceptsExtras'
                     const originalItem = allMenuData.find(menuItem => menuItem.name === (item.name.split(': ')[1] || item.name.split(' Meia ')[1]?.split(' & ')[0])) || allMenuData.find(menuItem => item.name.includes(menuItem.name));
                     // Exibe o modal perguntando se deseja adicionar extras
                    showAskForExtrasModal(uniqueId, originalItem || item);
                }
            }


            // Adiciona um item ao pedido (usado internamente, sem feedback extra)
            function addToOrderOnly(item, clickedButton = null, itemImageUrl = null) {
                const uniqueId = item.id || (Date.now() + Math.random()); // Garante ID único
                const itemWithId = { ...item, id: uniqueId }; // Cria cópia com ID
                order.push(itemWithId); // Adiciona ao pedido
                updateOrderDisplay(); // Atualiza sidebar
                updateCartCount(); // Atualiza contador
                if (clickedButton) {
                    animateItemToCart(clickedButton, itemImageUrl); // Inicia animação se houver botão de origem
                }
            }

            // Anima um ícone/imagem do item voando para o botão do carrinho
            function animateItemToCart(originElement, imageUrl = null) {
                const cartButtonRect = cartButton.getBoundingClientRect(); // Posição do carrinho
                const originRect = originElement.getBoundingClientRect(); // Posição do botão clicado

                const flyingEl = document.createElement('div'); // Cria elemento para animação
                flyingEl.classList.add('fly-to-cart-animation'); // Adiciona classe CSS da animação

                // Define conteúdo (imagem ou ícone de '+')
                if (imageUrl && imageUrl !== 'https://www.bakelitsul.com.br/Assets/img/sem-produto-detalhe.png') {
                    flyingEl.innerHTML = `<img src="${imageUrl}" alt="item" class="w-full h-full object-cover rounded-full">`;
                } else {
                    flyingEl.innerHTML = '<i class="fas fa-plus"></i>'; // Ícone padrão
                }

                // Define variáveis CSS para posições inicial e final da animação
                flyingEl.style.setProperty('--start-x', `${originRect.left + originRect.width / 2 - 15}px`);
                flyingEl.style.setProperty('--start-y', `${originRect.top + originRect.height / 2 - 15}px`);
                flyingEl.style.setProperty('--end-x', `${cartButtonRect.left + cartButtonRect.width / 2 - 15}px`);
                flyingEl.style.setProperty('--end-y', `${cartButtonRect.top + cartButtonRect.height / 2 - 15}px`);

                document.body.appendChild(flyingEl); // Adiciona elemento à página

                // Remove o elemento após a animação terminar
                flyingEl.addEventListener('animationend', () => {
                    flyingEl.remove();
                });
            }


            // Exibe uma mensagem de feedback temporária (toast)
            function showTemporaryFeedback(message, bgColorClass) {
                const feedback = document.createElement('div');
                feedback.textContent = message;
                // Estilos do toast (posição fixa, cores, etc.)
                feedback.className = `fixed right-4 ${bgColorClass} text-white px-4 py-2 rounded-lg shadow-lg slide-in`;
                feedback.style.zIndex = '100'; // Garante que fique acima de outros elementos

                // Posiciona o toast acima do botão do carrinho
                const cartButtonRect = cartButton.getBoundingClientRect();
                feedback.style.bottom = `${window.innerHeight - cartButtonRect.top + 10}px`; // Calcula posição
                document.body.appendChild(feedback); // Adiciona à página

                // Remove o toast após um tempo
                setTimeout(() => {
                    feedback.classList.add('opacity-0', 'transition-opacity', 'duration-300'); // Efeito de fade out
                    setTimeout(() => feedback.remove(), 300); // Remove do DOM após fade out
                }, 2000); // Duração de 2 segundos
            }

            // Atualiza a exibição dos itens na sidebar do pedido e calcula totais
            function updateOrderDisplay() {
                let subtotal = 0;
                // Calcula subtotal iterando pelos itens do pedido
                order.forEach((item) => {
                    subtotal += item.price;
                });

                // Calcula desconto (se houver promoção ativa)
                let finalDiscountAmount = 0;
                if (discountPromotion) {
                    finalDiscountAmount = subtotal * (discountPromotion.promoPrice / 100);
                }

                // Limpa ou mostra mensagem de carrinho vazio
                if (order.length === 0) {
                    emptyOrderMessage.classList.remove('hidden');
                    orderItemsContainer.innerHTML = '';
                    orderItemsContainer.appendChild(emptyOrderMessage);
                } else {
                    emptyOrderMessage.classList.add('hidden'); // Esconde mensagem de vazio

                    // Agrupa itens por categoria para exibição organizada
                    const itemsByCategory = {};
                    order.forEach((item, index) => {
                        const category = item.category || 'Outros';
                        if (!itemsByCategory[category]) {
                            itemsByCategory[category] = [];
                        }
                        itemsByCategory[category].push({ ...item, originalIndex: index }); // Guarda índice original
                    });

                    let itemsHTML = ''; // String para construir o HTML dos itens
                    const categoryOrder = Object.keys(itemsByCategory); // Ordem das categorias

                    // Itera sobre as categorias e itens
                    categoryOrder.forEach(category => {
                        itemsHTML += `<h4 class="font-bold text-gray-700 mt-4 mb-2 border-b pb-1">${category.toUpperCase()}</h4>`; // Título da categoria

                        itemsByCategory[category].forEach(itemObj => {
                            const item = itemObj;
                            const originalIndex = item.originalIndex; // Índice no array 'order'
                            let itemName = item.name;
                            let priceHtml = `<span class="font-bold mr-4">R$ ${item.price.toFixed(2).replace('.', ',')}</span>`;

                            // Adiciona ícone para promoções e hambúrgueres montáveis
                            if (item.type === 'promotion') {
                                itemName = `<i class="fas fa-tags text-red-600 mr-2"></i> ${item.name}`;
                            } else if (item.type === 'custom_burger') {
                                itemName = `<i class="fas fa-hamburger text-red-600 mr-2"></i> ${item.name}`;
                            } else if (item.type === 'discount') {
                                return; // Não renderiza item de desconto aqui (mostrado no resumo)
                            }

                            // Adiciona detalhes (ingredientes, extras) se houver
                            let detailsHtml = '';
                            if (item.type === 'custom_burger' && item.ingredients && item.ingredients.length > 0) {
                                detailsHtml += '<ul class="text-xs text-gray-500 mt-1 pl-4 list-disc list-inside">';
                                item.ingredients.forEach(ingredient => {
                                    const quantityText = ingredient.quantity > 1 ? ` (x${ingredient.quantity})` : '';
                                    const priceText = ingredient.price > 0 ? ` +R$ ${(ingredient.price * ingredient.quantity).toFixed(2).replace('.',',')}` : '';
                                    detailsHtml += `<li>${ingredient.name}${quantityText}${priceText}</li>`;
                                });
                                detailsHtml += '</ul>';
                            }
                            if (item.extras && item.extras.length > 0) {
                                detailsHtml += '<ul class="text-xs text-gray-500 mt-1 pl-4 list-disc list-inside">';
                                item.extras.forEach(extra => {
                                    let extraText = `${extra.name} (${extra.placement})`;
                                    if(extra.quantity > 1) { extraText += ` (x${extra.quantity})`; }
                                    extraText += ` +R$ ${(extra.price * extra.quantity).toFixed(2).replace('.',',')}`;
                                    detailsHtml += `<li>${extraText}</li>`;
                                });
                                detailsHtml += '</ul>';
                            }

                            // Adiciona botão de "Editar/Incluir Adicionais" ou "Editar Hambúrguer"
                            let actionButtonHtml = '';
                            if (item.acceptsExtras && (item.type === 'full' || item.type === 'split')) {
                                const hasExtras = item.extras && item.extras.length > 0;
                                const buttonText = hasExtras ? 'Editar Adicionais' : 'Incluir Adicionais';
                                const iconClass = hasExtras ? 'fas fa-pencil-alt' : 'fas fa-plus-circle';
                                actionButtonHtml = `<button class="edit-extras-btn mt-2 px-3 py-1 bg-blue-100 text-blue-800 rounded-md hover:bg-blue-200 text-xs font-semibold inline-flex items-center gap-2 transition-colors" data-order-index="${originalIndex}">
                                                        <i class="${iconClass} fa-fw"></i>
                                                        <span>${buttonText}</span>
                                                    </button>`;
                            } else if (item.type === 'custom_burger') {
                                actionButtonHtml = `<button class="edit-burger-btn mt-2 px-3 py-1 bg-blue-100 text-blue-800 rounded-md hover:bg-blue-200 text-xs font-semibold inline-flex items-center gap-2 transition-colors" data-order-index="${originalIndex}">
                                                        <i class="fas fa-pencil-alt fa-fw"></i>
                                                        <span>Editar Hambúrguer</span>
                                                    </button>`;
                            }

                            // Monta o HTML do item na sidebar
                            itemsHTML += `
                                <div class="py-3 border-b border-gray-100">
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1">
                                            <p class="font-medium">${itemName}</p>
                                            ${detailsHtml}
                                        </div>
                                        <div class="flex items-center">
                                            ${priceHtml}
                                            <button data-index="${originalIndex}" class="remove-item-btn text-red-500 hover:text-red-700">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </div>
                                    </div>
                                    ${actionButtonHtml}
                                </div>
                            `;
                        });
                    });
                    orderItemsContainer.innerHTML = itemsHTML; // Atualiza o container com o HTML gerado
                }

                // Atualiza subtotal no resumo
                subtotalEl.textContent = 'R$ ' + subtotal.toFixed(2).replace('.', ',');

                // Mostra/Esconde seção de desconto
                if (discountPromotion && subtotal > 0) {
                    discountSection.classList.remove('hidden');
                    discountPercentageDisplay.textContent = `${discountPromotion.promoPrice}%`;
                    discountValueDisplay.textContent = `- R$ ${finalDiscountAmount.toFixed(2).replace('.', ',')}`;
                } else {
                    discountSection.classList.add('hidden');
                }

                // Atualiza exibição da taxa de entrega
                if (isPickupOrder) { // Se for retirada
                    selectedAddress.deliveryFee = 0;
                    deliveryFeeDisplay.textContent = 'R$ 0,00';
                    deliveryFeeDisplay.classList.remove('hidden');
                    informAddressBtn.classList.add('hidden'); // Esconde botão "Informar Endereço"
                    editDeliveryAddressBtn.classList.add('hidden'); // Esconde botão "Editar Endereço"
                    addressSummarySection.classList.add('hidden'); // Esconde resumo do endereço
                } else if (selectedAddress.bairro) { // Se endereço preenchido (delivery)
                    deliveryFeeDisplay.textContent = 'R$ ' + selectedAddress.deliveryFee.toFixed(2).replace('.', ',');
                    deliveryFeeDisplay.classList.remove('hidden');
                    informAddressBtn.classList.add('hidden');
                    editDeliveryAddressBtn.classList.remove('hidden'); // Mostra botão "Editar Endereço"
                } else { // Se delivery mas endereço não preenchido
                    selectedAddress.deliveryFee = 0;
                    deliveryFeeDisplay.textContent = '';
                    deliveryFeeDisplay.classList.add('hidden');
                    informAddressBtn.classList.remove('hidden'); // Mostra botão "Informar Endereço"
                    editDeliveryAddressBtn.classList.add('hidden');
                }

                // Calcula e atualiza o total final
                const total = subtotal - finalDiscountAmount + (selectedAddress.deliveryFee || 0);
                totalEl.textContent = 'R$ ' + total.toFixed(2).replace('.', ',');

                // Adiciona exibição da forma de pagamento selecionada (se houver)
                if (selectedPaymentMethod) {
                    let paymentMethodText = '';
                    let trocoInfo = '';
                    if (typeof selectedPaymentMethod === 'object' && selectedPaymentMethod.method === 'Dinheiro') {
                        paymentMethodText = selectedPaymentMethod.method;
                        trocoInfo = `<p class="text-sm text-gray-500 mt-1">Troco para: R$ ${selectedPaymentMethod.trocoPara.toFixed(2).replace('.', ',')}</p><p class="text-sm text-gray-500">Troco: <span class="font-bold text-green-600">R$ ${selectedPaymentMethod.trocoTotal.toFixed(2).replace('.', ',')}</span></p>`;
                    } else {
                        paymentMethodText = selectedPaymentMethod;
                    }
                    orderItemsContainer.insertAdjacentHTML('beforeend', `<div class="flex justify-between items-start py-3"><div class="flex-1"><p class="font-medium text-gray-600">Forma de Pagamento:</p>${trocoInfo}</div><div class="flex items-center"><span class="font-bold text-red-600">${paymentMethodText}</span></div></div>`);
                }

                // Atualiza botões no modal de sugestão de bebidas (se aberto)
                updateDrinkSuggestionButtons();
                // Atualiza exibição do resumo do endereço
                updateAddressDisplay();
            }

            // Remove um item do pedido pelo índice
            function removeItem(index) {
                const removedItem = order[index]; // Guarda item removido para checagem
                order.splice(index, 1); // Remove do array
                updateOrderDisplay(); // Atualiza a sidebar
                updateCartCount(); // Atualiza contador do carrinho

                // Se o item removido era a primeira metade de uma pizza, cancela a seleção
                if (removedItem && removedItem.id === 'pending-half-pizza') {
                    resetHalfPizzaSelection(); // Chama a função para resetar flags e reabilitar botões
                }
            }

            // Limpa completamente o estado do pedido atual
            function clearOrder() {
                order = []; // Esvazia array de itens
                selectedPaymentMethod = null; // Reseta pagamento
                document.getElementById('order-observation').value = ''; // Limpa observações
                 // Limpa dados do endereço, mas mantém nome e telefone se existirem (para conveniência)
                selectedAddress = {
                    clientName: selectedAddress.clientName,
                    telefone: selectedAddress.telefone,
                    bairro: null,
                    rua: null,
                    numero: null,
                    referencia: null,
                    deliveryFee: 0.00
                };
                pickupCheckbox.checked = false; // Desmarca checkbox de retirada
                isPickupOrder = false; // Reseta flag de retirada
                updateOrderDisplay(); // Atualiza sidebar (mostrará carrinho vazio e resetará totais)
                updateCartCount(); // Zera contador

                // Reseta flags de seleção de meia pizza
                firstHalfPizza = null;
                isSelectingSecondHalf = false;
                isSelectingHalfPizza = false;
                isFirstHalfPromotional = false;
                toggleAddItemButtons(true); // Reabilita todos os botões de adicionar
                toggleCategoryButtons(true); // Reabilita todas as categorias
                updateCheckoutButtonText(); // Reseta texto do botão finalizar
                showAddressSummary(); // Atualiza o resumo do endereço (pode esconder ou mostrar só nome/tel)
            }


            // Atualiza o número exibido no ícone do carrinho
            function updateCartCount() {
                const itemCount = order.filter(item => item.id !== 'pending-half-pizza').length; // Conta itens reais (ignora placeholder de meia pizza)
                if (itemCount > 0) {
                    cartCount.textContent = itemCount;
                    cartCount.classList.remove('hidden'); // Mostra contador
                } else {
                    cartCount.classList.add('hidden'); // Esconde contador
                }
            }

            // Envia o pedido para a API e tenta redirecionar para o WhatsApp (com verificação de duplicidade)
            function proceedToWhatsappCheckout(bypassDuplicateCheck = false) {
                // CORREÇÃO: Pegar referência do botão novamente, pois a original pode ter sido substituída
                const currentCheckoutButton = document.getElementById('checkoutButton');
                currentCheckoutButton.disabled = true;
                currentCheckoutButton.textContent = 'Enviando...';

                // Calcula totais finais
                let subtotal = 0;
                order.forEach(item => { subtotal += item.price; });
                let finalDiscountAmount = 0;
                if (discountPromotion) { finalDiscountAmount = subtotal * (discountPromotion.promoPrice / 100); }
                const totalData = { subtotal, discount: finalDiscountAmount, deliveryFee: selectedAddress.deliveryFee, finalTotal: subtotal - finalDiscountAmount + (selectedAddress.deliveryFee || 0) };
                const observation = document.getElementById('order-observation').value.trim();

                // Chama a API para criar o pedido e obter o link do WhatsApp
                fetch('/api/criar-pedido', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        order,
                        selectedAddress,
                        total: totalData,
                        paymentMethod: selectedPaymentMethod,
                        whatsappNumber: contactInfo.whatsapp,
                        observation,
                        bypassDuplicateCheck // Envia a flag
                    }),
                })
                .then(response => {
                    // **CORREÇÃO:** Tenta ler como JSON, mas se falhar, lê como texto
                    return response.json().catch(err => {
                        console.error("Falha ao parsear JSON da API:", err);
                        return response.text().then(text => { throw new Error(`Resposta inválida da API: ${text}`); });
                    });
                })
                .then(data => {
                    if (data.duplicateFound && !bypassDuplicateCheck) { // Verifica duplicata APENAS se não estiver bypassando
                        // --- DUPLICIDADE ENCONTRADA ---
                        const timeDifferenceString = formatTimeDifference(data.originalOrderTimestamp);
                        const message = `Esse pedido foi registrado ${timeDifferenceString}. Gostaria de pedir novamente esse mesmo pedido?`;

                        const modal = document.getElementById('duplicate-confirm-modal');
                        const messageEl = document.getElementById('duplicate-confirm-message');
                        const yesBtn = document.getElementById('duplicate-confirm-yes-btn');
                        const noBtn = document.getElementById('duplicate-confirm-no-btn');
                        const closeBtn = document.getElementById('close-duplicate-confirm-modal');
                        const currentCheckoutButton = document.getElementById('checkoutButton'); // Reconfirmar a referência

                        messageEl.textContent = message;

                        // Função para fechar o modal e reabilitar o botão principal OU reenviar
                        const closeModalAndProceed = (shouldResend) => {
                            modal.style.display = 'none';
                            // Remove listeners para evitar acúmulo
                            yesBtn.removeEventListener('click', handleYes);
                            noBtn.removeEventListener('click', handleNo);
                            closeBtn.removeEventListener('click', handleNo);
                            modal.removeEventListener('click', handleOutsideClick);

                            if (shouldResend) {
                                // Chama a função de checkout novamente com a flag de bypass
                                proceedToWhatsappCheckout(true);
                            } else {
                                // Apenas reabilita o botão
                                currentCheckoutButton.disabled = false;
                                updateCheckoutButtonText(); // Restaura o texto
                            }
                        };

                        const handleYes = () => closeModalAndProceed(true); // Reenvia com bypass
                        const handleNo = () => closeModalAndProceed(false); // Não reenvia

                         const handleOutsideClick = (event) => {
                             if (event.target === modal) {
                                handleNo();
                            }
                        };

                        // Adiciona listeners
                        yesBtn.addEventListener('click', handleYes, { once: true });
                        noBtn.addEventListener('click', handleNo, { once: true });
                        closeBtn.addEventListener('click', handleNo, { once: true });
                        modal.addEventListener('click', handleOutsideClick);


                        modal.style.display = 'flex'; // Exibe o modal

                    } else if (data && data.whatsappUrl) {
                        // --- SUCESSO (SEM DUPLICIDADE OU COM BYPASS) ---
                        const whatsappWindow = window.open(data.whatsappUrl, '_blank');
                        setTimeout(() => {
                            clearOrder();
                            closeOrderSidebar();
                            // CORREÇÃO: Reabilitar botão e restaurar texto APÓS limpar o pedido
                            currentCheckoutButton.disabled = false;
                            updateCheckoutButtonText();
                            if (!whatsappWindow) {
                                // Fallback para iOS/outros bloqueadores
                                try {
                                    window.location.href = data.whatsappUrl;
                                } catch(e){
                                    console.error("Falha ao redirecionar:", e);
                                    showMessageModal("Não foi possível abrir o WhatsApp automaticamente. Por favor, verifique se há bloqueadores de pop-up ativos ou tente novamente.");
                                }
                            }
                        }, 300); // Atraso

                        if (data.pdvSaved === false) {
                            console.warn('[PDV] Pedido enviado ao WhatsApp, mas falhou ao salvar no PDV.', data.pdvError ? { error: data.pdvError } : {});
                        }
                    } else {
                        // --- OUTRO ERRO DA API (RESPOSTA JSON MAS SEM URL OU DUPLICATE) ---
                         console.error("Resposta inesperada da API /api/criar-pedido:", data);
                        showMessageModal(data.message || 'Erro ao processar o pedido. Por favor, tente novamente.');
                        // CORREÇÃO: Reabilitar botão aqui também
                        currentCheckoutButton.disabled = false;
                        updateCheckoutButtonText();
                    }
                })
                .catch((error) => {
                    // --- ERRO DE REDE, FETCH OU RESPOSTA NÃO-JSON (TRATADO ACIMA) ---
                    console.error('Erro ao chamar /api/criar-pedido ou processar resposta:', error);
                     // Mostra a mensagem de erro vinda da API (se houver) ou uma genérica
                    showMessageModal(error.message || 'Erro de conexão ao enviar o pedido. Verifique sua internet.');
                     // CORREÇÃO: Reabilitar botão aqui também
                    currentCheckoutButton.disabled = false;
                    updateCheckoutButtonText();
                });
            }


            // Calcula o valor total final do pedido
            function calculateOrderTotal() {
                let currentSubtotal = 0;
                // Soma o preço de todos os itens no pedido
                order.forEach(item => {
                    currentSubtotal += (item.price || 0);
                });

                // Aplica desconto promocional, se houver
                let finalDiscountAmount = 0;
                if (discountPromotion) {
                    finalDiscountAmount = currentSubtotal * (discountPromotion.promoPrice / 100);
                }

                // Obtém a taxa de entrega (pode ser 0 se for retirada ou endereço não informado)
                const deliveryFee = selectedAddress.deliveryFee || 0;

                // Retorna o total final
                return currentSubtotal - finalDiscountAmount + deliveryFee;
            }

            // Controla o fluxo de ações ao clicar em "Finalizar Pedido"
            function handleCheckoutFlow() {
                // 1. Verifica se o carrinho está vazio
                if (order.length === 0) {
                    showMessageModal('O seu pedido está vazio. Adicione itens antes de finalizar.');
                    return;
                }
                // 2. Verifica se está no meio da seleção de meia pizza
                if (isSelectingHalfPizza) {
                    showMessageModal('Por favor, escolha a segunda metade da sua pizza antes de finalizar o pedido.');
                    return;
                }
                // 3. Verifica se os dados de endereço/cliente estão preenchidos (se não for retirada)
                if (!isPickupOrder && (!selectedAddress.clientName || !selectedAddress.bairro || (!selectedAddress.numero && !noNumberCheckbox.checked))) {
                    isCheckoutInitiated = true; // Marca que o checkout foi iniciado
                    showAddressInputModal(false); // Abre modal de endereço para delivery
                    return;
                } else if (isPickupOrder && !selectedAddress.clientName) { // Verifica nome para retirada
                    isCheckoutInitiated = true;
                    showAddressInputModal(true); // Abre modal de endereço para retirada (só nome/contato)
                    return;
                }
                // 4. Verifica se há bebidas no pedido
                const hasDrinks = order.some(item => item.category === 'bebidas');
                if (!hasDrinks) {
                    displayDrinkSuggestionModal(); // Abre modal de sugestão de bebidas
                    return; // Interrompe o fluxo aqui, usuário decide no modal
                }
                // 5. Verifica se a forma de pagamento foi selecionada
                if (!selectedPaymentMethod) {
                    isCheckoutInitiated = true; // Marca que o checkout foi iniciado
                    openPaymentMethodModal(true); // Abre modal de pagamento
                } else {
                    // Se tudo estiver OK, prossegue para enviar o pedido via WhatsApp (com verificação inicial de duplicidade)
                    proceedToWhatsappCheckout(false);
                }
            }

            // Atualiza o texto do botão "Finalizar Pedido"
            function updateCheckoutButtonText() {
                // CORREÇÃO: Pegar referência novamente caso o DOM tenha mudado
                const currentCheckoutButton = document.getElementById('checkoutButton');
                if (currentCheckoutButton) {
                    currentCheckoutButton.textContent = 'Finalizar Pedido'; // Define o texto padrão
                }
            }

            // Rola a página de volta para a seção do menu
            function backToMenu() {
                closeOrderSidebar(); // Fecha a sidebar
                document.getElementById('menu').scrollIntoView({ behavior: 'smooth' }); // Rola suavemente
            }

            // Fecha o modal de sugestão de bebidas e rola a sidebar para o final
            function backToOrderSidebarFromDrinkSuggestion() {
                drinkSuggestionModal.style.display = 'none'; // Esconde o modal
                orderSidebar.scrollTop = orderSidebar.scrollHeight; // Rola para o fim da sidebar
            }

            // Exibe o popup com as promoções ativas
            function displayPromotionsPopup() {
                promotionsListEl.innerHTML = ''; // Limpa lista anterior
                // Filtra promoções ativas e que têm um preço definido (ignora desconto geral aqui)
                const activePromotions = allPromotionsData.filter(promo => promo.active && promo.promoPrice !== null);

                if (activePromotions.length > 0) {
                    // Cria o HTML para cada promoção
                    activePromotions.forEach(promo => {
                        const promoDiv = document.createElement('div');
                        promoDiv.className = 'promotion-item'; // Estilo do item

                        // Tenta encontrar a imagem do item original associado à promoção
                        const promoImageUrl = promo.name === 'Desconto no Pedido' ? null : allMenuData.find(item => item.id === promo.itemId)?.imageUrl;
                        const isDiscountPromo = promo.name === 'Desconto no Pedido'; // Flag para desconto geral

                        // Monta o HTML do item da promoção
                        promoDiv.innerHTML = `
                            <h4>${promo.name}</h4>
                            <p>${promo.description}</p>
                            <span class="price">${isDiscountPromo ? `${promo.promoPrice}% de desconto` : `R$ ${promo.promoPrice.toFixed(2).replace('.', ',')}`}</span>
                            ${isDiscountPromo
                                ? `<button disabled class="px-3 py-1 bg-green-600 text-white rounded-full text-sm mt-2 opacity-50 cursor-not-allowed">Já Aplicado</button>` // Botão desabilitado para desconto geral
                                : `<button class="add-promo-to-order-btn px-3 py-1 bg-red-600 text-white rounded-full text-sm hover:bg-red-700 transition mt-2" data-promo-id="${promo.id}" data-image-url="${promoImageUrl || ''}">Adicionar ao Pedido</button>` // Botão para adicionar item promocional
                            }
                        `;
                        promotionsListEl.appendChild(promoDiv); // Adiciona à lista no popup
                    });
                    // Adiciona listeners aos botões "Adicionar" das promoções
                    document.querySelectorAll('.add-promo-to-order-btn').forEach(button => {
                        button.addEventListener('click', function() {
                            const promoId = this.dataset.promoId;
                            const promoImageUrl = this.dataset.imageUrl || null; // Pega URL da imagem
                            addPromotionToOrder(promoId, this, promoImageUrl); // Chama função para adicionar
                        });
                    });
                    promotionPopup.style.display = 'flex'; // Exibe o popup
                } else {
                    promotionPopup.style.display = 'none'; // Esconde se não houver promoções
                }
            }


            // Adiciona um item de promoção ao pedido
            function addPromotionToOrder(promoId, clickedButton = null, itemImageUrl = null) {
                const promotion = allPromotionsData.find(p => p.id === promoId); // Encontra a promoção
                if (promotion) {
                    // Adiciona ao pedido com tipo 'promotion'
                    order.push({
                        id: Date.now() + Math.random(), // ID único
                        type: 'promotion',
                        name: promotion.name,
                        price: promotion.promoPrice, // Preço promocional
                        description: promotion.description,
                        itemId: promotion.itemId // ID do item original (se houver)
                    });
                    updateOrderDisplay(); // Atualiza sidebar
                    updateCartCount(); // Atualiza contador
                    promotionPopup.style.display = 'none'; // Fecha popup
                    if (clickedButton) {
                        animateItemToCart(clickedButton, itemImageUrl); // Anima se houver botão de origem
                    }
                    showTemporaryFeedback(`Promoção "${promotion.name}" adicionada ao pedido!`, 'bg-green-500'); // Feedback
                } else {
                    showMessageModal('Erro ao adicionar promoção. Por favor, tente novamente.');
                }
            }


            // Controla a visibilidade do botão flutuante de promoções
            function updatePromotionButtonVisibility() {
                // Filtra promoções ativas com preço definido
                const activePromotionsWithPrice = allPromotionsData.filter(promo => promo.active && promo.promoPrice !== null);
                // Verifica se algum modal está aberto
                const isAnyModalOpen = document.querySelector('.modal[style*="display: flex"]') || document.querySelector('.message-modal[style*="display: flex"]');
                // Mostra o botão se: há promoções, a sidebar está fechada e nenhum modal está aberto
                if (activePromotionsWithPrice.length > 0 && !orderSidebar.classList.contains('translate-x-0') && !isAnyModalOpen) {
                    promotionButton.style.display = 'flex';
                } else {
                    promotionButton.style.display = 'none';
                }
            }


            // Atualiza o conteúdo do modal de sugestão de bebidas (considerando disponibilidade)
            function refreshDrinkSuggestionModal() {
                suggestedDrinksList.innerHTML = ''; // Limpa lista anterior

                // Filtra bebidas visíveis no cardápio
                const visibleDrinks = allMenuData.filter(item =>
                    item.category === 'bebidas' &&
                    itemVisibility[item.id] !== false // Verifica visibilidade do Firestore
                );

                if (visibleDrinks.length > 0) {
                    // Cria o HTML para cada bebida sugerida
                    visibleDrinks.forEach(drink => {
                        const isUnavailable = unavailableItems[drink.id] === false; // Verifica disponibilidade do Firestore

                        let buttonHtml;
                        let itemClasses = "suggested-drink-item";

                        // Define botão (Adicionar ou Esgotado)
                        if (isUnavailable) {
                            buttonHtml = `<button class="bg-gray-400 text-white px-3 py-1 rounded-md text-sm cursor-not-allowed" disabled>Esgotado</button>`;
                            itemClasses += " opacity-60"; // Adiciona opacidade se indisponível
                        } else {
                            buttonHtml = `<button class="add-suggested-drink-btn bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-md text-sm transition" data-item-id="${drink.id}">Adicionar</button>`;
                        }

                        // Monta o HTML do item de bebida
                        const drinkItemHtml = `
                            <div class="${itemClasses}">
                                <div>
                                    <span class="drink-name">${drink.name}</span>
                                    <span class="drink-price ml-2">R$ ${drink.basePrice.toFixed(2).replace('.', ',')}</span>
                                </div>
                                ${buttonHtml}
                            </div>
                        `;
                        suggestedDrinksList.insertAdjacentHTML('beforeend', drinkItemHtml); // Adiciona à lista no modal
                    });

                    // Adiciona listeners aos botões "Adicionar" das bebidas
                    document.querySelectorAll('.add-suggested-drink-btn').forEach(button => {
                        button.addEventListener('click', function() {
                            const itemId = this.dataset.itemId;
                            const item = allMenuData.find(i => i.id === itemId); // Encontra a bebida no cardápio
                            if (item) {
                                // Adiciona a bebida ao pedido
                                addToOrder({
                                    id: Date.now() + Math.random(), // ID único
                                    type: 'full',
                                    name: item.name,
                                    price: item.basePrice,
                                    description: item.description,
                                    category: item.category
                                }, this, null); // Passa null para imagem (sem animação específica aqui)
                                updateDrinkSuggestionButtons(); // Atualiza texto do botão principal do modal
                            }
                        });
                    });

                } else {
                    // Mensagem se não houver bebidas para sugerir
                    suggestedDrinksList.innerHTML = '<p class="text-gray-500">Nenhuma bebida disponível para sugestão no momento.</p>';
                }
                updateDrinkSuggestionButtons(); // Garante que o botão principal esteja correto
            }


            // Exibe o modal de sugestão de bebidas
            function displayDrinkSuggestionModal() {
                refreshDrinkSuggestionModal(); // Atualiza o conteúdo do modal
                drinkSuggestionModal.style.display = 'flex'; // Exibe o modal
                updatePromotionButtonVisibility(); // Esconde o botão de promoções
            }

            // Atualiza o texto do botão principal no modal de sugestão de bebidas
            function updateDrinkSuggestionButtons() {
                const hasDrinks = order.some(item => item.category === 'bebidas'); // Verifica se já há bebidas no pedido
                if (hasDrinks) {
                    // Se já tem bebida, o botão confirma e finaliza
                    proceedWithoutDrinksBtn.textContent = 'Finalizar com Bebidas';
                    proceedWithoutDrinksBtn.classList.remove('btn-order'); // Remove estilo padrão
                    proceedWithoutDrinksBtn.classList.add('bg-red-600', 'hover:bg-red-700', 'transition', 'duration-300'); // Adiciona estilo de confirmação
                } else {
                    // Se não tem bebida, o botão oferece finalizar sem
                    proceedWithoutDrinksBtn.textContent = 'Finalizar sem Bebidas';
                    proceedWithoutDrinksBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                    proceedWithoutDrinksBtn.classList.add('btn-order'); // Adiciona estilo padrão
                }
            }

            // CORREÇÃO: Função movida para antes de ser chamada
            // Calcula e exibe o valor do troco no modal de pagamento
            function calculateTrocoTotal() {
                const totalPedido = calculateOrderTotal();
                const trocoParaValue = parseFloat(trocoParaInput.value.replace(',', '.')) || 0; // Trata vírgula e valor vazio
                const trocoCalculado = (trocoParaValue > totalPedido) ? (trocoParaValue - totalPedido) : 0;
                trocoTotalDisplay.textContent = `R$ ${trocoCalculado.toFixed(2).replace('.', ',')}`;
                trocoTotalDisplay.classList.toggle('text-red-600', trocoParaValue > 0 && trocoParaValue < totalPedido); // Vermelho se insuficiente
                trocoTotalDisplay.classList.toggle('text-green-600', trocoCalculado > 0); // Verde se houver troco
            }

            // Abre o modal de seleção de forma de pagamento
            function openPaymentMethodModal(fromCheckout = false) {
                isCheckoutInitiated = fromCheckout; // Guarda se veio do botão Finalizar Pedido
                paymentMethodModal.style.display = 'flex'; // Exibe o modal
                updatePromotionButtonVisibility(); // Esconde botão de promoções

                // Calcula e exibe o total do pedido no modal
                const totalOrder = calculateOrderTotal();
                paymentModalTotal.textContent = `R$ ${totalOrder.toFixed(2).replace('.', ',')}`;

                // Reseta campos de troco e Pix
                trocoInputContainer.classList.add('hidden');
                trocoParaInput.value = '';
                trocoTotalDisplay.textContent = 'R$ 0,00';
                pixDetailsContainer.classList.add('hidden');
                const qrcodeContainer = document.getElementById('qrcode-container');
                qrcodeContainer.innerHTML = ''; // Limpa QR Code anterior

                // Marca a opção de pagamento previamente selecionada (se houver)
                if (selectedPaymentMethod) {
                    const methodValue = typeof selectedPaymentMethod === 'object' ? selectedPaymentMethod.method : selectedPaymentMethod;
                    const radio = document.querySelector(`input[name="paymentMethod"][value="${methodValue}"]`);
                    if (radio) {
                        radio.checked = true; // Marca o radio
                        document.querySelectorAll('.payment-option').forEach(opt => opt.classList.remove('selected')); // Desmarca outras visualmente
                        radio.closest('.payment-option').classList.add('selected'); // Marca a opção atual visualmente

                        // Mostra/preenche campo de troco se for Dinheiro
                        if (methodValue === 'Dinheiro') {
                            trocoInputContainer.classList.remove('hidden');
                            if (typeof selectedPaymentMethod === 'object' && selectedPaymentMethod.trocoPara) {
                                trocoParaInput.value = selectedPaymentMethod.trocoPara;
                                calculateTrocoTotal(); // Calcula e exibe o troco
                            }
                        }
                        // Gera QR Code e chave Pix se for Pix
                        if (methodValue === 'Pix' && contactInfo.chavepix) {
                            const totalAmount = calculateOrderTotal();
                            const payload = gerarPayload(contactInfo.chavepix, totalAmount, contactInfo.nome || 'Samia Pizzaria', contactInfo.cidade || 'Cidade', "pedido" + Date.now());
                            pixKeyDisplay.textContent = payload; // Mostra chave Copia e Cola
                            pixDetailsContainer.classList.remove('hidden'); // Mostra detalhes do Pix

                            // Gera QR Code
                            if (qrcodeContainer) { // Verifica se o container existe
                                new QRCode(qrcodeContainer, {
                                    text: payload, width: 110, height: 110,
                                    colorDark : "#000000", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.H
                                });
                            }

                        } else {
                            pixDetailsContainer.classList.add('hidden'); // Esconde detalhes do Pix se não for Pix
                        }
                    }
                } else {
                    // Se nenhum pagamento selecionado antes, desmarca todos
                    document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
                        radio.checked = false;
                        radio.closest('.payment-option').classList.remove('selected');
                    });
                }
            }


            // Fecha o modal de seleção de forma de pagamento
            function closePaymentMethodModal() {
                paymentMethodModal.style.display = 'none'; // Esconde o modal
                // Limpa o QR Code ao fechar para evitar exibir um antigo se reabrir
                const qrcodeContainer = document.getElementById('qrcode-container');
                if (qrcodeContainer) {
                    qrcodeContainer.innerHTML = '';
                }
                updatePromotionButtonVisibility(); // Atualiza botão promoções
            }


            // Copia a chave Pix para a área de transferência
            function copyPixKey() {
                const pixKeyText = pixKeyDisplay.textContent; // Pega o texto da chave

                // Tenta usar a API de Clipboard moderna (mais segura)
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(pixKeyText)
                    .then(() => {
                        // Mostra feedback de sucesso
                        const feedbackEl = document.getElementById('copy-feedback');
                        feedbackEl.classList.remove('hidden');
                        setTimeout(() => {
                            feedbackEl.classList.add('hidden');
                        }, 2000); // Esconde após 2 segundos
                    })
                    .catch(err => {
                        // Se falhar (ex: permissão negada), usa o método antigo
                        console.warn("Clipboard API falhou, usando fallback:", err);
                        fallbackCopyTextToClipboard(pixKeyText);
                    });
                } else {
                    // Usa o método antigo (document.execCommand) como fallback
                    console.warn("Clipboard API não suportada, usando fallback.");
                    fallbackCopyTextToClipboard(pixKeyText);
                }
            }

            // Fallback para copiar texto usando document.execCommand (menos seguro, mas funciona em mais lugares)
            function fallbackCopyTextToClipboard(text) {
                const tempInput = document.createElement('textarea'); // Cria textarea temporário
                tempInput.value = text; // Define o valor
                document.body.appendChild(tempInput); // Adiciona à página
                tempInput.select(); // Seleciona o texto
                try {
                    document.execCommand('copy'); // Tenta copiar
                    // Mostra feedback de sucesso
                    const feedbackEl = document.getElementById('copy-feedback');
                    feedbackEl.classList.remove('hidden');
                    setTimeout(() => {
                        feedbackEl.classList.add('hidden');
                    }, 2000);
                } catch (err) {
                    console.error('Fallback de cópia falhou:', err);
                    showMessageModal('Não foi possível copiar a chave Pix.'); // Informa falha
                }
                document.body.removeChild(tempInput); // Remove textarea temporário
            }


            // Obtém a altura do header fixo (barra de categorias no mobile)
            function getStickyHeaderHeight() {
                const stickyHeader = document.querySelector('.category-bar-mobile-sticky');
                return stickyHeader ? stickyHeader.offsetHeight : 60; // Retorna altura ou 60px como padrão
            }

            // Marca o botão da categoria correspondente como ativo visualmente
            function setActiveCategoryButton(category) {
                document.querySelectorAll('.category-btn').forEach(btn => {
                    if (btn.dataset.category === category) {
                        // Ativa o botão correto
                        btn.classList.add('bg-red-600', 'text-white');
                        btn.classList.remove('bg-gray-200', 'text-gray-800');
                        // Rola o botão para o centro da barra (útil no mobile)
                        btn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                    } else {
                        // Desativa outros botões
                        btn.classList.remove('bg-red-600', 'text-white');
                        btn.classList.add('bg-gray-200', 'text-gray-800');
                    }
                });
            }


            // Configura o Intersection Observer para detectar qual categoria está visível
            function setupCategoryObserver() {
                if (categoryObserver) {
                    categoryObserver.disconnect(); // Desconecta observer antigo se existir
                }

                const stickyHeaderHeight = getStickyHeaderHeight(); // Pega altura da barra fixa
                // Opções do observer: rootMargin define a "área de ativação"
                // (começa abaixo da barra fixa e termina um pouco antes do fim da tela)
                const options = {
                    root: null, // Observa em relação ao viewport
                    rootMargin: `-${stickyHeaderHeight}px 0px -${window.innerHeight - stickyHeaderHeight - 150}px 0px`,
                    threshold: 0 // Ativa assim que qualquer parte da seção entra na área
                };

                // Cria o observer
                categoryObserver = new IntersectionObserver((entries) => {
                    if (isScrollingFromClick) return; // Ignora se o scroll foi causado por clique no botão

                    // Itera sobre as seções que entraram/saíram da área de observação
                    entries.forEach(entry => {
                        const category = entry.target.dataset.category; // Pega a categoria da seção
                        const isPromotionalSection = category.toLowerCase() === 'promocionais';

                        if (entry.isIntersecting) { // Se a seção está visível na área definida
                            setActiveCategoryButton(category); // Ativa o botão correspondente
                        }

                        // Lógica específica para seleção de meia pizza (evita scroll indesejado)
                        if (isSelectingHalfPizza && entry.isIntersecting) {
                            if (isFirstHalfPromotional && !isPromotionalSection) { // Se 1ª é promo e seção atual não é
                                // Força scroll de volta para seção promo
                                document.getElementById('promocionais-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
                                showMessageModal("Para pizzas promocionais, a segunda metade deve ser também de uma pizza promocional.");
                            } else if (!isFirstHalfPromotional && isPromotionalSection) { // Se 1ª não é promo e seção atual é
                                // Força scroll de volta para a primeira seção de pizza (ou topo)
                                if (firstPizzaSectionId) {
                                    document.getElementById(firstPizzaSectionId).scrollIntoView({ behavior: 'smooth', block: 'start' });
                                } else {
                                    window.scrollTo({ top: 0, behavior: 'smooth' }); // Fallback para o topo
                                }
                                showMessageModal("Você começou a montar uma pizza meio a meio com um sabor não promocional. A segunda metade não pode ser de uma pizza promocional.");
                            }
                        }
                    });
                }, options);

                // Observa todas as seções de categoria
                document.querySelectorAll('.pizza-category-section').forEach(section => {
                    categoryObserver.observe(section);
                });
            }


            // Mostra o modal para preenchimento/edição do endereço e dados do cliente
            function showAddressInputModal(isPickup = false) {
                addressInputModal.style.display = 'flex'; // Exibe o modal
                updatePromotionButtonVisibility(); // Esconde botão de promoções

                // Mostra/Esconde campos de endereço com base no tipo (retirada ou delivery)
                if (isPickup) {
                    addressFieldsContainer.style.display = 'none';
                } else {
                    addressFieldsContainer.style.display = 'block';
                }

                // Preenche os campos com os dados já existentes (se houver)
                clientNameInput.value = selectedAddress.clientName || '';
                contactInput.value = selectedAddress.telefone || '';
                if (selectedAddress.bairro) {
                    neighborhoodSelect.value = selectedAddress.bairro; // Seleciona bairro no dropdown
                } else {
                    neighborhoodSelect.value = ""; // Reseta dropdown se não houver bairro salvo
                }
                streetInput.value = selectedAddress.rua || '';
                numberInput.value = selectedAddress.numero || '';
                noNumberCheckbox.checked = selectedAddress.numero === 'S/N'; // Marca checkbox "Sem Número"
                numberInput.disabled = noNumberCheckbox.checked; // Desabilita input de número se checkbox marcado
                referencePointInput.value = selectedAddress.referencia || '';
            }


            // Esconde o modal de endereço
            function hideAddressInputModal() {
                addressInputModal.style.display = 'none'; // Esconde o modal
                updatePromotionButtonVisibility(); // Atualiza visibilidade do botão de promoções
            }

            // Preenche o dropdown de bairros com base nas taxas de entrega carregadas
            function populateNeighborhoodDropdown(feesData) {
                neighborhoodSelect.innerHTML = '<option value="">Selecione um bairro</option>'; // Limpa e adiciona opção padrão
                if (!feesData || feesData.length === 0) {
                    return; // Sai se não houver dados de taxas
                }
                // Cria uma <option> para cada bairro com taxa definida
                feesData.forEach(fee => {
                    if (typeof fee.neighborhood === 'string' && fee.neighborhood.trim() !== '') { // Verifica se tem nome de bairro
                        const option = document.createElement('option');
                        option.value = fee.neighborhood; // Valor é o nome do bairro
                        option.textContent = `${fee.neighborhood} (R$ ${fee.deliveryFee.toFixed(2).replace('.', ',')})`; // Texto com nome e taxa
                        option.dataset.fee = fee.deliveryFee; // Guarda a taxa no dataset
                        neighborhoodSelect.appendChild(option); // Adiciona ao <select>
                    }
                });
            }


            // Exibe o resumo do endereço preenchido na sidebar do pedido
            function showAddressSummary() {
                if (selectedAddress.clientName) { // Se há pelo menos um nome
                    addressSummarySection.classList.remove('hidden'); // Mostra a seção de resumo
                    clientNameDisplay.textContent = `Nome do Cliente: ${selectedAddress.clientName}`; // Exibe nome

                    // Exibe contato se houver
                    if (selectedAddress.telefone) {
                        contactDisplay.textContent = `Contato: ${selectedAddress.telefone}`;
                        contactDisplay.classList.remove('hidden');
                    } else {
                        contactDisplay.classList.add('hidden'); // Esconde se não houver
                    }

                    // Exibe tipo de entrega (Retirada ou Endereço)
                    if (isPickupOrder) {
                        addressDisplay.textContent = 'Retirada no Balcão';
                        neighborhoodDisplay.textContent = ''; // Limpa bairro
                        referenceDisplay.textContent = ''; // Limpa referência
                    } else {
                        // Exibe endereço completo para delivery
                        addressDisplay.textContent = `Rua: ${selectedAddress.rua}, Nº ${selectedAddress.numero}`;
                        neighborhoodDisplay.textContent = `Bairro: ${selectedAddress.bairro}`;
                        referenceDisplay.textContent = selectedAddress.referencia ? `Ponto de Referência: ${selectedAddress.referencia}` : ''; // Exibe referência se houver
                    }
                } else {
                    hideAddressSummary(); // Esconde resumo se não houver nome
                }
            }


            // Esconde a seção de resumo do endereço na sidebar
            function hideAddressSummary() {
                addressSummarySection.classList.add('hidden'); // Adiciona classe 'hidden'
                // Limpa os textos dos elementos de exibição
                clientNameDisplay.textContent = '';
                contactDisplay.textContent = '';
                addressDisplay.textContent = '';
                neighborhoodDisplay.textContent = '';
                referenceDisplay.textContent = '';
            }

            // Atualiza a exibição do resumo do endereço (similar a showAddressSummary, mas chamada em mais pontos)
            function updateAddressDisplay() {
                if (selectedAddress.clientName) { // Se houver nome
                    addressSummarySection.classList.remove('hidden'); // Mostra seção
                    clientNameDisplay.textContent = `Nome do Cliente: ${selectedAddress.clientName}`; // Exibe nome

                    // Exibe contato se houver
                    if (selectedAddress.telefone) {
                        contactDisplay.textContent = `Contato: ${selectedAddress.telefone}`;
                        contactDisplay.classList.remove('hidden');
                    } else {
                        contactDisplay.classList.add('hidden');
                    }

                    // Exibe tipo de entrega ou endereço completo
                    if (isPickupOrder) {
                        addressDisplay.textContent = 'Retirada no Balcão';
                        neighborhoodDisplay.textContent = '';
                        referenceDisplay.textContent = '';
                    } else if (selectedAddress.bairro && selectedAddress.rua) { // Verifica se bairro e rua estão preenchidos para delivery
                        addressDisplay.textContent = `Rua: ${selectedAddress.rua}, Nº ${selectedAddress.numero}`;
                        neighborhoodDisplay.textContent = `Bairro: ${selectedAddress.bairro}`;
                        referenceDisplay.textContent = selectedAddress.referencia ? `Ponto de Referência: ${selectedAddress.referencia}` : '';
                    }
                } else {
                    addressSummarySection.classList.add('hidden'); // Esconde se não houver nome
                }
            }


            // Preenche as informações de contato e links sociais no rodapé da página
            function populateContactInfo(contacts) {
                const socialLinksEl = document.getElementById('social-links-container');
                socialLinksEl.innerHTML = ''; // Limpa links antigos

                // Converte array de contatos em objeto para fácil acesso
                const contactData = contacts.reduce((acc, current) => {
                    const key = current.data.toLowerCase().replace(/[^a-z0-9]/g, ''); // Cria chave (ex: 'telefone', 'instagram')
                    acc[key] = current.value; // Armazena valor
                    return acc;
                }, {});

                // Preenche elementos no rodapé
                if (contactData.telefone) footerPhone.textContent = contactData.telefone;
                if (contactData.email) footerEmail.textContent = contactData.email;
                // Adiciona links sociais (se existirem)
                if (contactData.instagram) socialLinksEl.insertAdjacentHTML('beforeend', `<a href="${contactData.instagram}" class="text-gray-400 hover:text-white" target="_blank"><i class="fab fa-instagram text-xl"></i></a>`);
                if (contactData.facebook) socialLinksEl.insertAdjacentHTML('beforeend', `<a href="${contactData.facebook}" class="text-gray-400 hover:text-white" target="_blank"><i class="fab fa-facebook text-xl"></i></a>`);
                if (contactData.whatsapp) socialLinksEl.insertAdjacentHTML('beforeend', `<a href="https://wa.me/55${contactData.whatsapp.replace(/\D/g, '')}" class="text-gray-400 hover:text-white" target="_blank"><i class="fab fa-whatsapp text-xl"></i></a>`);

                return contactData; // Retorna o objeto processado (usado em outras partes)
            }


            // Gera o payload (string) para o Pix Copia e Cola (BR Code)
            function gerarPayload(chave, valor, nome, cidade, txid) {
                // Função interna para formatar campos (ID + Tamanho + Valor)
                function formatValue(id, value) {
                    const cleanedValue = String(value); // Garante que é string
                    return id + String(cleanedValue.length).padStart(2, '0') + cleanedValue; // Concatena ID + Tamanho (2 dígitos) + Valor
                }

                // Campos obrigatórios e opcionais do BR Code
                const gui = formatValue("00", "BR.GOV.BCB.PIX"); // Payload Format Indicator
                const key = formatValue("01", chave); // Chave Pix
                const info = gui + key; // Informação da conta

                const merchantAccountInfo = formatValue("26", info); // Merchant Account Information
                const txidField = formatValue("05", txid); // Transaction ID (gerado dinamicamente)
                const additionalDataField = formatValue("62", txidField); // Additional Data Field Template

                const formattedValor = parseFloat(valor).toFixed(2); // Formata valor com 2 casas decimais

                // Concatena todos os campos formatados (exceto CRC16)
                const payloadSemCRC =
                    formatValue("00", "01") + // Payload Format Indicator (fixo '01')
                    merchantAccountInfo + // Informações da conta
                    formatValue("52", "0000") + // Merchant Category Code (fixo '0000')
                    formatValue("53", "986") + // Transaction Currency (fixo '986' para BRL)
                    formatValue("54", formattedValor) + // Transaction Amount
                    formatValue("58", "BR") + // Country Code (fixo 'BR')
                    formatValue("59", nome) + // Merchant Name
                    formatValue("60", cidade) + // Merchant City
                    additionalDataField + // Campo de dados adicionais com TXID
                    "6304"; // CRC16 ID (fixo '6304')

                // Retorna payload completo com CRC16 calculado
                return payloadSemCRC + crc16(payloadSemCRC);
            }

            // Calcula o CRC16 (verificação de integridade) para o payload Pix
            function crc16(str) {
                let crc = 0xFFFF; // Valor inicial
                // Itera sobre cada byte da string
                for (let i = 0; i < str.length; i++) {
                    crc ^= str.charCodeAt(i) << 8; // XOR com o byte deslocado
                    // Realiza 8 shifts e XORs
                    for (let j = 0; j < 8; j++) {
                        if (crc & 0x8000) { // Se o bit mais significativo for 1
                            crc = (crc << 1) ^ 0x1021; // Shift e XOR com polinômio
                        } else {
                            crc <<= 1; // Apenas shift
                        }
                        crc &= 0xFFFF; // Garante que o valor permaneça 16 bits
                    }
                }
                // Retorna CRC formatado como string hexadecimal de 4 dígitos
                return crc.toString(16).toUpperCase().padStart(4, '0');
            }


            // Função simplificada para gerar o Pix Copia e Cola
            function generatePixCopiaEColaPayload(amount, pixKey, merchantName, merchantCity) {
                // Valida entradas básicas
                if (!pixKey || !amount || isNaN(amount) || amount <= 0) {
                    return "Erro: Chave Pix inválida ou valor ausente.";
                }

                const txid = "pedido" + Date.now(); // Gera um TXID simples baseado no tempo
                // Chama a função principal de geração de payload
                return gerarPayload(pixKey, amount, merchantName, merchantCity, txid);
            }

            // Exibe o modal perguntando se o usuário deseja adicionar extras a um item
            function showAskForExtrasModal(orderItemId, item) {
                // Define o título do modal com o nome do item
                askExtrasTitle.textContent = `Turbine seu ${item.name}!`;
                // Guarda o ID do item no pedido (para saber qual item modificar depois)
                askPizzaExtrasModal.dataset.orderItemId = orderItemId;
                // Exibe o modal
                askPizzaExtrasModal.style.display = 'flex';
            }


            // Abre o modal para adicionar ou editar extras de uma pizza específica no pedido
            function openPizzaExtrasBuilderModal(orderIndex) {
                const pizzaItem = order[orderIndex]; // Pega o item do pedido pelo índice
                if (!pizzaItem) return; // Sai se o item não for encontrado

                // Define o título do modal
                pizzaExtrasBuilderTitle.textContent = "Adicionais para o seu Produto";
                // Guarda o índice do item no modal para referência posterior
                pizzaExtrasBuilderModal.dataset.orderIndex = orderIndex;

                const scopeButtonsContainer = document.getElementById('pizza-extras-scope-buttons');
                scopeButtonsContainer.innerHTML = ''; // Limpa botões de escopo antigos

                // Inicializa o estado dos extras para este modal (separado por escopo)
                currentPizzaExtrasState = { metade1: [], metade2: [], toda: [] };
                // Preenche o estado com os extras já existentes no item do pedido
                if (pizzaItem.extras && pizzaItem.extras.length > 0) {
                    pizzaItem.extras.forEach(extra => {
                        let placement = 'toda'; // Escopo padrão
                        if (extra.placement.includes('1ª Metade')) { placement = 'metade1'; }
                        else if (extra.placement.includes('2ª Metade')) { placement = 'metade2'; }

                        if (currentPizzaExtrasState[placement]) {
                            // Adiciona uma cópia do extra ao estado (para não modificar o original diretamente)
                            currentPizzaExtrasState[placement].push({ ...extra });
                        }
                    });
                }

                // Se for pizza meio a meio, cria botões de escopo (1ª Metade, 2ª Metade, Toda)
                if (pizzaItem.type === 'split') {
                    // Pega os nomes das metades (tratamento de erro básico se o nome não estiver formatado)
                    const nameParts = pizzaItem.name.split(' & Meia ');
                    const half1Name = nameParts[0]?.split(' Meia ')[1] || 'Metade 1';
                    const half2Name = nameParts[1] || 'Metade 2';

                    scopeButtonsContainer.innerHTML = `
                        <button class="scope-button px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-sm" data-scope="metade1">1ª Metade: ${half1Name}</button>
                        <button class="scope-button px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-sm" data-scope="metade2">2ª Metade: ${half2Name}</button>
                        <button class="scope-button px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-sm active" data-scope="toda">Pizza Toda</button>
                    `; // Botão "Toda" começa ativo

                    // Adiciona listeners aos botões de escopo para trocar a visualização dos extras
                    scopeButtonsContainer.querySelectorAll('.scope-button').forEach(btn => {
                        btn.addEventListener('click', () => {
                            scopeButtonsContainer.querySelector('.active').classList.remove('active'); // Desativa botão anterior
                            btn.classList.add('active'); // Ativa botão clicado
                            renderPizzaExtrasList(orderIndex); // Renderiza a lista de extras para o novo escopo
                        });
                    });
                } else {
                     // Para pizza inteira, apenas um botão "Pizza Toda" (implícito)
                     scopeButtonsContainer.innerHTML = `<button class="scope-button px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-sm active" data-scope="toda">Pizza Toda</button>`;
                     // Mesmo adicionando o listener, ele não terá efeito visualmente pois só há um botão
                     scopeButtonsContainer.querySelector('.scope-button').addEventListener('click', () => { renderPizzaExtrasList(orderIndex); });
                }

                renderPizzaExtrasList(orderIndex); // Renderiza a lista inicial de extras
                updatePizzaExtrasPrice(orderIndex); // Calcula o preço inicial
                pizzaExtrasBuilderModal.style.display = 'flex'; // Exibe o modal
            }


            // Renderiza a lista de extras disponíveis no modal, com base no escopo selecionado
            function renderPizzaExtrasList(orderIndex) {
                // Pega o escopo ativo (metade1, metade2 ou toda)
                const activeScopeButton = document.querySelector('#pizza-extras-scope-buttons .active');
                const activeScope = activeScopeButton ? activeScopeButton.dataset.scope : 'toda';
                pizzaExtrasIngredientsContainer.innerHTML = ''; // Limpa lista anterior

                // Itera sobre as categorias de extras de pizza
                for (const categoryName in allPizzaIngredients) {
                    const ingredients = allPizzaIngredients[categoryName];
                    // Filtra extras visíveis
                    const visibleIngredients = ingredients.filter(ing => extraVisibility[ing.id] !== false);

                    if (visibleIngredients.length > 0) { // Se houver extras visíveis na categoria
                        const categoryDiv = document.createElement('div');
                        categoryDiv.className = 'ingredient-category';

                        // Pega limite da categoria (se definido no primeiro item)
                        const firstIngredient = visibleIngredients[0] || {};
                        const categoryLimit = firstIngredient.categoryLimit || Infinity;
                        categoryDiv.dataset.limit = categoryLimit; // Guarda limite
                        categoryDiv.dataset.categoryName = categoryName; // Guarda nome

                        // Define título da categoria com limite (se houver)
                        let title = capitalizeFirstLetter(categoryName);
                        if (categoryLimit !== Infinity) {
                            title += ` (Escolha até ${categoryLimit})`;
                        }
                        categoryDiv.innerHTML = `<h4>${title}</h4>`; // Adiciona título

                        // Itera sobre os extras visíveis da categoria
                        visibleIngredients.forEach(ingredient => {
                            const isUnavailable = extraStatus[ingredient.id] === false; // Verifica disponibilidade
                            const priceDisplay = ingredient.price > 0 ? `+ R$ ${ingredient.price.toFixed(2).replace('.', ',')}` : ''; // Formata preço
                            const optionDiv = document.createElement('div');
                            optionDiv.className = `ingredient-option ${isUnavailable ? 'opacity-50 cursor-not-allowed' : ''}`; // Adiciona classe se indisponível

                            // Verifica se este extra já está selecionado no escopo atual e pega a quantidade
                            const existingExtra = currentPizzaExtrasState[activeScope]?.find(extra => extra.name === ingredient.name);
                            const quantity = existingExtra ? existingExtra.quantity : 0;
                            const ingredientLimit = ingredient.limit || 1; // Limite de quantidade para este extra específico

                            // Monta o HTML da opção de extra com botões de quantidade
                            optionDiv.innerHTML = `
                                 <div class="flex-grow">
                                    <span>${ingredient.name} ${isUnavailable ? '(Esgotado)' : ''}</span>
                                    <span class="price ml-2">${priceDisplay}</span>
                                </div>
                                <div class="flex items-center space-x-3" data-name="${ingredient.name}" data-price="${ingredient.price}" data-limit="${ingredientLimit}">
                                    <button type="button" class="quantity-btn minus-btn bg-gray-200 w-7 h-7 rounded-full flex items-center justify-center text-lg font-bold" ${isUnavailable ? 'disabled' : ''}>-</button>
                                    <span class="quantity-display font-bold text-lg w-4 text-center">${quantity}</span>
                                    <button type="button" class="quantity-btn plus-btn bg-gray-200 w-7 h-7 rounded-full flex items-center justify-center text-lg font-bold" ${isUnavailable ? 'disabled' : ''}>+</button>
                                </div>
                            `;
                            if (quantity > 0) optionDiv.classList.add('selected'); // Marca visualmente se selecionado

                            categoryDiv.appendChild(optionDiv); // Adiciona opção à categoria
                        });
                        pizzaExtrasIngredientsContainer.appendChild(categoryDiv); // Adiciona categoria ao modal
                    }
                }
            }

            // Lida com cliques nos botões +/- de quantidade no modal de extras de pizza
            function handleExtraQuantityChange(target, orderIndex) {
                const isPlus = target.classList.contains('plus-btn'); // Verifica se foi clique no '+'
                const container = target.closest('[data-name]'); // Container do extra
                const quantityDisplay = container.querySelector('.quantity-display'); // Span da quantidade
                let currentQuantity = parseInt(quantityDisplay.textContent); // Quantidade atual
                const ingredientLimit = parseInt(container.dataset.limit); // Limite individual do extra
                const categoryDiv = container.closest('.ingredient-category'); // Container da categoria
                const categoryLimit = parseInt(categoryDiv.dataset.limit); // Limite de variedades da categoria

                // Calcula quantas variedades já estão selecionadas na categoria
                let distinctItemsCount = 0;
                categoryDiv.querySelectorAll('.quantity-display').forEach(display => {
                    if (parseInt(display.textContent) > 0) {
                        distinctItemsCount++;
                    }
                });

                // Lógica para aumentar ou diminuir quantidade
                if (isPlus) {
                    // Verifica limite individual
                    if (currentQuantity >= ingredientLimit) {
                        showMessageModal(`O limite para este adicional é ${ingredientLimit}.`);
                        return;
                    }
                    // Verifica limite da categoria (apenas se estiver adicionando o primeiro item de uma variedade)
                    if (currentQuantity === 0 && distinctItemsCount >= categoryLimit) {
                        showMessageModal(`Você pode escolher no máximo ${categoryLimit} variedades nesta categoria.`);
                        return;
                    }
                    currentQuantity++; // Aumenta quantidade
                } else { // Botão '-'
                    if (currentQuantity > 0) {
                        currentQuantity--; // Diminui quantidade
                    }
                }
                quantityDisplay.textContent = currentQuantity; // Atualiza exibição da quantidade

                // Pega o escopo ativo (metade1, metade2, toda)
                const activeScopeButton = document.querySelector('#pizza-extras-scope-buttons .active');
                const activeScope = activeScopeButton ? activeScopeButton.dataset.scope : 'toda';

                // Define o texto do 'placement' (localização do extra)
                let placementText = 'Toda';
                if (activeScope === 'metade1') placementText = '1ª Metade';
                if (activeScope === 'metade2') placementText = '2ª Metade';

                // Pega nome e preço do extra
                const ingredientName = container.dataset.name;
                const ingredientPrice = parseFloat(container.dataset.price);

                // Encontra o índice do extra no estado atual para o escopo ativo
                const existingExtraIndex = currentPizzaExtrasState[activeScope].findIndex(ex => ex.name === ingredientName);

                // Atualiza o estado 'currentPizzaExtrasState'
                if (currentQuantity > 0) { // Se quantidade > 0, adiciona ou atualiza
                    if (existingExtraIndex > -1) { // Se já existe, atualiza quantidade
                        currentPizzaExtrasState[activeScope][existingExtraIndex].quantity = currentQuantity;
                    } else { // Se não existe, adiciona novo objeto
                        currentPizzaExtrasState[activeScope].push({
                            name: ingredientName,
                            price: ingredientPrice,
                            placement: placementText,
                            quantity: currentQuantity
                        });
                    }
                    container.closest('.ingredient-option').classList.add('selected'); // Marca visualmente
                } else { // Se quantidade é 0, remove do estado
                    if (existingExtraIndex > -1) {
                        currentPizzaExtrasState[activeScope].splice(existingExtraIndex, 1); // Remove
                    }
                    container.closest('.ingredient-option').classList.remove('selected'); // Desmarca visualmente
                }

                updatePizzaExtrasPrice(orderIndex); // Recalcula e atualiza o preço total da pizza
            }


            // Atualiza o preço total exibido no modal de extras de pizza
            function updatePizzaExtrasPrice(orderIndex) {
                const pizzaItem = order[orderIndex]; // Pega o item do pedido

                // Calcula o preço base da pizza (preço atual - preço dos extras já existentes)
                let basePrice = pizzaItem.price;
                if (pizzaItem.extras && pizzaItem.extras.length > 0) {
                    pizzaItem.extras.forEach(extra => {
                        basePrice -= (extra.price * extra.quantity);
                    });
                }

                // Calcula o preço total dos extras selecionados AGORA no modal (em todos os escopos)
                let totalExtrasPrice = 0;
                for (const scope in currentPizzaExtrasState) {
                    currentPizzaExtrasState[scope].forEach(extra => {
                        totalExtrasPrice += (extra.price * extra.quantity);
                    });
                }

                // Exibe o preço final (base + novos extras)
                pizzaExtrasTotalPrice.textContent = `R$ ${(basePrice + totalExtrasPrice).toFixed(2).replace('.', ',')}`;
            }


            // Confirma os extras selecionados e atualiza o item no pedido
            function confirmPizzaExtras() {
                const orderIndex = parseInt(pizzaExtrasBuilderModal.dataset.orderIndex); // Pega índice do item
                if (isNaN(orderIndex)) return; // Sai se inválido

                const pizzaItem = order[orderIndex]; // Pega o item do pedido

                // Calcula o preço base da pizza (removendo extras antigos)
                let basePrice = pizzaItem.price;
                 if (pizzaItem.extras && pizzaItem.extras.length > 0) {
                    pizzaItem.extras.forEach(extra => { basePrice -= (extra.price * extra.quantity); });
                }

                // Monta a lista final de extras e calcula o preço total deles
                const finalExtras = [];
                let finalExtrasPrice = 0;
                // Itera sobre os escopos (metade1, metade2, toda) no estado atual do modal
                for (const scope in currentPizzaExtrasState) {
                    currentPizzaExtrasState[scope].forEach(extra => {
                        if(extra.quantity > 0) { // Apenas adiciona se quantidade > 0
                            finalExtras.push(extra); // Adiciona à lista final
                            finalExtrasPrice += (extra.price * extra.quantity); // Soma ao preço final dos extras
                        }
                    });
                }

                // Atualiza o item no pedido com os novos extras e o novo preço total
                pizzaItem.extras = finalExtras;
                pizzaItem.price = basePrice + finalExtrasPrice;

                updateOrderDisplay(); // Atualiza a exibição da sidebar
                pizzaExtrasBuilderModal.style.display = 'none'; // Fecha o modal
            }


            // --- INICIALIZAÇÃO E EVENT LISTENERS ---
            loadMenuAndRender(); // Inicia o carregamento do menu

            // Adiciona listeners para os botões e interações principais
            cartButton.addEventListener('click', toggleOrderSidebar);
            closeSidebarBtn.addEventListener('click', closeOrderSidebar);
            backToMenuBtn.addEventListener('click', backToMenu);
            checkoutButton.addEventListener('click', handleCheckoutFlow);
            pickupCheckbox.addEventListener('change', () => {
                isPickupOrder = pickupCheckbox.checked;
                if (isPickupOrder) {
                    selectedAddress = { clientName: selectedAddress.clientName, telefone: selectedAddress.telefone, bairro: "Retirada", rua: "Retirada no Balcão", numero: "S/N", referencia: "", deliveryFee: 0 };
                } else {
                    selectedAddress.bairro = null; selectedAddress.rua = null; selectedAddress.numero = null; selectedAddress.referencia = null; selectedAddress.deliveryFee = 0;
                }
                updateOrderDisplay();
            });
            burgerIngredientsContainer.addEventListener('click', (e) => {
                const target = e.target;
                const optionLabel = target.closest('.ingredient-option');
                if (target.classList.contains('quantity-btn')) {
                    // Lógica para botões +/- no montador de hambúrguer
                    const isPlus = target.classList.contains('plus-btn');
                    const container = target.closest('[data-ingredient-id]');
                    const quantityDisplay = container.querySelector('.quantity-display');
                    let currentQuantity = parseInt(quantityDisplay.textContent);
                    const ingredientLimit = parseInt(container.dataset.limit);
                    const categoryDiv = container.closest('.ingredient-category');
                    const categoryLimit = parseInt(categoryDiv.dataset.limit);
                    let distinctItemsCount = 0;
                    categoryDiv.querySelectorAll('.quantity-display').forEach(d => { if (parseInt(d.textContent) > 0) distinctItemsCount++; });
                    categoryDiv.querySelectorAll('input:checked').forEach(() => distinctItemsCount++);

                    if (isPlus) {
                        if (currentQuantity < ingredientLimit) {
                            if (currentQuantity === 0 && distinctItemsCount >= categoryLimit) {
                                showMessageModal(`Você pode escolher no máximo ${categoryLimit} variedades nesta categoria.`);
                            } else { currentQuantity++; }
                        }
                    } else if (currentQuantity > 0) { currentQuantity--; }
                    quantityDisplay.textContent = currentQuantity;
                    container.closest('.ingredient-option').classList.toggle('selected', currentQuantity > 0);
                    updateBurgerPrice();
                }
            });
            orderItemsContainer.addEventListener('click', function(event) {
                // Listeners para botões dentro dos itens do pedido na sidebar
                const removeButton = event.target.closest('.remove-item-btn');
                const editExtrasBtn = event.target.closest('.edit-extras-btn');
                const editBurgerBtn = event.target.closest('.edit-burger-btn');
                if (removeButton) { removeItem(parseInt(removeButton.dataset.index, 10)); } // Remover item
                if (editExtrasBtn) { openPizzaExtrasBuilderModal(parseInt(editExtrasBtn.dataset.orderIndex, 10)); } // Editar extras
                if (editBurgerBtn) { // Editar hambúrguer
                    const orderIndex = parseInt(editBurgerBtn.dataset.orderIndex, 10);
                    const itemToEdit = order[orderIndex];
                    if (itemToEdit && itemToEdit.originalItem) { openBurgerBuilderModal(itemToEdit.originalItem, orderIndex, itemToEdit); }
                }
            });
            closePizzaOptionModalBtn.addEventListener('click', function() { pizzaOptionModal.style.display = 'none'; updatePromotionButtonVisibility(); resetHalfPizzaSelection(); });
// Listener GLOBAL para fechar modais clicando fora
            window.addEventListener('click', function(event) {
                if (event.target == pizzaOptionModal) { pizzaOptionModal.style.display = 'none'; updatePromotionButtonVisibility(); resetHalfPizzaSelection(); }
                if (event.target == burgerBuilderModal) { burgerBuilderModal.style.display = 'none'; updatePromotionButtonVisibility(); }
                if (event.target == promotionPopup) { promotionPopup.style.display = 'none'; updatePromotionButtonVisibility(); }
                if (event.target == confirmNoDrinkModal) { confirmNoDrinkModal.style.display = 'none'; updatePromotionButtonVisibility(); drinkSuggestionModal.style.display = 'flex'; }
                if (event.target == addressInputModal) { hideAddressInputModal(); }
                if (event.target == askPizzaExtrasModal) { askPizzaExtrasModal.style.display = 'none'; }
                if (event.target == pizzaExtrasBuilderModal) { pizzaExtrasBuilderModal.style.display = 'none'; }
                if (event.target == messageModal) { hideMessageModal(); }
                if (event.target == drinkSuggestionModal) { drinkSuggestionModal.style.display = 'none'; updatePromotionButtonVisibility(); }
                if (event.target == installPromptModal) { installPromptModal.style.display = 'none'; }
                if (event.target == paymentMethodModal) { closePaymentMethodModal(); }

                // Condição para fechar o modal de duplicidade clicando fora
                const duplicateModal = document.getElementById('duplicate-confirm-modal');
                if (event.target == duplicateModal) {
                    duplicateModal.style.display = 'none';
                    checkoutButton.disabled = false; // Usa a variável global correta
                    updateCheckoutButtonText();
                }

            }); // Fim do window.addEventListener ('click') para fechar modais

            closeBurgerBuilderModalBtn.addEventListener('click', () => { burgerBuilderModal.style.display = 'none'; updatePromotionButtonVisibility(); });
            closePromotionPopupBtn.addEventListener('click', function() { promotionPopup.style.display = 'none'; updatePromotionButtonVisibility(); });
            closePromotionPopupBtnBottom.addEventListener('click', function() { promotionPopup.style.display = 'none'; updatePromotionButtonVisibility(); });
            promotionButton.addEventListener('click', function() { displayPromotionsPopup(); });
            closeDrinkSuggestionModalBtn.addEventListener('click', function() { drinkSuggestionModal.style.display = 'none'; updatePromotionButtonVisibility(); });

            // CORRIGIDO: Chama proceedToWhatsappCheckout() se o pagamento já estiver definido
            proceedWithoutDrinksBtn.addEventListener('click', function() {
                drinkSuggestionModal.style.display = 'none';
                if (!selectedPaymentMethod) {
                    isCheckoutInitiated = true; openPaymentMethodModal(true);
                } else {
                    proceedToWhatsappCheckout(); // Chama a função para finalizar
                }
            });

            closeConfirmNoDrinkModalBtn.addEventListener('click', function() { confirmNoDrinkModal.style.display = 'none'; updatePromotionButtonVisibility(); drinkSuggestionModal.style.display = 'flex'; });
            confirmNoDrinkNoBtn.addEventListener('click', function() { confirmNoDrinkModal.style.display = 'none'; updatePromotionButtonVisibility(); drinkSuggestionModal.style.display = 'flex'; });

            closePaymentMethodModalBtn.addEventListener('click', closePaymentMethodModal);
            paymentOptionsContainer.addEventListener('click', (event) => {
                const selectedLabel = event.target.closest('.payment-option');
                if (selectedLabel) {
                    // Atualiza a seleção visual
                    document.querySelectorAll('.payment-option').forEach(opt => opt.classList.remove('selected'));
                    selectedLabel.classList.add('selected');
                    // Mostra/esconde input de troco
                    const isCash = selectedLabel.dataset.method === 'Dinheiro';
                    trocoInputContainer.classList.toggle('hidden', !isCash);
                    if (!isCash) {
                        trocoParaInput.value = ''; // Limpa troco se não for dinheiro
                        trocoTotalDisplay.textContent = 'R$ 0,00';
                    } else {
                        calculateTrocoTotal(); // Calcula troco se for dinheiro
                    }
                    // Mostra/esconde detalhes do Pix
                     const isPix = selectedLabel.dataset.method === 'Pix';
                    pixDetailsContainer.classList.toggle('hidden', !isPix);
                    if (isPix && contactInfo.chavepix) {
                        const totalAmount = calculateOrderTotal();
                        const payload = gerarPayload(contactInfo.chavepix, totalAmount, contactInfo.nome || 'Samia Pizzaria', contactInfo.cidade || 'Cidade', "pedido"+Date.now());
                        pixKeyDisplay.textContent = payload;
                        const qrcodeContainer = document.getElementById('qrcode-container');
                        qrcodeContainer.innerHTML = '';
                         if (qrcodeContainer) { // Verifica se existe
                            new QRCode(qrcodeContainer, {
                                text: payload, width: 110, height: 110,
                                colorDark : "#000000", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.H
                            });
                        }
                    } else if (isPix && !contactInfo.chavepix) {
                        pixKeyDisplay.textContent = 'Chave Pix não configurada.';
                         document.getElementById('qrcode-container').innerHTML = '';
                    } else {
                        document.getElementById('qrcode-container').innerHTML = '';
                    }
                }
            });

            // CORREÇÃO: Adiciona listener para input de troco
            trocoParaInput.addEventListener('input', calculateTrocoTotal); // Calcula troco ao digitar
            copyPixBtn.addEventListener('click', (e) => { e.stopPropagation(); copyPixKey(); });
            pixKeyContainer.addEventListener('click', copyPixKey);

            // CORRIGIDO: Chama proceedToWhatsappCheckout() se o checkout foi iniciado
            confirmPaymentMethodBtn.addEventListener('click', () => { // Confirma pagamento
                const selectedRadio = document.querySelector('input[name="paymentMethod"]:checked');
                if (selectedRadio) {
                    if (selectedRadio.value === 'Dinheiro') {
                        const totalOrder = calculateOrderTotal(); const trocoParaValue = parseFloat(trocoParaInput.value);
                        if (isNaN(trocoParaValue) || (trocoParaValue > 0 && trocoParaValue < totalOrder)) { showMessageModal(`O valor para troco não pode ser menor que o total do pedido (R$ ${totalOrder.toFixed(2).replace('.', ',')}).`); return; }
                        const trocoCalculado = trocoParaValue > totalOrder ? trocoParaValue - totalOrder : 0;
                        selectedPaymentMethod = { method: 'Dinheiro', trocoPara: trocoParaValue, trocoTotal: trocoCalculado };
                    } else { selectedPaymentMethod = selectedRadio.value; }
                    closePaymentMethodModal();
                    if (isCheckoutInitiated) {
                        proceedToWhatsappCheckout(); // Chama a função para finalizar
                    }
                    isCheckoutInitiated = false;
                    updateOrderDisplay();
                } else { showMessageModal('Por favor, selecione uma forma de pagamento.'); }
            });

            closeAddressModalBtn.addEventListener('click', hideAddressInputModal);
            noNumberCheckbox.addEventListener('change', function() { numberInput.disabled = this.checked; if (this.checked) numberInput.value = ''; });
            confirmAddressBtn.addEventListener('click', function() { // Confirma endereço
                const clientName = clientNameInput.value.trim();
                const contact = contactInput.value.trim();
                const neighborhood = neighborhoodSelect.value;
                const street = streetInput.value.trim();
                const number = noNumberCheckbox.checked ? 'S/N' : numberInput.value.trim();
                const reference = referencePointInput.value.trim();

                let validationError = null;
                 if (!clientName) validationError = 'Por favor, informe o seu nome.';
                else if (!contact) validationError = 'Por favor, informe um telefone para contato.';
                 else if (!isPickupOrder) { // Validação de endereço apenas para delivery
                    if (!neighborhood) validationError = 'Por favor, selecione o seu bairro.';
                    else if (!street) validationError = 'Por favor, informe a sua rua.';
                    else if (!number) validationError = 'Por favor, informe o número da sua casa ou marque "Sem Número".';
                }

                 if (validationError) { showMessageModal(validationError); return; }

                // Atualiza o estado selectedAddress
                selectedAddress.clientName = clientName;
                selectedAddress.telefone = contact;
                 if (!isPickupOrder) {
                    selectedAddress.bairro = neighborhood;
                    selectedAddress.rua = street;
                    selectedAddress.numero = number;
                    selectedAddress.referencia = reference;
                    const selectedOption = neighborhoodSelect.options[neighborhoodSelect.selectedIndex];
                    selectedAddress.deliveryFee = parseFloat(selectedOption.dataset.fee) || 0;
                } else {
                    selectedAddress.bairro = "Retirada";
                    selectedAddress.rua = "Retirada no Balcão";
                    selectedAddress.numero = "S/N";
                    selectedAddress.referencia = "";
                    selectedAddress.deliveryFee = 0;
                }

                hideAddressInputModal(); // Fecha modal
                updateOrderDisplay(); // Atualiza sidebar com taxa e totais
                showAddressSummary(); // Mostra resumo do endereço
                 if (isCheckoutInitiated && !selectedPaymentMethod) { // Se veio do checkout e falta pagamento
                    openPaymentMethodModal(true); // Abre modal de pagamento
                } else if (isCheckoutInitiated) {
                     proceedToWhatsappCheckout(); // Finaliza se pagamento já estava ok
                }
            });
            editAddressBtn.addEventListener('click', function() { showAddressInputModal(isPickupOrder); });
            informAddressBtn.addEventListener('click', function() { showAddressInputModal(false); });
            editDeliveryAddressBtn.addEventListener('click', function() { showAddressInputModal(false); });
            askExtrasYesBtn.addEventListener('click', () => {
                 const orderItemId = askPizzaExtrasModal.dataset.orderItemId;
                 const orderIndex = order.findIndex(item => item.id === orderItemId);
                 if (orderIndex > -1) { openPizzaExtrasBuilderModal(orderIndex); }
                 askPizzaExtrasModal.style.display = 'none';
            });
            askExtrasNoBtn.addEventListener('click', () => { askPizzaExtrasModal.style.display = 'none'; });
            closePizzaExtrasBuilderModalBtn.addEventListener('click', () => { pizzaExtrasBuilderModal.style.display = 'none'; });
            pizzaExtrasIngredientsContainer.addEventListener('click', (e) => {
                const target = e.target;
                if (target.classList.contains('quantity-btn')) {
                    const orderIndex = parseInt(pizzaExtrasBuilderModal.dataset.orderIndex);
                    handleExtraQuantityChange(target, orderIndex);
                }
            });
            addPizzaWithExtrasBtn.addEventListener('click', confirmPizzaExtras);

            // --- LÓGICA DO PWA ---
             if ('serviceWorker' in navigator) {
                 window.addEventListener('load', () => {
                     navigator.serviceWorker.register('/service-worker.js')
                         .then(registration => console.log('Service Worker registrado com sucesso:', registration.scope))
                         .catch(error => console.error('Falha ao registrar Service Worker:', error));
                 });
             }
            window.addEventListener('beforeinstallprompt', (e) => {
                 e.preventDefault(); deferredPrompt = e;
                 if (!isPwaInstalled()) {
                     // Opção 1: Mostrar um botão/banner sutil na interface
                     // Opção 2: Mostrar o modal imediatamente (menos recomendado UX)
                     // showInstallPromptModal(); // Descomente para mostrar o modal
                 }
            });
            installAppButton.addEventListener('click', () => {
                 installPromptModal.style.display = 'none';
                 if (deferredPrompt) { deferredPrompt.prompt(); deferredPrompt.userChoice.then((choiceResult) => { deferredPrompt = null; }); }
            });
            closeInstallPromptModalBtn.addEventListener('click', () => { installPromptModal.style.display = 'none'; });
            window.addEventListener('appinstalled', () => { console.log('PWA instalado'); });

            // Esconde botões flutuantes ao rolar até o final da página
            window.addEventListener('scroll', () => {
                const isNearBottom = (window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 50);
                cartButton.style.display = isNearBottom ? 'none' : 'flex';
                updatePromotionButtonVisibility(); // Usa a função existente que já considera modais
            });

             // CORRIGIDO: Verifica se a função existe e a chama corretamente
             confirmNoDrinkYesBtn.addEventListener('click', function() {
                 confirmNoDrinkModal.style.display = 'none';
                 if (selectedPaymentMethod) {
                     // Verifica se a função existe antes de chamar
                     if (typeof proceedToWhatsappCheckout === 'function') { // Corrigido typeof
                         proceedToWhatsappCheckout(); // Chama a função correta
                     } else {
                         console.error("Erro CRÍTICO: Função proceedToWhatsappCheckout não está definida neste escopo.");
                         showMessageModal("Ocorreu um erro interno (Cód: PWC_UNDEF). Tente finalizar novamente.");
                     }
                 } else {
                     isCheckoutInitiated = true;
                     openPaymentMethodModal(true);
                 }
             });


        }); // FIM DO DOMContentLoaded
    </script>
</body>
</html>
